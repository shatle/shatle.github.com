<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: sqlalchemy migrate | Liu.Shatle]]></title>
  <link href="http://shatle.github.io/blog/categories/sqlalchemy-migrate/atom.xml" rel="self"/>
  <link href="http://shatle.github.io/"/>
  <updated>2025-11-29T11:02:43+08:00</updated>
  <id>http://shatle.github.io/</id>
  <author>
    <name><![CDATA[liu.shatle &hearts; gmail.com]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Use sqlalchemy-migrate]]></title>
    <link href="http://shatle.github.io/blog/2022/07/30/use-sqlalchemy-migrate/"/>
    <updated>2022-07-30T14:14:54+08:00</updated>
    <id>http://shatle.github.io/blog/2022/07/30/use-sqlalchemy-migrate</id>
    <content type="html"><![CDATA[<p>记录一下使用 sqlalchemy-migrate 的问题。</p>

<p>官网： https://sqlalchemy-migrate.readthedocs.io/en/latest/download.html</p>

<h2>说明</h2>

<p>在寻找 python 层面，类 rails migration 的工具，发现了 sqlalchemy-migrate。
大致看着还可以，尝试使用中。</p>

<h2>下载</h2>

<pre><code>pip install sqlalchemy-migrate
</code></pre>

<p>安装成功后，应该可以运行</p>

<pre><code>migrate help
</code></pre>

<p>可以查看 migrate 脚本支持的功能命令。</p>

<h2>使用</h2>

<p>根据官网说明，手动尝试运行，但遇到了些问题。</p>

<h4>创建迁移项目目录</h4>

<pre><code>migrate create migration "Example project"
</code></pre>

<p>此命令会创建一个迁移项目的文件夹 migration，里面包含有 versions 目录、manage.py、manage.cfg 文件。</p>

<h4>构建数据库的基本结构</h4>

<p>官网上，有</p>

<pre><code>$ python migration/manage.py version_control mysql+mysqldb://root:@localhost/activity?charset=utf8mb4 migration
</code></pre>

<p>官网上说，这命令会在相应的数据库中增加版本控制的表 migrate_version。但在我的机器中，会出现错误</p>

<pre><code>Traceback (most recent call last):
  File "migration/manage.py", line 2, in &lt;module&gt;
    from migrate.versioning.shell import main
ModuleNotFoundError: No module named 'migrate'
</code></pre>

<p>查阅文件 migration/manage.py 文件，</p>

<pre><code>#!/usr/bin/env python
from migrate.versioning.shell import main

if __name__ == '__main__':
    main(debug='False')
</code></pre>

<p>报错没有正常找到 migrate 包，折腾了许久，没有找到有效的解决方案。
但本质上，migration/manage.py 文件也是使用 migrate 命令去实现迁移操作的，
所以，尝试手动使用 migrate 命令去实现数据迁移。</p>

<pre><code>migrate version_control mysql+mysqldb://root:@localhost/activity?charset=utf8mb4 migration
</code></pre>

<p>运行上面的命令之后，查看数据库，会发现有数据表 migrate_version。</p>

<p>查看当前版本</p>

<pre><code>migrate db_version mysql+pymysql://root:@localhost/activity?charset=utf8mb4 migration
# 0
</code></pre>

<h4>创建迁移脚本</h4>

<p>创建迁移脚本使用 <code>script</code> 命令实现</p>

<pre><code>migrate script "add init tables" migration
</code></pre>

<p>命令会生成文件 <code>migration/xxx_add_init_tables.py</code> 文件，<code>xxx</code> 可以是 001 增序编号，也可以是日期时间。</p>

<p>查阅文件，有</p>

<pre><code class="python">from sqlalchemy import *
from migrate import *


def upgrade(migrate_engine):
    # Upgrade operations go here. Don't create your own engine; bind
    # migrate_engine to your metadata
    pass


def downgrade(migrate_engine):
    # Operations to reverse the above upgrade go here.
    pass
</code></pre>

<blockquote><p>遇到问题：使用timestamp做为文件名前缀时，migrate包的部分版本处理有错误，建议使用普通数字。</p></blockquote>

<p>增加一个 users 表， 有代码</p>

<pre><code class="python">from sqlalchemy import *
from migrate import *

meta = MetaData()
account = Table(
    'account', meta,
    Column('id', Integer, primary_key=True),
    Column('login', String(40)),
    Column('passwd', String(40)),
)

def upgrade(migrate_engine):
    meta.bind = migrate_engine
    account.create()


def downgrade(migrate_engine):
    meta.bind = migrate_engine
    account.drop()
</code></pre>

<p>例子中，利用 sqlalchemy  构建表，并分别定义了 upgrade 、downgrade 方法。方法中，分别对 account 表进行了创建或删除。</p>

<p>代码中定义了表，需要将表落实到数据库中，运行命令</p>

<pre><code>migrate upgrade mysql+pymysql://root:@localhost/activity?charset=utf8mb4 migration
</code></pre>

<p>命令会直接在数据库创建相应的表。</p>

<p>想删除表，可以执行</p>

<pre><code>migrate downgrade mysql+pymysql://root:@localhost/activity?charset=utf8mb4 migration 0
</code></pre>

<p><code>0</code> 表示要回滚到的版本。</p>
]]></content>
  </entry>
  
</feed>
