
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Liu.Shatle</title>
	<meta name="author" content="liu.shatle &hearts; gmail.com">

	
	<meta name="description" content="Usage of Mapbox mapbox 2019-02-15 Comments 朋友需要帮忙，使用地图进行数据的展示。网上，不少人使用 mapbox，看了些示例与文档，手动折腾了一下，确实是强大。 下面将折腾的过程记录下来。 先说一下需求： &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="" rel="alternate" title="Liu.Shatle" type="application/atom+xml">
	
	<link rel="canonical" href="http://shatle.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<img src="https://avatars1.githubusercontent.com/u/1129872?v=3&s=460" alt="Profile Picture" style="width: 160px;" />
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/author">Author</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
		
			<a class="github" href="https://github.com/shatle" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2019/02/15/usage-of-mapbox/" itemprop="url">Usage of Mapbox</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/mapbox/'>mapbox</a>


</div>
		<div class="date">







  


<time datetime="2019-02-15T00:00:00+08:00" data-updated="true" itemprop="datePublished">2019-02-15</time></div>

		
			<span class="comments"><a href="/blog/2019/02/15/usage-of-mapbox/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>朋友需要帮忙，使用地图进行数据的展示。网上，不少人使用 mapbox，看了些示例与文档，手动折腾了一下，确实是强大。</p>

<p>下面将折腾的过程记录下来。</p>

<p>先说一下需求：朋友需要对某个城市的路线中的一些路线进行颜色的特殊标识，比如，广州有很多道路，需要将有包含人名的道路标识出来。另外，人名分男女，用不同颜色进行区分显示。</p>

<p>地图信息，本质是不同图层的叠加，比如地形图、卫星图、道路图等，需要显示哪些图层，勾选就可以，也可以同时显示多个图层，它们会叠加，类似ps。</p>

<p>那么，要实现需求，需要完整的广州道路图、标识的道路图。</p>

<ul>
<li>第一步，我们需要现有的广州道路的地图，一个底图。</li>
</ul>


<p>翻阅了官网，发现一个浅色系的地图 <code>mapbox://styles/mapbox/light-v9</code>，这个地图适合当背景，这样标识的道路图可以选择较亮眼的颜色。</p>

<ul>
<li>第二步，需要有标识人名道路的图层。</li>
</ul>


<p>怎么拥有这个图层呢？首先，需要理解，图层的本质是道路的数据，只要有道路的数据就可以了。</p>

<p>那么怎么有需要标识的道路数据呢？如果别人整理过，可以直接拿geo的坐标数据集。但是，一般人不会刚好想到你的需求，刚好整理了出来，刚好分享到网络上。</p>

<p>由于是自己选择的道路，所以数据需要自己整理，Mapbox 这点就很好了。地图道路的数据实际上是一系列的坐标点，Mapbox 允许你直接在地图在通过画线，来得到这些数据。也就是，可以通过直观的操作，得到geo的数值数据。</p>

<p>mapbox 有 dataset 和 tileset 的概念， dataset 就是数据集，tileset贴图集。dataset 就是用来存储标志的路线坐标数据的， 如果直接使用数值数据渲染，可以足够了。</p>

<p>在 mapbox 需要通过网络使用 dataset，需要生成相应的 tileset 才能使用。在 https://studio.mapbox.com/datasets 在查看自己的 dataset，在 https://studio.mapbox.com/tilesets 在查看自己的 tileset。</p>

<hr />

<p>那么，先看看直接使用数值数据的例子。在这个例子中，需要将 dataset 中的坐标值，手动复制到相应的代码块中，效果见 <a href="/mapbox/index.html">index.html</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&#39;utf-8&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>Display a map<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&#39;viewport&#39;</span> <span class="na">content=</span><span class="s">&#39;initial-scale=1,maximum-scale=1,user-scalable=no&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&#39;https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js&#39;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&#39;https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css&#39;</span> <span class="na">rel=</span><span class="s">&#39;stylesheet&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>    <span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">height</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">/* 外部div样式 */</span>
</span><span class='line'>    <span class="nf">#container</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">20px</span> <span class="k">auto</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">800px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">height</span><span class="o">:</span> <span class="m">400px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#map</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>      <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- 增加外部div，限制高宽 --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&#39;map&#39;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">accessToken</span> <span class="o">=</span> <span class="s1">&#39;pk.eyJ1Ijoic2hhdGxlIiwiYSI6ImNqczF4NzgxdTA3dnc0NHA4aG5sdDk3Y2gifQ.Mr3uL3avjz6PD6zkCvwxPw&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">container</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;mapbox://styles/mapbox/light-v9&#39;</span><span class="p">,</span> <span class="c1">// 这是灰色地图</span>
</span><span class='line'>      <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="mf">113.374233</span><span class="p">,</span> <span class="mf">23.137433</span><span class="p">],</span>
</span><span class='line'>      <span class="nx">zoom</span><span class="o">:</span> <span class="mi">15</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 当 map 地图加载完成后，添加图层</span>
</span><span class='line'>    <span class="c1">// 下面数据有三个特征 feature 数据， 一个是红色的路线，两个是天蓝色的路线</span>
</span><span class='line'>    <span class="c1">// 可以通过js来控制加载哪些特征数据，就可以做到区别显示了</span>
</span><span class='line'>    <span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 红色</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;redlines&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;geojson&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;data&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;FeatureCollection&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;features&#39;</span><span class="o">:</span> <span class="p">[{</span> <span class="c1">// 这里是红色 dataset </span>
</span><span class='line'>              <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#F7455D&#39;</span> <span class="c1">// red</span>
</span><span class='line'>              <span class="p">},</span>
</span><span class='line'>              <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.371858</span><span class="p">,</span> <span class="mf">23.137009</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.37309</span><span class="p">,</span> <span class="mf">23.136758</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.373807</span><span class="p">,</span> <span class="mf">23.1366</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.374053</span><span class="p">,</span> <span class="mf">23.136553</span><span class="p">]</span>
</span><span class='line'>                <span class="p">]</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>            <span class="p">}]</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// 天蓝</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;bluelines&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;geojson&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;data&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;FeatureCollection&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;features&#39;</span><span class="o">:</span> <span class="p">[{</span> <span class="c1">// 这里是天蓝 dataset </span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                    <span class="p">[</span>
</span><span class='line'>                      <span class="mf">113.37421857524919</span><span class="p">,</span>
</span><span class='line'>                      <span class="mf">23.13651914382298</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="p">...</span>
</span><span class='line'>                  <span class="p">]</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">},</span>
</span><span class='line'>              <span class="p">{</span> <span class="c1">//这里是天蓝 另外一条路线</span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                    <span class="p">[</span>
</span><span class='line'>                      <span class="mf">113.37539098241979</span><span class="p">,</span>
</span><span class='line'>                      <span class="mf">23.13607741667701</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="p">...</span>
</span><span class='line'>                  <span class="p">]</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于后期还需要区分操作显示，再次过了一下官网上的例子，有通过按钮点击，切换显示不同路线图层的方法，另外还有直接使用 tileset 进行异步请求数值数据的方法，不用复制数值数据了，效果见 <a href="/mapbox/switch.html">switch.html</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&#39;utf-8&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>Show and hide layers<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  ...
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>    <span class="nf">#menu</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>      <span class="k">z-index</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>      <span class="k">top</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">right</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">120px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">4</span><span class="p">);</span>
</span><span class='line'>      <span class="k">font-family</span><span class="o">:</span> <span class="s1">&#39;Open Sans&#39;</span><span class="o">,</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">font-size</span><span class="o">:</span> <span class="m">13px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#404040</span><span class="p">;</span>
</span><span class='line'>      <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border-bottom</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">25</span><span class="p">);</span>
</span><span class='line'>      <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nd">:last-child</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">border</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background-color</span><span class="o">:</span> <span class="m">#f8f8f8</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#404040</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nc">.active</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background-color</span><span class="o">:</span> <span class="m">#3887be</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#ffffff</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nc">.active</span><span class="nd">:hover</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background</span><span class="o">:</span> <span class="m">#3074a4</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;nav</span> <span class="na">id=</span><span class="s">&quot;menu&quot;</span><span class="nt">&gt;&lt;/nav&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">accessToken</span> <span class="o">=</span> <span class="s1">&#39;pk.eyJ1Ijoic2hhdGxlIiwiYSI6ImNqczF4NzgxdTA3dnc0NHA4aG5sdDk3Y2gifQ.Mr3uL3avjz6PD6zkCvwxPw&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">container</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;mapbox://styles/mapbox/light-v9&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">zoom</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="mf">113.374233</span><span class="p">,</span> <span class="mf">23.137433</span><span class="p">]</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addSource</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;vector&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;mapbox://shatle.cjs1z8leu4hge2xpkx5s9faxa-814td&#39;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source-layer&#39;</span><span class="o">:</span> <span class="s1">&#39;lcm-test&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;layout&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;visibility&#39;</span><span class="o">:</span> <span class="s1">&#39;visible&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-join&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-cap&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="s1">&#39;#ff0000&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addSource</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;vector&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;mapbox://shatle.cjs3g5w7k01us2wmudbbgjxks-6t25j&#39;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source-layer&#39;</span><span class="o">:</span> <span class="s1">&#39;lcmtest2&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;layout&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;visibility&#39;</span><span class="o">:</span> <span class="s1">&#39;visible&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-join&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-cap&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">toggleableLayerIds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">toggleableLayerIds</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">toggleableLayerIds</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">clickedLayer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">visibility</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">visibility</span> <span class="o">===</span> <span class="s1">&#39;visible&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">map</span><span class="p">.</span><span class="nx">setLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">map</span><span class="p">.</span><span class="nx">setLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;visible&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">layers</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;menu&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">layers</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">link</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2018/01/24/think-of-interview/" itemprop="url">Think of Interview</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/interveiw/'>interveiw</a>


</div>
		<div class="date">







  


<time datetime="2018-01-24T00:00:00+08:00" data-updated="true" itemprop="datePublished">2018-01-24</time></div>

		
			<span class="comments"><a href="/blog/2018/01/24/think-of-interview/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>去年，项目组事情比较多，每个人的工作量都有些大，经常加班深夜，导致整体团队都很累，所以，急需招入小伙伴。
在之前的前端人员离职之后，增加开发人员越加紧迫。下面，整理一下面试的体会。</p>

<h4>个人总结</h4>

<p>参与的是技术面试，应试人员过来时会有一份笔试。当应试人员完成试卷时，我们才下去进行真正的面试。
我作为一个辅助的技术面试人员，主要是补充提问。</p>

<p>在面试的过程中，上级领导也给出了些不少的建议，指出改进的地方。</p>

<p><strong>个人介绍</strong></p>

<p>初期，作为技术面试，上来就会对应试人员进行题面的提问。
这里有个问题，忽略了人的基本属性。招聘进来的是人，一个需要参与团队的人，而不是简单的一个技术机器。</p>

<p>个人介绍，通常可以提前准备，也可以没有准备。但无论如何，从中都可以看出应该的基本语言表达能力。或者，如果连这准备都没有，可以看出是否重要此次的面试。</p>

<p>在应试人员的自我介绍时，只需要简单的抓住关键点，了解其基本表达能力。同时，面试人员可以快速的浏览其做题的情况，在心里有个大概的提问方向。</p>

<p><strong>笔试提问</strong></p>

<p>前端的题面，包括js/css/jQuery的基础、算法、工作常遇到的问题等。</p>

<p>js基础，可以看出应试人员在开发过程中的细心程度，但通常工作之后的应试人员表现得都不是很理想，反而是实习生在答案上表现得优异。</p>

<p>做为过来人，是知道其原因的，也很容易理解。实习生有足够的时间来准备各种面试，而还在工作的应试人员就不一样，他们需要完成正常工作中的任务。</p>

<p>需要找到一个基础很好，又有工作经验的人，也不是简单地找一个年限够长的在职人员。关键在于，应试人员是否有意识去注意使用中的细节。</p>

<p>算法，应试人员基本都不怎么样，反而是实习生会好些。前端的工作，了解需求，对接后端的接口，并实现设计人员的交互，最大限度地提升用户体验。通常来说，后端返回的数据会避免过大的数据，以便于处理，致使前端的算法机能表现弱些。</p>

<p>在编程时还是需要注意细节，比如循环与零比较都是可以作为优化的点。现在编程中，习惯使用与underscode类似的lodash进行各操作，ES6也提供了较先进的方法，但最终还是希望有优化编辑的意识。</p>

<p>其中，令我好奇的是，有些人一直使用for循环，而不去寻找更为方便的underscore/lodash工具进行数据处理，这是不是也反应出一部分人对编程没有优化/简化的想法。</p>

<p>工作中遇到的问题，比如如何避免附件缓存等，都是常见的问题。如果实在没有遇到，也是考验应试人员的一个点。但如果面试过程良好，还会话面时进行相关提问。</p>

<p>笔试提问，可以看到应试人员基技术基础好不好，还可以看到其快速理解力，及对题目回答的表达能力等。工作中，这些都是基础的。</p>

<p><strong>话面</strong></p>

<p>抛开题目，进入话面。希望看到应试人员几点：</p>

<ul>
<li><p>生活方面是否适合当前团队。</p>

<p>  应试人员是哪里人，现居住在哪里。作为一个开发人员，工作中可能会有些意料不到事情，是否可以快速反应并到场解决问题。</p>

<p>  工作肯定会有各方面的压力，通常是怎么释放的。工作之余有什么爱好，比如运动、聚会什么的，也是值得参考的。即使碰到对编程极度热爱的人员，通常也会喜欢听歌、看电影。</p>

<p>  是否结婚，有无男女朋友，对象的工作地点，这些也会对是否成功入职有一定的影响，所以也是需要考虑的。</p></li>
<li><p>技术知识点是否是团队需要的。</p>

<p>  技术知识点太多，首先会在简历上做了一层过滤，这可以过滤大部分的不是团队需要的人员。</p>

<p>  另外，出于开放的原则，会对部分未完全匹配的简介给予面试的机会，希望能够找出优秀的人员。</p>

<p>  比如，工作中只使用过 AngularJS 或 VueJS，而现有的工作需求是 React，那么也会给予机会面试。毕竟，很多框架类的东西是相通的。但，没有 React 项目经验的人员，需要注意提问其掌握框架的大致时间，了解其学习、快速上手的能力。</p>

<p>  如果掌握需求匹配的技术，还需要深入的了解技术细节，实践过程中遇到的问题和解决方法。</p></li>
<li><p>理解问题能力</p>

<p>  理解问题，可以从笔试部分了解到。遇到些应试人员，在做笔试部分时就没有读懂题目。这原因可能是一时的疏忽，但本人觉得更多的是没有相应的知识概念，这点并不可耻，毕竟每个人的知识范围都是有限的。</p>

<p>  在话面过程中，我们也会提到一些技术或者其它的问题。通常，这些问题都是根据应试人员的经历来进行提问的，也有些关联性可能较远的问题，试图去了解到应试人员对熟悉领域中的问题是否有快速的反应能力，对不熟悉领域是否有解决和求知的欲望。</p></li>
<li><p>正常沟通能力</p>

<p>  沟通能力，这是必须的，也是很重要的。</p></li>
</ul>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2018/01/17/my-coin-work-recently/" itemprop="url">My_coin_work_recently</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/coin/'>coin</a>


</div>
		<div class="date">







  


<time datetime="2018-01-17T00:00:00+08:00" data-updated="true" itemprop="datePublished">2018-01-17</time></div>

		
			<span class="comments"><a href="/blog/2018/01/17/my-coin-work-recently/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>最近的炒币</h2>

<p>最近，有同事比较热衷于炒虚拟币，都是打着区块链的技术，炒各种概念币种。</p>

<p>同事炒了国内的一个井通币，投入几千块钱，翻倍回来了，羡慕这敢行动的行为。</p>

<p>于是，自己也下载了些炒币应用，有火币、OKex、井通这三个，还有其它小的应用。</p>

<p>火币和OKex的交易应用上线美国地区的苹果商店；井通的应用没有上线苹果商店，也没有交易平台；其它只是用来跟进比较，没有使用。</p>

<p>井通币升到0.28时，我想跟进同事的脚步的，但是井通平台的充值只能通过QQ进行转账。确实比较山寨，我在联系充值客服时，没有成功，结果没有充上。结果，第二天就开始下跌了，直到今天0.06左右。</p>

<p>虽然有些庆幸没有入井通这一个坑，但是，我并不因此觉得自己多明智。我在意的是，为什么我没有进去的勇气？</p>

<p>于是上周末，我逼了自己一下，通过火币网卖了1500元的USDT币。但是，很多币币交易只能使用BTC和ETH进行交易，所以我又用USDT买了ETH，由于钱太少了，买不了多少的BTC，交易起来前面的小数点太多。</p>

<p>在买USDT之后，由于USDT的价格比国家的汇率要高很多，所以，买完之后，显示的价值已经少了100多块了。接着，交易ETH之后，手续费需要0.2%，同时当前的ETH又在下跌，整体看，少了二百多块。</p>

<p>前段时间我得到的结果时，只有新币发行时，才会有比较大的上涨幅度，类似于新股上市；发行比较久的币种上涨比较小，并且多数是在下跌的。</p>

<p>所以，<strong>只买卖新币种</strong>。</p>

<p>不幸的是，整体的币种价值在下跌，我的原始资本一直在消耗。所以，决定开始行动。</p>

<p>中午，12点有发行新币种 THETA，我晚些进场，没有赶上较低的时候，当前已经比发行价上升了30%多。我直接买进，十几分钟后，在发行价45%左右出手，换回了ETH，赚了点。</p>

<p>下午2点又有新币种LET，根据上个经验，我快手地进入效果界面，直接交易出了所有的 ETH，但是，我回头一看，当前的涨幅已经是发行价的200%以上了，不到一分钟，就这个状态了，当我意识到时，已经下跌到60%多了，价值直接扣半，后悔。</p>

<p><strong>买卖不能心急，宁愿错过，不能做错</strong></p>

<p>需要看清本质，翻两倍肯定是危险的，不可取的。三天不到，资产减过半。</p>

<p><strong>做事要勇敢，不能心急，但不要怯于尝试</strong></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/09/27/react-dnd-intro-2/" itemprop="url">React-dnd Intro-2</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/react/'>react</a>, <a class='category' href='/blog/categories/react-dnd/'>react-dnd</a>


</div>
		<div class="date">







  


<time datetime="2016-09-27T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-09-27</time></div>

		
			<span class="comments"><a href="/blog/2016/09/27/react-dnd-intro-2/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>react-dnd 简析 2</h2>

<p>上篇文章有说到场景：卡片在不同的容器之间来回拖动。下面，对上篇文章中的代码整理一下：</p>

<h4>上期代码</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// ItemTypes</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">ItemTypes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">CARD</span><span class="o">:</span> <span class="s1">&#39;Card&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Card</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">connectDragSource</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">index</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">text</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">boxId</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDragSource</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dragSource</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">isDragging</span><span class="o">:</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">isDragging</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span> <span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span> <span class="nx">Card</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragCard</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// CardBox</span>
</span><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="err">，</span><span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardBoxTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverCard</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span> <span class="o">!=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCardBox</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardBoxTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">CardBox</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DropCardBox</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Kanban</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragDropContext</span><span class="p">(</span><span class="nx">HTML5Backend</span><span class="p">)(</span><span class="nx">Kanban</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这四个文件，<code>ItemTypes.js</code>/<code>Card.js</code>/<code>CardBox.js</code>/<code>Kanban.js</code> 为基本的模型文件，样式文件应该也要有的，这里就贴了。</p>

<h4>新需求</h4>

<p>对于看板来说，不同容器间的来回拖动是必要的。同时，如果想在单个容器中上下拖动，又需要怎么实现？</p>

<p>由于上篇文章的<code>changeCard(index, newBoxId)</code>只能调整卡片的<code>boxId</code>的属性，并不能改变其同一容器中的上下位置，所以需要调整一下，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// 增加一个参数 newIndex</span>
</span><span class='line'><span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">,</span> <span class="nx">newIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">newBoxId</span> <span class="o">&amp;&amp;</span> <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">!=</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">newIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">index</span> <span class="o">!=</span> <span class="nx">newIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// newIndex 当卡片拖动到某个卡片的上面时，</span>
</span><span class='line'>    <span class="c1">// newIndex 就是此某个卡片的 index</span>
</span><span class='line'>    <span class="c1">// 将拖动的卡片 剪切到 此位置上</span>
</span><span class='line'>    <span class="c1">//</span>
</span><span class='line'>    <span class="c1">// dragCard.index ~= newIndex</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">newIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}))</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过调整 <code>index</code> 的值来达到位置上的变化。</p>

<hr />

<p>当卡片拖动到另一卡片上面时，需要获取到这一卡片的 <code>index</code> 的值，再将拖动卡片设置到新的位置上。</p>

<p>那么，需要将<code>Card</code>设置为可接受的容器<code>DropTarget</code>。</p>

<p>参考之前的<code>CardBox</code>,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragIndex</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">index</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverIndex</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Don&#39;t replace items with themselves</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">===</span> <span class="nx">hoverIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Determine rectangle on screen</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverBoundingRect</span> <span class="o">=</span> <span class="nx">findDOMNode</span><span class="p">(</span><span class="nx">component</span><span class="p">).</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get vertical middle</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverMiddleY</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Determine mouse position</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">clientOffset</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getClientOffset</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get pixels to the top</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverClientY</span> <span class="o">=</span> <span class="nx">clientOffset</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Only perform the move when the mouse has crossed half of the items height</span>
</span><span class='line'>    <span class="c1">// When dragging downwards, only move when the cursor is below 50%</span>
</span><span class='line'>    <span class="c1">// When dragging upwards, only move when the cursor is above 50%</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dragging downwards</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">&lt;</span> <span class="nx">hoverIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">hoverClientY</span> <span class="o">&lt;</span> <span class="nx">hoverMiddleY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dragging upwards</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">&gt;</span> <span class="nx">hoverIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">hoverClientY</span> <span class="o">&gt;</span> <span class="nx">hoverMiddleY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Time to actually perform the action</span>
</span><span class='line'>    <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">dragIndex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">hoverIndex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Note: we&#39;re mutating the monitor item here!</span>
</span><span class='line'>    <span class="c1">// Generally it&#39;s better to avoid mutations,</span>
</span><span class='line'>    <span class="c1">// but it&#39;s good here for the sake of performance</span>
</span><span class='line'>    <span class="c1">// to avoid expensive index searches.</span>
</span><span class='line'>    <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">hoverIndex</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上参考官方的例子，通过 <code>component</code>来获取纵向属性，来准确得到 <code>newIndex</code> 参数。
当拖动的高度没有达到卡片一半时，不会触发<code>changeCard(..)</code>方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCard</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">Card</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>dropCollect</code> 基本是一样的。</p>

<p>那么，完成这点之后，<code>Card</code>是可拖动的，又是可以容器，
所以，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Card</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">isDragging</span><span class="p">,</span> <span class="nx">connectDragSource</span><span class="p">,</span> <span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">opacity</span> <span class="o">=</span> <span class="nx">isDragging</span> <span class="o">?</span> <span class="mf">0.5</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span>
</span><span class='line'>        <span class="nx">style</span><span class="o">=</span><span class="p">{</span> <span class="p">{</span><span class="nx">opactiy</span><span class="o">:</span> <span class="nx">opacity</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>        <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCard</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">Card</span><span class="p">);</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span><span class="nx">DropCard</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragCard</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过最后处绑定，<code>Card</code>的<code>props</code>会多出来个值来<code>connectDragSource</code>/<code>connectDropTarget</code>。</p>

<p>在<code>Card</code>类中，根据 <code>isDragging</code>来判断设置卡片的透明度，这就是为什么之前要重新定义<code>CardSource</code>中的<code>isDragging</code>方法的缘由。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为，当一个拖动卡片的<code>index</code>为<code>1</code>时，<code>dnd</code>默认会其标识为<code>isDragging=true</code>。而，拖动卡片到<code>index=0</code>时，由于<code>changeCard</code>，拖动卡片此时会从<code>1 -&gt; 0</code>，由于<code>isDdragging</code>不会重新判断，所以，显示效果会是：</p>

<blockquote><p>哪个卡片占原拖动卡片的位置，就会是有透明度</p></blockquote>

<p>但这并不是我们所要的，所以，是否能拖动，使用唯一标识<code>id</code>来判断。</p>

<p>还要注意，<code>Kanban</code>中需要传入方法给<code>Card</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//...</span>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>      <span class="c1">//...</span>
</span><span class='line'>      <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>     <span class="o">/&gt;</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="c1">//...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>最后</h4>

<p>真正使用时，还是需要定义<code>DropTarget</code>中的<code>drop</code>方法的，而文中只谈到了<code>hover</code>方法，这部分让大家自己去探索吧。</p>

<p>打完收功。</p>

<h4>后记</h4>

<p>其实，一个插件能不能用，除了了解其用法之外，还可能需要了解其性能。</p>

<p>就本人的5年前的小笔记本来说，200个普通文本卡片还是可以自由拖动的，效果还是可以的。</p>

<p>当到300时，部分快速拖动会失效，可能是排序和渲染上的耗时吧，
好点的机器可能会好点。</p>

<p>另外，从调试过程看出，<code>dnd</code>只会对有数据变化的卡片重新调用<code>render()</code>渲染方法，并不是所有都会重新渲染一遍的。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/09/25/react-dnd-intro/" itemprop="url">React-dnd Intro</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/react/'>react</a>, <a class='category' href='/blog/categories/react-dnd/'>react-dnd</a>


</div>
		<div class="date">







  


<time datetime="2016-09-25T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-09-25</time></div>

		
			<span class="comments"><a href="/blog/2016/09/25/react-dnd-intro/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>React-dnd 简析</h2>

<p>对于开源插件或者代码来说，我更喜欢推荐其 github 地址，而不是官网地址：</p>

<blockquote><p>https://github.com/gaearon/react-dnd</p></blockquote>

<h4>安装</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>npm install react-dnd -D
</span><span class='line'>npm install react-dnd-html5-backend -D</span></code></pre></td></tr></table></div></figure>


<p><code>react-dnd-html5-backend</code> 是一个必要的可选组件，因为 html5 的拖拽API 支持拖动的阴影，总的来说，这插件是必要的。</p>

<p>详细的各名称就不在此说明了，直接介绍关键点吧。</p>

<h4>基础</h4>

<p>拖拽功能，首先需要知道两个基本的部分：拖起、放下。</p>

<p>拖起，就是鼠标放下并移动的过程；放下，就是鼠标放下拖动元素。
在这一整个过程中，需要声明哪个元素是可以拖动的，哪个元素是可以接收拖动元素的。</p>

<p><code>react-dnd</code> 中，使用 <code>DragSource</code> 来声明拖动的元素，用<code>DropTarget</code>来声明接收拖动元素的容器。</p>

<p>下面将会通过 看板 的常用功能进行相关的介绍。</p>

<p>看板 基本会涉及到 卡片的上下拖动 和 卡片在不同区间的拖动。</p>

<h4>实体 Card, CardBox, Kanban</h4>

<p>为了实现基本的功能，需要拖动的实体 Card 有两个基本属性：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>id
</span><span class='line'>text // 用于显示卡片
</span><span class='line'>boxId // 用于表示容器间的拖动</span></code></pre></td></tr></table></div></figure>


<p>Card 实体的简单显示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>CardBox 容器用来接收 Card, 其属性为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">boxId</span>
</span></code></pre></td></tr></table></div></figure>


<p>显示代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>children</code> 表示显示的容器中的多个卡片。</p>

<p>最后，看板的代码就是循环了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>先用 <code>boxes</code> 进行列的划分，再通过其的<code>boxId</code>的判断，来划分 <code>cards</code>对应于哪个列中。</p>

<p>为什么这样子循环来显示卡片，而不是先进行分组，再对组进行渲染。
此处主要考虑到，只想用一个内存来存储所有的卡片。如果分组，即相当于将所有 的卡片分开为多个内存存储，本文不想让其间卡片的内存跳转频繁。</p>

<p>但这实现方法有个缺陷，页面渲染会有空元素，<code>else return ''</code> 会造成一个空的<code>span</code> DOM元素。</p>

<p>所以，注意，此处是用到了卡片的<code>index</code>的。</p>

<p>这是基本实体，它们包含关系为 <code>Kanban &gt; CardBox &gt; Card</code></p>

<h4>DragSource</h4>

<p>api</p>

<blockquote><p>DragSource(type, spec, collect)(MyComponent)</p></blockquote>

<p><code>DragSource</code>， 顾名思义，就是可拖动的元素。在本文场景中，拖动元素就是<code>Card</code>了。</p>

<p>API 中，有必要的三个参数，分别是<code>type</code>, <code>spec</code>，<code>collect</code>。</p>

<h5>type</h5>

<p><code>type</code> 就是可拖动元素的名称，这会与 <code>DropTarget</code> 的 <code>type</code> 有关联。实际中，名称就是一个字符串，
本文场景中，可以有:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">ItemTypes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">CARD</span><span class="o">:</span> <span class="s1">&#39;Card&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h5>spec</h5>

<p><code>spec</code> 拖动元素的对象，注意，它必须是对象。它定义有四个方法，分别是<code>beginDrag(props, monitor, component)</code>，
<code>endDrag(props, monitor, component)</code>，<code>canDrag(props, monitor)</code>，<code>isDragging(props, monitor)</code>，详细说明可链接到
<a href="http://gaearon.github.io/react-dnd/docs-drag-source.html">Drag Source Specification</a></p>

<p>现在，主要对 <code>beginDrag(props, monitor, component)</code> 和 <code>isDragging(props, monitor)</code> 进行说明。</p>

<p><code>beginDrag(props, monitor, component)</code> 是必须声明的，它要求返回一个普通的对象，例如<code>{ id: props.id }</code>。
其实，它就是将你用的实体，选择拖动使用的属性进行返回。</p>

<p><code>isDragging(props, monitor)</code> 是可选的，是用来判断一个元素是否是在拖动的过滤中。默认下，一个对象是否是拖动中，
dnd 只会在拖动元素的开始拖动时设置其值。为什么要在这里突出说明一下，因为在操作场景中，初始化的设置在拖动的过程中，
很可能会不正确的，所以需要重新定义其方法实现。</p>

<p>在本文场景中，可以</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">index</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">text</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">boxId</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>monitor</code> 和 <code>component</code> 还是需要大家了解一下的。
<code>monitor</code> 就是整合拖动实体和拖动状态的新对象，<code>component</code>粗略可以理解为 DOM 元素。
详情看 <a href="http://gaearon.github.io/react-dnd/docs-drag-source.html">Drag Source Specification</a></p>

<h5>collect</h5>

<p><code>collect</code> 为一个函数，而函数返回的是一个对象。本质起到桥接作用，将拖动元素的属性和拖动状态整合。</p>

<p>本文场景中，<code>collect</code> 可以为，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDragSource</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dragSource</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">isDragging</span><span class="o">:</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">isDragging</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>综合以上，需要将 <code>Card</code> 声明为可拖动的元素，就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span> <span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span> <span class="nx">Card</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>同时，需要调整<code>Card</code>类的代码，将绑定引入的属性声明关联到元素中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">connectDragSource</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>DropTarget</h4>

<p>api</p>

<blockquote><p>DropTarget(types, spec, collect)(MyComponent)</p></blockquote>

<p>就是接收拖动元素的容器元素。</p>

<h5>types</h5>

<p>注意，第一个参数是 <code>types</code>，也就是说，它可以接收多种类型，但也可以是字符串。本文场景中，就是<code>ItemTypes.CARD</code>。</p>

<h5>spec</h5>

<p>同样是普通对象，但不同于拖动元素，容器元素中的说明参数中的方法有<code>drop(props, monitor, component)</code>，<code>hover(props, monitor, component)</code>，<code>canDrop(props, monitor)</code>。</p>

<p><code>hover(props, monitor, component)</code> 这里重点说一下此方法，因为这个比较常用，当然<code>drop</code>也很常用，但主要与后台交互时才会用到。比如，不同容器中的拖动，需要将放下时的<code>boxId</code>保存到后台，而<code>hover</code>是实时变化的，不适合与后台交互的action进行数据操作。</p>

<p>在拖动元素从一个容器元素，到另一容器元素时，其的<code>boxid</code>会发生变化，这才合理。</p>

<p>所以，需要在 <code>CardBox</code> 的中定义 <code>changeCard(index, newBoxId)</code> 的方法。
其中， <code>index</code>是所有<code>cards</code>列表中的<code>index</code>。</p>

<p>本文场景中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardBoxTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverCard</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span> <span class="o">!=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h5>collect</h5>

<p>类似于<code>DropSource</code>中的<code>collect</code>, 由于是容器，则没有拖动的属性了。</p>

<p>本文场景中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>综合上面，将<code>BoxCard</code>声明为拖动容器，就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">DropCardBox</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardBoxTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">CardBox</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>同时，绑定后，需要在模型中关联渲染的元素，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>另外</h4>

<p>基本上，上面大致介绍了一个卡片在不同的容器间相互拖动的故事。</p>

<p>另外，需要指出的是，<code>react-dnd</code> 所有的元素需要使用 <code>DragDropContext</code> 来包裹起来，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">DragDropContext</span><span class="p">(</span><span class="nx">HTML5Backend</span><span class="p">)(</span><span class="nx">Kanban</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面其中有提到，卡片中容器间相互拖动，需要改变其 <code>boxId</code> 的值，
那么，需要在<code>CardBox</code>中传入<code>changeCard(index, newBoxId)</code> 方法属性。
所以，<code>Kanban</code>需要调整为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/04/23/rspec-practices-1/" itemprop="url">Rspec Practices 1</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/rspec/'>rspec</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		<div class="date">







  


<time datetime="2016-04-23T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-04-23</time></div>

		
			<span class="comments"><a href="/blog/2016/04/23/rspec-practices-1/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>U should add gem <code>rspec-rails</code> in ur project&#8217;s Gemfile, then bundle.</p>

<p>Then, u need run command <code>rails g rspec:install</code>.</p>

<p>When u use rails commands, likes <code>rails g model User xx:xx</code>. It will help u to create <code>spec/models/user_spec.rb</code> file.</p>

<p>Yes, Rspec will check <code>_spec.rb</code> file as test file.</p>

<p>Give me some codes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:model</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;signup with&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;email and password, then success.&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123@exmaple.com&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;illege email and password, then fail.&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123sdf&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;email and no password, then fail. &quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span> <span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span> <span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and then, u can use <code>rspec</code> to test all <code>_spec</code> files,
or u can only test <code>user_spec.rb</code> file with <code>rspec spec/models/user_spec.rb</code> command.</p>

<p>if no error, u can get</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">3</span> <span class="n">examples</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is not a good view. We just not work for testing, but say something to others.</p>

<p>U can run <code>rspec --format doc</code>,  will get result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span>
</span><span class='line'>  <span class="n">signup</span> <span class="n">with</span>
</span><span class='line'>    <span class="n">email</span> <span class="ow">and</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="n">success</span><span class="o">.</span>
</span><span class='line'>    <span class="n">illege</span> <span class="n">email</span> <span class="ow">and</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="nb">fail</span><span class="o">.</span>
</span><span class='line'>    <span class="n">email</span> <span class="ow">and</span> <span class="n">no</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="nb">fail</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">3</span> <span class="n">examples</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/03/20/es6-in-depth-the-future/" itemprop="url">ES6 in Depth: The Future</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/es6/'>es6</a>, <a class='category' href='/blog/categories/es7/'>es7</a>, <a class='category' href='/blog/categories/future/'>future</a>, <a class='category' href='/blog/categories/shen-ru-es6/'>深入es6</a>


</div>
		<div class="date">







  


<time datetime="2016-03-20T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-03-20</time></div>

		
			<span class="comments"><a href="/blog/2016/03/20/es6-in-depth-the-future/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote><p><a href="https://hacks.mozilla.org/2015/08/es6-in-depth-the-future/">ES6 In Depth: The Future</a></p></blockquote>

<p>上周的ES6模块结束了为期四个多月的ES6新特性的这一系列的文章。</p>

<p>这文章主要会包括我们之前未讨论过的众多新特性，它们就如这JS语言大厦中的衣柜和奇怪的房子都是十分有趣的，也许还会一个地下室，或者有两个。如果你没有阅读过这一系统的其它文章，可以看<a href="http://shatle.github.io/blog/categories/shen-ru-es6/">这里</a> 。这文章并不是好的开头。</p>

<p>额外提醒：之前提到的很多特性还没有得到广泛的支持。好了，让我们开始吧。</p>

<h4></h4>

<p>ES6部分特性的标准化来源于之前的其它标准过程，或者部分得到广泛的实现支持而没有标准化。</p>

<ul>
<li><strong>类型数组(Typed arrays)/ArrayBuffer/DataView</strong> 这些是WebGL标准化的一部分，但现在也会运用于其它许多地方的API，包括Canvas、网络音频API和WebRTC。无论你处理多大的二进制文件或者数值数据，都是很方便的。</li>
</ul>


<p>例如，如果你<code>Canvas</code>需要渲染内容时没有你想要的，或者你希望手动操作更为高效时，你可以自己实现它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">pixels</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span> <span class="c1">// a Uint8ClampedArray object ect</span>
</span><span class='line'><span class="c1">// ... Your code here!</span>
</span><span class='line'><span class="c1">// ... Hack n the raw bits in `pixels`</span>
</span><span class='line'><span class="c1">// ... and then write them back to th canvas;</span>
</span><span class='line'><span class="nx">context</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>在标准化过程中，类型数组(Typed arrays)包括有常见了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">方法</a>，如<code>.slice()</code>，<code>.map()</code>，<code>.filter()</code>。</p>

<ul>
<li><p><strong>Promises</strong>  仅用一个自然段来描写promise，就像是吃饭只能吃一个薯片。不用管它有多难，这甚至是什么任何意义的事情。说什么？Promise可以用来对JS进行异步编程来构建代码块。它的作用会在后面提到。比如，当你调用<code>fetch()</code>时，不像普通代码块，它会立即返回一个promise对象，其数据获取会在后台进行。当有返回值时，它会调用你的相应代码。promise优于普通的callback函数，因为它的操作链真心很好。promise有很多有趣的<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">操作</a>，通常会是第一选择，你可以简单进行错误处理而不需要做过多的学习。它们已经在浏览器支持了。如果你还不一点都不知道promise，可以查看 <a href="http://www.html5rocks.com/en/tutorials/es6/promises/">Jake Archibald 的文章</a>。</p></li>
<li><p><strong>函数在代码块的作用域中</strong> 你不应该让这情况出现，但是，你可能已经无意地存在相关代码了。</p></li>
</ul>


<p>在ES1-5中，下面的代码在技术上说是有问题的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">temperature</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">chill</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fan</span><span class="p">.</span><span class="nx">switchOn</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">obtainLemonade</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">chill</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个函数声明是在<code>if</code>代码块中的，这理念上是不允许的。函数声明只能在顶级中，或者在函数体内的最外层。</p>

<p>但是，上面代码几乎能在所有主流的浏览器中运行，从某种程度上是这样子的。</p>

<p>但又不完全一样，在每个浏览器中其处理细节有些不一样。但是，某种程度上都是可以工作的，并且很多网页还在使用它。</p>

<p>不幸的是，Firefox和Safari还没有实现新的标准。对现在来说，可以使用一个函数的表达式来替代：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">temperature</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">chill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fan</span><span class="p">.</span><span class="nx">switchOn</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">obtainLemonade</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">chill</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>多年来，代码块作用域函数(block-scoped function)没有标准化是因为向后兼容的限制并非常复杂。没有人认为他们可以解决这一问题。ES6处理这种<a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-block-level-function-declarations-web-legacy-compatibility-semantics">奇怪规则</a>的线程只能在非严格模式中使用。我不能在这里解释，但请相信我，使用严格模式。</p>

<ul>
<li><strong>函数名称</strong> 所有的主流JS引擎都会在函数中有个非标准的<code>.name</code>属性来表示其名称。ES6对此进行了标准化，它会明智地对某些没有名称的函数推测出<code>.name</code>的属性：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">lessThan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="o">&lt;</span><span class="nx">b</span><span class="p">;}</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">lessThan</span><span class="p">.</span><span class="nx">name</span>
</span><span class='line'>    <span class="s2">&quot;lessThan&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>好事</h4>

<ul>
<li><strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign(target, &#8230;sources)</a></strong> 标准库中的新函数，类似于Underscore中的<code>.extend()</code></li>
<li><strong>函数调用中的展开操作符(spread operator，实际是省略号，翻译为展开操作符因为作用就是将数据展开为多个值)</strong>  在这里Nutella并没有做什么，尽管Nutella尝着美味。但是，它依然是个美味的特性，我认为你们会喜欢的。</li>
</ul>


<p>在之前的五月中，我们介绍了<a href="http://shatle.github.io/blog/2015/10/25/es6-in-depth-rest-parameters-and-defaults/">rest parameters</a>，这为函数提供了一个可能接收任意数量的参数方式，它比那随意、笨拙的<code>arguments</code>对象更为友好。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">log</span><span class="p">(...</span><span class="nx">stuff</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// stuff is the rest parameter.</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">rendered</span> <span class="o">=</span> <span class="nx">stuff</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">renderStuff</span><span class="p">);</span> <span class="c1">// It&#39;s a real array.</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#log&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">rendered</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>那时我们并没有对函数中传递任意数量的参数的匹配语法进行说明，它相比<code>fn.apply()</code>更为友好。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// log all the vlaues from an array</span>
</span><span class='line'><span class="nx">log</span><span class="p">(...</span><span class="nx">myArray</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>好的，它可以作用于任意的<a href="https://hacks.mozilla.org/2015/04/es6-in-depth-iterators-and-the-for-of-loop/">迭代对象</a>，所以你可以通过<code>log(...mySet)</code>来记录所有的事情。</p>

<p>并不像剩余参数，它可以在一个参数列表中使用多个展开操作符：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// kicks are before trids</span>
</span><span class='line'><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Kicks:&quot;</span><span class="p">,</span> <span class="p">...</span><span class="nx">kicks</span><span class="p">,</span> <span class="s2">&quot;Trids:&quot;</span><span class="p">,</span> <span class="p">...</span><span class="nx">trids</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>展开操作符可以二维数组压平为一维数组：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">smallArrays</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[],</span> <span class="p">[</span><span class="s2">&quot;one&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;twos&quot;</span><span class="p">]];</span>
</span><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">onBigArray</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">smallArrays</span><span class="p">);</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">oneBigArray</span>
</span><span class='line'>    <span class="p">[</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;twos&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>但也许只有我有这一个迫切的需求，如果是这样，我真要责骂Haskell了。</p>

<ul>
<li><strong>构建数组时的展开操作符</strong> 同样回到五月，我们谈到解构中的&#8221;rest“剩余模式。这是一个可以将一数组中的任意数量值取出来的方式。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="p">[</span><span class="nx">head</span><span class="p">,</span> <span class="p">...</span><span class="nx">tail</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">head</span>
</span><span class='line'>    <span class="mi">1</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">tail</span>
</span><span class='line'>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>猜测一下下面代码。这匹配的语法会将任意数量的元素整合为一个数组：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">reunited</span> <span class="o">=</span> <span class="p">[</span><span class="nx">head</span><span class="p">,</span> <span class="p">...</span><span class="nx">tail</span><span class="p">];</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">reunited</span>
</span><span class='line'>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>同样的，你可以在函数调用中拥有相同的规则：你可以在同一数组中使用多次展开操作符，等等。</p>

<ul>
<li><strong>适时的尾部调用</strong>  如果让我在这里解释这个，对我来说还是难的。</li>
</ul>


<p>为了更好地理解这一特性，没有比这<a href="https://mitpress.mit.edu/sicp/full-text/book/book-Z-H-9.html#%_chap_1">计算机编程的结构和解析</a>更合适开始学习的了。如果你感兴趣，你可以坚持读它。尾部调用会在 <a href="https://mitpress.mit.edu/sicp/full-text/book/book-Z-H-11.html#%_sec_1.2.1">1.2.1部分 线性递归与迭代</a>中有解释。ES6标准化中要求的实现是线性递归的方式，也就是那文章提到的。</p>

<p>没有任一主流的浏览器实现这一特性，这很难实现，但是所有的事情都在往好的方向发展。</p>

<h4>文本(Text)</h4>

<ul>
<li><strong>Unicode 版本升级</strong> ES5要求实现至少支持Unicode的3.0版本字符。ES6则要求至少是Unicode 5.1.0。你可以在函数名称上使用<a href="https://en.wikipedia.org/wiki/Linear_B">Linear B</a>。</li>
</ul>


<p>[Linear A]使用上还有点问题，因为它在Unicode7.0版本之前没有支持，也因为很难管理没有破译的语言进而的代码编写。</p>

<p>(尽管JS引擎支持在Unicode6.1版本中的emoji，但你还是不能使用这些表情作为变量的名称。出于某种原因，Unicode联盟不支持使用它们作为身份标识字符。)</p>

<ul>
<li><strong>长的Unicode转义序列</strong> 如早期版本一样，ES6支持4个数值的Unicode转义序列。它们看着如<code>\u212A</code>。它们很好用，你可以在字符串中使用它们。或者，如果你想耍幽默同时你无论什么时候也不同进行代码检查，你可以使用它们作为变量的名称。但是，对于一个字符如<code>U+1a3021</code>，一个用头倒立的人的埃及象形文字，明显是有问题的。<code>13021</code>有五个数值，已经超过了四个。</li>
</ul>


<p>在ES5中，你不得不编写两个转义符号，因为UTF-16的代理对(surrogate pair)。这实际上就感觉生活在暗黑时代：寒冷、悲惨、野蛮的。ES6就像是意大利的文化复兴，带来了巨大的变化：你现在可以编写<code>\u{13021}</code>。</p>

<ul>
<li><strong>对BMP字符有更好支持</strong> <code>.toUpperCase()</code>和<code>.toLowerCase()</code>方法现在可以用于犹太字符中了。</li>
</ul>


<p>同样的，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCodePoint"><code>String.fromCodePoint(...codePoints)</code></a>函数与老式的<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCharCode"><code>String.fromCharCode(...codeUnits)</code></a>差不多，只是前者会支持BMP的点编码。</p>

<ul>
<li><strong>Unicode 正则</strong> ES6的正则表达式支持新的标签，<code>u</code>标签，因为除在BMP中正则表达式认为会将其认为是个单独的字符，而不是两个分离的编码单元。例如，没有<code>u</code>时，<code>/./</code>只会匹配半个字符“ ”，但<code>/./u</code>会匹配整个。</li>
</ul>


<p>在正则在增加<code>u</code>的标签，还可以处理unicode的非大小写和长类型的unicode转义序列。至于完整的说明，可参考<a href="https://mathiasbynens.be/notes/es6-unicode-regex">Mathias Bynens 非常详尽的文章</a></p>

<ul>
<li><p><strong>Sticky正则</strong> 对于非unicode的可以使用<code>y</code>标签，详情在<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/sticky">此可查看</a>。sticky正则表达式只会从由<code>.lastIndex</code>指定的偏移位开始查找，如果不要指定的位置找到，不会一直向下找，而是直接返回<code>null</code>。</p></li>
<li><p><strong>官方的国际化指引</strong> ES6实现了对国际化的支持，<a href="http://www.ecma-international.org/publications/standards/Ecma-402.htm">ECMA-402 the ECMAScript 2015 国际化说明</a>，这额外的标准中指定了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl"><code>Intl</code>对象</a>。Firefox，chorme 和 IE 11+ 已经支持它了，Node 0.12 也支持。</p></li>
</ul>


<h4>数值(Numbers)</h4>

<ul>
<li><strong>二进制和八进制</strong> 如果你觉得数字 8,675,309 和 <code>0x845fed</code>并不适合你，而想要一种更为特殊的方式表达，你现在可以编写<code>0o41057755</code>（八进制）或者 <code>0b100001000101111111101101</code>（二进制）。</li>
</ul>


<p><code>Number(str)</code>现在也可以识别这格式<code>Number("0b101010")</code>字符串，会返回42。</p>

<p>（快速提醒：<code>number.toString(base)</code>和<code>parseInt(stsring, base)</code>还是可以如原来一样转化数字，无论是转出还是转入，转换的过程中会根据base。）</p>

<ul>
<li><strong>新<code>Number</code>函数和常量</strong> 这是非常好的地方。如果你对此感兴趣，你可以自己查看标准文档，可以从<a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-number.epsilon"><code>Number.EPSILON</code></a>开始。</li>
</ul>


<p>也许，这最有意思的新想法是“安全的整型”，它可以从<code>-(2**25-1)</code>到<code>+(2**53-1)</code>，包含边界值 。JS中的数值存在着范围。这一个在此范围中的整型都可以用JS数字表示，进而可以查看其临近的数字。简单来说，在这范围中操作<code>++</code>和<code>--</code>得到的效果是期望所得的。超出这范围时，奇数是不能表示的，就如64位浮点的数字，同样这些数字的增加和减少也不能得到正确的结果（偶数也一样）。为了解决你代码中的这些问题，标准委员会提供了常量<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MIN_SAFE_INTEGER"><code>Number.MIN_SAFE_INTEGER</code></a>和<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER"><code>Number.MAX_SAFE_INTEGER</code></a>，和一个判断方法<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isSafeInteger"><code>Number.isSafeInteger(n)</code></a>。</p>

<ul>
<li><strong>新的<code>Math</code>函数</strong>  ES6增加了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/asinh">曲线三角函数</a> 和 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/atanh">它们的相反值</a>，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/cbrt"><code>Math.cbrt(x)</code></a> 会计算立方，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/hypot"><code>Math.hypot(x,y)</code></a> 会计算直角三角形的斜边长，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/log2"><code>Math.log2(x)</code></a> 和 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/log10"><code>Math.log10(x)</code></a> 会计算常见的对数值，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/clz32"><code>Math.clz32(x)</code></a>可帮忙求对数（其基本等于<code>32-log2(x)</code>，还有些其它的。</li>
</ul>


<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/sign"><code>Math.sign(x)</code></a> 可获取数字的符号（1,0,-1对应于正零负）。</p>

<p>ES6还添加了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/imul"><code>Math.imul(x, y)</code></a>，它就是32位的带符号乘法。这是十分奇怪的需求，除非你实际工作中没有64位的整型或者大数值的整型。如果是这样，这还是挺方便的， 这有助于编译器，Emscripten 可以利用此函数在JS中计算64位的乘法。</p>

<p>类似的，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/fround"><code>Math.fround(x)</code></a>可助于编译器对32位浮点数值的支持。</p>

<h4>结束语</h4>

<p>这就是所有特性了？</p>

<p>不。我还没有提到在所有内置迭代器中的对象通用原型，还有生成器函数的构造函数，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is(v1, v2)</code></a>。<code>Symbol.species</code>可以帮助进行子类内置操作，如数组和Promise。ES6 还有许多没有标准化的目标正在进行中。</p>

<p>我可以确认的是我肯定遗失些事情没有提到。</p>

<p>但是，如果你一直都跟着下来，你会对整体有个很好的印象。你可以知道今天你可以能用上的特性，如果你还这么做了，那么你正迈向更好的语言。</p>

<p>几天前，Josh Mock 提醒我说，他只只用的50行代码就说完了八个不同的ES6特性，但没有深入的想法。<a href="https://gist.github.com/JoshMock/98f187c7a8bf745e4cf6">文章</a>包含有模块、类、默认参数、Set、Map、模板字符串、前头函数、和let。（他忘记了for-of循环）</p>

<p>这也就是我的经验所得到的。文章对于新的特性在一块处理得很好，它们会真正影响到你日常编写的每一行代码。</p>

<p>同时，每个JS引擎都在积极跟进和优化这些我们之前几个月一直在讨论的特性。</p>

<p>只要我们的工作完成了，这语言也就完善好了。我们将不会不得不再次调整代码了，而我将不得不找其它工作了。</p>

<p>只是开个玩笑。ES7的提案已经提交了。这里可以暴露一点：</p>

<ul>
<li><p><strong>幂操作符</strong> <code>2**8</code>将会返回 256，这会是Firefox中的日版本中更新。</p></li>
<li><p><strong>Array.prototype.includes(value)</strong> 如果这数组包含有指定的值时，会返回true。此会通过polyfill的方式在Firefox的日版本中。</p></li>
<li><p><strong>SIMD</strong>  将128位的SIMD指令集提供给先进的CPU。这些指令集会对相邻的数组元素进行算术计算，可以动态地提升大范围的各种算术，对于流媒体音频、视频、密码、游戏、图片处理等都是相当有用的。更加底层的操作，更为强大。此会通过polyfill的方式在Firefox的日版本中。</p></li>
<li><p><strong>异步函数</strong> 我们在之前的生成器的文章中隐藏这一特性。异步函数类似于生成器，但区别时同步编程。当你调用一个生成器时，它会返回一个迭代器。当你调用一个异步函数时，它会返回一个promise。生成器可以使用yield的关键字来暂停和产出一个值；同步函数则会使用<code>await</code>关键字来暂停和等待一个promise。</p></li>
</ul>


<p>这是很难用几句话来说完的。但异步函数会在ES7中有重大的调整和意义。</p>

<ul>
<li><strong>类型化对象</strong>  这就是之前的类型数组。类型数组的元素拥有其类型，一个类型的对象是一个其属性被类型化后的对象。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Create a new struct type. Every Point has two fields</span>
</span><span class='line'><span class="c1">// named x and y.</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">Point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TypedObject</span><span class="p">.</span><span class="nx">StructType</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">x</span><span class="o">:</span> <span class="nx">TypedObject</span><span class="p">.</span><span class="nx">int32</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">y</span><span class="o">:</span> <span class="nx">TypedObject</span><span class="p">.</span><span class="nx">int32</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Now create an instance of that type.</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">({</span><span class="nx">x</span><span class="o">:</span> <span class="mi">800</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">600</span><span class="p">});</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span> <span class="c1">// 800</span>
</span></code></pre></td></tr></table></div></figure>


<p>你为了性能的原因会编写此代码。类似类型数组，类型对象会增加些编程的优势（减少内存的使用和提升速度），但是其每个对象、每个输入选项，相对于之前语言所有事情都会被静态地类型化，也就是被类型会之后，其值必须是那个类型。</p>

<p>这是作为JS的综合目标，并会在Firefox的日版本中实现。</p>

<ul>
<li><strong>类和原型装饰器</strong>  装饰器就是一个属性、类、方法中的标签。通过一个例子来说明其是什么样子的：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">debug</span> <span class="nx">from</span> <span class="s2">&quot;jsdebug&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kr">class</span> <span class="nx">Person</span> <span class="p">{</span>
</span><span class='line'>  <span class="err">@</span><span class="nx">debug</span><span class="p">.</span><span class="nx">logWhenCalled</span>
</span><span class='line'>  <span class="nx">hasRoundHead</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">head</span> <span class="k">instanceof</span> <span class="nx">Spheroid</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>@debug.logWhenCalled</code>就是所谓的装饰器，你可以想象这方法是做什么的。</p>

<p><a href="https://github.com/wycats/javascript-decorators/blob/master/README.md">这里的提案</a>有解释其详细工作的过程，同时还包含许多的例子。</p>

<p>还有一个令人兴奋的特性我不得不提到，但它还在开发阶段并且不是语言的特性。</p>

<p>TC39, 这个ECMAScript的标准委员会，将会更为频繁地发布版本和有更多的公开进度。在ES5和ES6之间已经有六年。委员会对ES7的目标是在ES6的12个月之后，随后的标准版本会以12个月的节奏进行发布。上面提到的部分特性已经准时完成了，它们会跟上这火车并成为ES7的一部分的。那些还没有完成的，会在下列火车的时间表中。</p>

<p>很高兴分享了很多的ES6的好的新特性，同时也很高兴能够花时间来讨论这些特性，可能以后再也没有这时间了。</p>

<p>很高兴参与深入ES6的文章，我希望你们能喜欢它。保持联系。; )</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/03/20/es6-in-depth-modules/" itemprop="url">ES6 in Depth: Modules</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/es6/'>es6</a>, <a class='category' href='/blog/categories/module/'>module</a>, <a class='category' href='/blog/categories/shen-ru-es6/'>深入es6</a>


</div>
		<div class="date">







  


<time datetime="2016-03-20T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-03-20</time></div>

		
			<span class="comments"><a href="/blog/2016/03/20/es6-in-depth-modules/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote><p><a href="https://hacks.mozilla.org/2015/08/es6-in-depth-modules/">ES6 In Depth: Modules</a></p></blockquote>

<p>当我在2007年加入到Mozilla的JS团队时，有一笑话是经典的JS程序只有一行代码。</p>

<p>那时已经是Google Map开始的两年之后了。在此之前，最为卓越的JS代码就是表单的验证，那么你在<code>&lt;input onchange=&gt;</code>上的平均处理代码也就是一行，对的，已经足够了。</p>

<p>事情已经发生了变化。JS项目已经成长为令人惊奇的量级，同时社区中也开发了一些工具来适应规模的变化。其中一个最为基本的事情是你需要模块系统，它可以将你的工作分离到多个文件和目录中，但是它依然保证在必要时能访问其他部分，同时使得加载所有代码更为有效。所以实际上，JS已经有了模块系统，并且有几种。同时，还有些包管理工具来安装软件和复制其高层的依赖。你可能会想到ES6，它为JS带来了新的模块系统，确实有点晚了些。</p>

<p>好的，今天我们就开始来看ES6为这已经存在的系统增加了些什么功能，同时看一下可以使用它来做些什么标准和工具吧。但是首先，让我们开始查看ES6模块长什么样子吧。</p>

<h4>模块基础</h4>

<p>ES6的模块是一个包含有JS代码的模块。它没有<code>module</code>的关键字，一个模块几乎可以看成为一个脚本。这里有两个区别：</p>

<ul>
<li>ES6模块会自动启用 严格模式，即使你没有在代码中使用&#8221;use strict&#8221;</li>
<li>你可以在模块中使用<code>import</code>和<code>export</code></li>
</ul>


<p>让我们先来说一下<code>export</code>。在模块中的任何声明，默认都只会作用于此模块。如果你想在模块中的声明公开出去，也就是其它模块能使用它，你必须<em>暴露</em>这个特性(变量、函数等）。有些方式可以做到这点，最为简单的方式就是添加一个<code>export</code>的关键字。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// kittydar.js - Find the locations of all the cats in an image.</span>
</span><span class='line'><span class="c1">//(Heather Arthur wrote this library for real)</span>
</span><span class='line'><span class="c1">// (but she didn&#39;t use modules, because it was 2013)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="kd">function</span> <span class="nx">delectCats</span><span class="p">(</span><span class="nx">cavas</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">kittydar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Kittydar</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">kittydar</span><span class="p">.</span><span class="nx">detectCats</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="nx">clas</span> <span class="nx">Kittydar</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span> <span class="nx">several</span> <span class="nx">methods</span> <span class="nx">doing</span> <span class="nx">image</span> <span class="nx">processing</span> <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// This helper function isn&#39;t exported.</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">resizeCanvas</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>你可以<code>export</code>任何顶级的<code>function</code>、<code>class</code>、<code>var</code>、<code>let</code>、<code>const</code>。</p>

<p>这也就是你需要知道有关模块的所有信息。你并不需要使用IIFE或者一个回调函数。你只要正常地声明你所需要的任何事情。因此，这代码就是模块，不是脚本，所有的声明的作用域都会在此模块中，并不会在全局所有的脚本和模块是可见的。将这些声明暴露出去，会使这成为此模块对外的公开API，这就是你想要的。</p>

<p>与暴露代码不同，在模块中的代码仅仅只是普通的代码。你可以使用全局字面量，如<code>Object</code>和<code>Array</code>。如果你模块运行于浏览器中，你可以使用<code>document</code>和<code>XMLHttpRequest</code>。</p>

<p>在一个分离的文件中，我们可能导入并使用<code>detectCats()</code>函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// domo.js - Kittydar demo program</span>
</span><span class='line'>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">detectCats</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;kittydar.js&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">go</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;catpix&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">cats</span> <span class="o">=</span> <span class="nx">detectCats</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">drawRectangles</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">cats</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了从一个模块中导入多个名称，你可以编写:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">detectCats</span><span class="p">,</span> <span class="nx">Kittydar</span><span class="p">)</span> <span class="nx">from</span> <span class="s2">&quot;kittydar.js&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>当你运行一个含有<code>import</code>声明的模块时，需要导入的模块会先被加载，每个模块的代码体会根据整个依赖图进行深度遍历执行，并跳过已经执行的模块来避免循环加载。</p>

<p>这就是模块的基础内容了，这确实是十分简单的，;-)</p>

<h4>导出列表</h4>

<p>相比于在每个特性中进行导出的标记，你可以编写一个简单的列表来指出你想导出的所有名称，并放到大括号中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="p">{</span><span class="nx">detectCats</span><span class="p">,</span> <span class="nx">Kittydar</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// no export keyword required here</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">detectCats</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="kr">class</span> <span class="nx">Kittydar</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>export</code>的列表并不一定需要在文件的第一行，它可以出现在模块的顶级的任意地方。你可以拥有多个<code>export</code>列表，或者与其它的<code>export</code>混合起来用，只要保证导出的名称不超过一次就好。</p>

<h4>对导入导出重命名</h4>

<p>有时，一个导入的名称可能会与其它你同样需要使用的名称是一样的，所以ES6允许你对导入的名称进行重命名：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// suburbia.js</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Both these modules export something named `flip`.</span>
</span><span class='line'><span class="c1">// To import them both, we must rename at least one.</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">flip</span> <span class="nx">as</span> <span class="nx">flipOmelet</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;eggs.js&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">flip</span> <span class="nx">as</span> <span class="nx">flipHouse</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;real-estate.js&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>类似的，你可以对导出的名称进行重命名。有时可能会出现，你希望以不同的名称导出相同的值，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// unlicensed_nuclear_accelerator.js - media streaming without drm</span>
</span><span class='line'><span class="c1">// (not a real library, but maybe it should be)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">v1</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">v2</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">v1</span> <span class="nx">as</span> <span class="nx">streamV1</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">v2</span> <span class="nx">as</span> <span class="nx">streamV2</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">v2</span> <span class="nx">as</span> <span class="nx">streamLatestVersion</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h4>默认导出</h4>

<p>设计的新标准是能与已经存在的CommonJS和AMD模块能正常溶合，所以当你一个Node项目，并且完成命令<code>npm install lodash</code>。你的ES6代码可以从<code>lodash</code>导入单独的函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">each</span><span class="p">,</span> <span class="nx">map</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;lodash&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">each</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="nx">x</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是，你可能已经习惯看到<code>_.each</code>而不是<code>each</code>，并且你希望编写代码依然保持这方式。或者自从有 <a href="https://lodash.com/docs#_">这个</a>，你还想使用<code>_</code>作为一个函数。</p>

<p>为了做到这点，你可以稍微地调整为不同的语法：导入模块时不使用大括号：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">_</span> <span class="nx">from</span> <span class="s2">&quot;lodash&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这其实就是等价于<code>import {default as _} from "lodash"</code>。所有的CommonJS和AMD模块都会为ES6提供一个<code>default</code>的导出名称，这其实就类似于你<code>require()</code>这模块，也就是<code>exports</code>对象。</p>

<p>ES6模块被设计为可以让你导出多个事物，但在已经存在的CommonJS模块中，默认的导出是包含所有事物。例如，有名的<a href="https://github.com/Marak/colors.js">colors</a>包在我说之前并没有任何对ES6的支持。它就是一个CommonJS的集合，就像很多在npm的包一样。但是，你可以明确地告诉ES6代码需要导入的内容。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// ES6 equivalent of `var colors = require(&quot;colors/safte&quot;);`</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">colors</span> <span class="nx">from</span> <span class="s2">&quot;colors/safe&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你希望你的ES6模块有个默认的导出，那很容易。这并没有什么魔法性的操作，它就像其它的导出操作，只是将其命名为<code>"default"</code>。你可以使用我们之前提到的重命名的语法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">myObject</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">field1</span><span class="o">:</span> <span class="nx">value1</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">field2</span><span class="o">:</span> <span class="nx">value2</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span><span class="nx">myObject</span> <span class="nx">as</span> <span class="k">default</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者使用缩写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">field1</span><span class="o">:</span> <span class="nx">value1</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">field2</span><span class="o">:</span> <span class="nx">value2</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关键字<code>export default</code>后面可以接任意的值：一个函数，一个类，一个你命名的对象字面量。</p>

<h4>模块对象</h4>

<p>十分抱歉，这部分内容有些长。但是，这并不仅仅是JS特有的。因为某些原因，所有语言中的模块系统都试图做到足够的小、方便。幸运，还剩一个特性。好吧，是两个。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">cows</span> <span class="nx">from</span> <span class="s2">&quot;cows&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>当你使用<code>import *</code>时，它导入的是一个模块命名对象。它的属性是这一模块的所有导出。所以，如果&#8221;cow&#8221;模块导出有一个名为<code>moo()</code>的函数，那么在此行代码导入&#8221;cows&#8221;之后，你可以使用<code>cows.moo()</code>。</p>

<h4>聚合模块</h4>

<p>有时，主模块可能会将其它模块的包导入进来，同时会将它们又以非统一的方式导出。为了简化这一类的代码，下面有个聚合的从导入到导出的缩写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// world-foods.js - good stuff from all over</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// import &quot;sri-lanka&quot; and re-export some of its exports</span>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span><span class="nx">Tea</span><span class="p">,</span> <span class="nx">Cinnamon</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;sri-lanka&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// import &quot;equatorial-guinea&quot; and re-export some of its exports</span>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span><span class="nx">Coffee</span><span class="p">,</span> <span class="nx">Cocoa</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;equatorial-guinea&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// import &quot;singapore&quot; and export ALL of its exports</span>
</span><span class='line'><span class="kr">export</span> <span class="o">*</span> <span class="nx">from</span> <span class="s2">&quot;singapore&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>每个这些<code>export-from</code>的表达式都类似于<code>import-from</code>，只是调整为<code>export</code>。并不像导入一样，这并不会重新添加导出的绑定到主模块的作用域中。所以，如果你想在<code>world-foods.js</code>中编写代码使用<code>Tea</code>，就不要使用这一缩写。你会发现找不到这字面量。</p>

<p>如果在导出&#8221;singapore&#8221;时会与其它的导出有冲突，会产生一个错误，所以请小心使用<code>export *</code>。</p>

<p>好了，我们介绍完语法了。让我们开始些有趣的事情。</p>

<h4><code>import</code>实际上做了什么</h4>

<p>你会相信 它没什么吗？</p>

<p>好吧，你不是那么好欺骗的。好的，你会相信标准委员会几乎没有对<code>import</code>进行说明？这是好事吗？</p>

<p>ES6的模块加载的整个详情可以移步到 <a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-hostresolveimportedmodule">其实现</a>，它的实现详情可移步于 <a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-toplevelmoduleevaluationjob">详细说明</a>。</p>

<p>粗略来讲，当你告诉JS引擎在运行一个模块时，它不得不进行如下四个步骤：</p>

<ul>
<li>1、解析：读取模块资源的实现代码并检查语法错误</li>
<li>2、加载：递归地加载所有需要导入的模块，这一部分还没有标准化。</li>
<li>3、链接：对于每个加载完成的模块，会为其创建一个作用域，并将此模块声明绑定到此作用域中，包括从其它模块导入过来的事物。</li>
</ul>


<p>这就是<code>import {cake} from "paleo"</code>的部分。但是，如果&#8221;paleo&#8221;模块并没有导出任何名为&#8221;cake&#8221;的字面量，你将会得到一个错误。这是很坏的体验，因为你已经实际上运行了一些JS代码了。</p>

<ul>
<li>4、运行：最后，开始运行每个新加载的模块体。这时候，<code>import</code>的处理进程已经完成了，所以当代码执行到含有<code>import</code>声明的代码行时，没有什么会发生。</li>
</ul>


<p>看？我之前就告诉你答案是“没什么”。我对编程语言并不会撒谎。</p>

<p>但是，现在我们开始接触这模块系统的有趣部分了，这是个感觉好玩的点。因为模块系统并没有指定怎么加载模块，你可以在开始时候，找出在资源代码中所有的<code>import</code>声明。ES6的其中一个实现方式，是将所有的工作都放到编译阶段，并将所有的模块捆绑放入一个文件中，才发送给网络上。webpack这工具实际上就是这么做的。</p>

<p>这是个大的话题，因为加载脚本会花费网络的时间。当你每次获取时，你会查找其<code>import</code>的声明，时间就会成倍增长了。比较天真的加载方式是会发送多个网络请求，但通过webpack，这不仅仅是今天使用ES6模块，你会自动得到所有软件工程所要到达的运行时优点。</p>

<p>ES6模块加载的详情还是与原始计划的一样，并构建起来的。其中一个原因就是因为没有统一怎么实现此特性，所以它并不是最后的标准。我希望某人能够指出来，因为就如我们看到的，模块的加载确实需要标准化，而且打包非常有用，是不能放弃的。</p>

<h4>静态 vs 动态，或者：规则或打破规则</h4>

<p>作为动态语言，JS已经拥有其令人惊奇的静态模块系统。</p>

<ul>
<li><p>所有的<code>import</code>和<code>export</code>都只允许在模块的顶级声明，导入导出没有额外的限制条件，但你不能在函数作用域中使用。</p></li>
<li><p>所有的导出定义必须是在资源代码中存在有明确的名称。你不能通过编程来循环一个数组并导出一堆的名称。</p></li>
<li><p>模块对象是冻结的。不能通过hack的方式来操作模块对象，polyfill方式的也不行。</p></li>
<li><p>在任一模块代码运行之前，所有模块依赖必须加载完成、解析和关联上。按照要求，不允许<code>import</code>导入模块懒加载的。</p></li>
<li><p>对于<code>import</code>的错误没有任何的恢复机制。一个App可能会有上百的模块，如果有任何的加载或者关联失败，所有代码将不会运行。你不能在<code>try/catch</code>中使用<code>import</code>。（这里有个优点，因为这模块系统是静态的，所以webpack可以在编译阶段检查出可能存在的错误。）</p></li>
<li><p>在没有加载完依赖之前，不允许运行模块中的任何代码。这意味着如果依赖没有加载完成时，模块本身不知道怎么控制代码的运行。</p></li>
</ul>


<p>如果你需求是静态的话，这模块系统是十分好的。但是，有时你可能需要些hack，是不是？</p>

<p>这就是为什么你需要编程API来处理与ES6的<code>import/export</code>语法相违背的模块系统加载机制。例如，<a href="http://webpack.github.io/docs/code-splitting.html">webpack includes an API</a> 你可以使用“code splitting&#8221;，按需求对某些模块进行懒加载。这个API可以让你打破上面所提到的多数规则。</p>

<p>ES6的模块语法是十分静态的(晕，什么叫十分静态），同时它也是好的，因为这样可以缩短其编译工具的时间。但是，通过编程后的加载API，这静态的语法已经可以动态操作了。</p>

<h4>什么时候可以使用这ES6的模块？</h4>

<p>现在为了使用模块，你需要一个编译器，如 Traceur 或者 Babel。早些时候，Gaston I. Silva 有一<a href="http://shatle.github.io/blog/2015/12/16/es6-in-depth-using-es6-today-with-babel-and-broccoli/">文章</a> 来说明怎么为Web编译ES6代码。在这一文章中，Gaston 已经有一个例子是有关ES6模块的。这有个Axel Rauschmayer 编写的<a href="http://www.2ality.com/2015/04/webpack-es6.html">例子</a>，它使用Bable和webpack。</p>

<p>模块系统主要由 Dave Herman 和 Sam Tobin-Hochstadt 设计，他们为此模块系统的静态化辩护，同时为此长年与包括我在内的很多人抗争着。Jon Coppeard 实现了 Firefox 中的模块。另外的<a href="https://github.com/whatwg/loader">JS 加载器标准化</a>也正在进行中，人们所希望的在HTML中添加<code>&lt;script type=module&gt;</code>的特性也会随之而来。</p>

<p>这就是ES6。</p>

<p>这些实在是太有意思了，以致我并不想结束。也许，我们只是完成了部分的故事情节。我们可以讨论些ES6说明中零碎的特性，但它们又不能足够单独写成文章。也许，将来会对这些进行讨论。请在下周加入我们，一起对深入ES6进行个完美的总结吧。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/03/20/es6-in-depth-subclassing/" itemprop="url">ES6 in Depth: Subclassing</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/es6/'>es6</a>, <a class='category' href='/blog/categories/subclass/'>subclass</a>, <a class='category' href='/blog/categories/shen-ru-es6/'>深入es6</a>


</div>
		<div class="date">







  


<time datetime="2016-03-20T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-03-20</time></div>

		
			<span class="comments"><a href="/blog/2016/03/20/es6-in-depth-subclassing/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote><p><a href="https://hacks.mozilla.org/2015/08/es6-in-depth-subclassing/">ES6 In Depth: Subclassing</a></p></blockquote>

<p>两周之前，我们介绍了ES6中新增加的一个类的系统，它可以用来做面向对象式的创建对象。我们可以展示一下，你可以怎么使用它来编写代码，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Circle</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">radius</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">radius</span> <span class="o">=</span> <span class="nx">radius</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">Circle</span><span class="p">.</span><span class="nx">circlesMade</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">static</span> <span class="nx">draw</span><span class="p">(</span><span class="nx">circle</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">// Canvas drawing code</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">chiclesMade</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_count</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_count</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="kr">static</span> <span class="nx">set</span> <span class="nx">circlesMade</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">_count</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">area</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">get</span> <span class="nx">radius</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_radius</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">set</span> <span class="nx">radius</span><span class="p">(</span><span class="nx">radius</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Number</span><span class="p">.</span><span class="nx">isInteger</span><span class="p">(</span><span class="nx">radius</span><span class="p">))</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Circle radius must be an integer.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">_radius</span> <span class="o">=</span> <span class="nx">radius</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>很不幸的是，就如一些人指出的，这并没有体现ES6中类的其它作用。就像传统的类系统(如，C++ 或者 Java)，ES6允许继承，也就是一个类可以将另外一个作为基类，然后为自己增加更多的特性进而实现扩展。让我们更为接近这一新特性，查看其操作的可能性。</p>

<p>在我们开始讨论子类化之前，还需要花些时间来复习一下属性的继承和动态的原型链。</p>

<h4>JS的继承</h4>

<p>当我们创建一个对换昌，我们可以为其增加属性，同时它继承于其本身原型对象的属性。JS程序大大应该会很熟悉存在的<code>Object.create</code>这个API，它让我们可以简单地做到这点：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">proto</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">value</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">method</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">14</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">proto</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> <span class="c1">//4</span>
</span><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">method</span><span class="p">();</span> <span class="c1">//14</span>
</span></code></pre></td></tr></table></div></figure>


<p>接着，当我们为<code>obj</code>添加在<code>proto</code>拥有相同名称的属性时，这些<code>obj</code>属性就相当于<code>proto</code>的影子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> <span class="c1">//5</span>
</span><span class='line'><span class="nx">proto</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> <span class="c1">//4</span>
</span></code></pre></td></tr></table></div></figure>


<h4>子类化的基础</h4>

<p>这时，我们应该知道我们应该怎么通过类来处理对象创建时的原型链。再次重复一下，当我们创建一个类时，我们在类定义的内部为<code>constructor</code>方法创建一个新的函数，它可以处理所有的静态方法。我们也可以为创建好的函数增加一个包含原型属性的对象，它可以处理实例对象的方法。为了创建一个能继承所有静态属性的新类，我们不得不创建一个函数对象来继承基类的函数对象。类似的，对于实例方法，我们不得不为创建一个新的原型链上的函数，并继承于基类的原型类对象。</p>

<p>这描述有点让人迷惑，让我们来看一个例子，它会显示我们是怎么不用新语法来实现继承，接着进行些细小的扩展来让其更美观些。</p>

<p>继续我们之前例子，假设我们有一个类<code>Shape</code>，我们希望其可以子类化：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Shape</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">get</span> <span class="nx">color</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_color</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">set</span> <span class="nx">color</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">_color</span> <span class="o">=</span> <span class="nx">parseColorAsRGB</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">markChanged</span><span class="p">();</span>  <span class="c1">// repaint the canvas later</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>当我们试图编写这样的代码时，对于<code>static</code>的属性我们依然会遇到之前文章同样的问题：没有语法来改变原型链的函数定义。当你可以有一方法类如<code>Object.setPrototypeOf</code>来解决这问题时，这方法比那些直接在原型链上创建函数要显得性能更为低劣。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Circle</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// As above</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Hook up the instance properties</span>
</span><span class='line'><span class="nb">Object</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">(</span><span class="nx">Circle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Shape</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Hook up the static properties</span>
</span><span class='line'><span class="nx">Ojbect</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">(</span><span class="nx">Circle</span><span class="p">,</span> <span class="nx">Shape</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>这代码是十分丑陋的。我们增加了类的语法，可以让我们将对象的所有逻辑都封装在一个地方中，而不是像刚才的包括其它的&#8221;hooking things up(使用勾子方法提升功能)&#8221;的逻辑。Java、Ruby和其它的面向对象的语言中，都有一个方式来声明一个子类化的类，并指出来源于哪个类，所以我们也应该这样。我们使用关键字<code>extends</code>，所以我们可以编写成：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Circle</span> <span class="kr">extends</span> <span class="nx">Shape</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// As above</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>你可以在<code>extends</code>的后面添加任意的表达式，只要它是一个合法的<code>prototype</code>的原型构建器，如：</p>

<ul>
<li>其它类</li>
<li>由存在的继承框架产生的与类相似的函数</li>
<li>一个普通的函数</li>
<li>一个包含一个函数或者类的变量</li>
<li>一个对象的访问属性(obj[name])</li>
<li>一个函数调用</li>
</ul>


<p>如何你不想实例继承于<code>Object.prototype</code>，你甚至可以使用 <code>null</code>。</p>

<h4>Super 属性</h4>

<p>所以现在我们可以进行子类化，同时我们可以继承属性，可以通过我们的继承为方法创建影子方法。但是，如果你想避免这些影子方法呢？</p>

<p>想象一下我们希望为我们的<code>Circle</code>编写一个子类，它可以通过某些因素进行缩放。为了做到这点，我们可以编写下面显得不太自然的类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">ScalableCircle</span> <span class="kr">extends</span> <span class="nx">Circle</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">get</span> <span class="nx">radius</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">scalingFactor</span> <span class="o">*</span> <span class="kr">super</span><span class="p">.</span><span class="nx">radius</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">set</span> <span class="nx">raadius</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;ScalableCircle radius is constants.&quot;</span> <span class="o">+</span>
</span><span class='line'>                                   <span class="s2">&quot;Set scaling factor instead.&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Code to handle scalingFactor</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意在<code>radius</code>的getter方法中使用了<code>super.radius</code>。这个<code>super</code>的关键字可以让我们忽略自身的属性，而开始从我们的原型链中查找属性，因此也会过滤所有之前我们提到的影子方法。</p>

<p>我们可以在任意方法的函数定义中访问super属性(随便提醒，<code>super[expr]</code>也能工作)。当这些函数从原始对象中脱离出来后，super的方法访问实际上关联的是方法第一次定义的对象。这就意味着将一个方法脱离原有操作并定义到一个本地变量中，并不会改变<code>super</code>的方法访问产生的行为。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;MyObject: &quot;</span> <span class="o">+</span> <span class="kr">super</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="c1">// MyObject: [object Object]</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toString</span><span class="p">;</span>
</span><span class='line'><span class="nx">a</span><span class="p">();</span> <span class="c1">// MyObject: [object Object]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>子类化后的内置操作(基类方法的继承)</h4>

<p>另外，你们可能希望在JS语言内部编写些扩展功能。JS内部的数据结构赋予其巨大的能力，可以利用这些能力来创建新的数据类型，其也是子类化设计中的基础。JS支持你编写一个具有版本的数组。（我知道，相信我，我知道）。版本数组应该可以修改，可能提交修改，回退到之前的提交变化。有一种方式来快速的编写版本数组，就是创建<code>Array</code>的子类。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">VersionedArray</span> <span class="kr">extends</span> <span class="nb">Array</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">();</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="p">[[]];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">commit</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Save changes to history</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">slice</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">revert</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>VersionedArray</code>的实例保持有数组中的一些重要属性，它们可以说是<code>Array</code>的实例，方法包括有<code>map</code>，<code>filter</code>和<code>sort</code>。<code>Array.isArray()</code>会将其实例认为是数组，它们还可以自动地更新数组的<code>length</code>属性。再者，返回数组的函数此时会返回一个<code>VersionedArray</code>（如<code>Array.prototype.slice()</code>）！</p>

<h4>类构建器的派生</h4>

<p>你可能已经注意到了上面的例子中的<code>constructor</code>方法有<code>super()</code>。</p>

<p>在传统的类模型中，构建器是用来初始化类实例的内部状态的。每个连续的子类负责初始化状态和相关的具体子类(什么叫连续的子类？晕)。我们希望这些能起作用，所以需要子类可以通过扩展来操作相同的初始化代码。</p>

<p>为了调用基类的构建器，我们可以再次使用<code>super</code>这关键字，它是操作就是个函数。这语法只有在使用<code>extends</code>的类的<code>constructor</code>的方法中是合法的，我们可能重新编写我们形状（Shape）类。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Shape</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">_color</span> <span class="o">=</span> <span class="nx">color</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Circle</span> <span class="kr">extends</span> <span class="nx">Shape</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">color</span><span class="p">,</span> <span class="nx">radius</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">color</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">radius</span> <span class="o">=</span> <span class="nx">radius</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// As from above</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在JS中，我们通过编写构建器，来操作<code>this</code>对象、安装属性和初始化内部的状态。一般来说，当我们通过<code>new</code>调用构建器时<code>this</code>对象就创建成功了，就像是<code>Object.create()</code>会处理其构建器的<code>prototype</code>的属性。但是，有些内置操作会在不同的内部对象布局上。例如，数组在内存中的位置不同于常规的对象。因为，我们想看到子类的内置操作，我们需要让基类分配到<code>this</code>对象。如果它是内置操作，我们会得到我们想要的对象行为，如果它是普通的构建器，我们会得到期望中的默认的<code>this</code>对象。</p>

<p>可能会得到个奇怪的结论，认为<code>this</code>绑定的是子类的构建器。当我们运行到基类的构建器时，允许其指定<code>this</code>对象，但<strong>我们子类实际上并不会有<code>this</code>的值</strong>。因此，在没有调用基类构建器之前，所有访问子类构建器会导致一个<code>ReferenceError</code>错误。</p>

<p>就如之前的文章，你可以省略掉<code>contructor</code>方法，派生出来的构建器也是可能省略的，它就如你编写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">constructor</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">super</span><span class="p">(...</span><span class="nx">args</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>有时，构建器并不能作用于<code>this</code>对象。相反，它们会通过其它的方式来创建对象，并初始化，接着直接返回此对象。如果是这一情况，那就不用使用<code>super</code>了。所有的构建器都会直接返回一个对象，不依赖于其基类构建器是否调用。</p>

<h4><code>new.target</code></h4>

<p>基类指定<code>this</code>对象时会有其它怪异的效果，那就是有时基类并不知道指定哪类的对象。假设，你正在编写一个对象框架的库，你希望有个基类<code>Collection</code>，某些子类会是数组，某些子类会是映射(Map)。然后，这时你运行<code>Collection</code>构建器，你并不会被告知是创建了哪类对象。</p>

<p>因此我们在进行内置操作时，当我们运行内置的构建器，我们需要知道其原始类的<code>prototype</code>。没有原型，我们是不能创建一个对象，使其有相应的实例方法的。为了解决这<code>Collection</code>的怪异情况，我们需要增加语法来暴露其信息给JS代码。我们已经增加了一个新的<em>元属性(Meta Property)</em> <code>new.target</code>，它关联构建器，可能直接调用<code>new</code>。通过<code>new</code>调用一个函数时，<code>new.target</code>会设置到其调用的函数中。调用<code>super</code>的函数中的<code>new.target</code>会作用<code>new.target</code>的值 。</p>

<p>这很难理解，所以让我用代码来解释我说的意思吧：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">foo</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">bar</span> <span class="kr">extends</span> <span class="nx">foo</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// This is included explicitly for clarity. It is not necessary</span>
</span><span class='line'>  <span class="c1">// to get these results.</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//foo directly invoked, so new.target is foo</span>
</span><span class='line'><span class="k">new</span> <span class="nx">foo</span><span class="p">();</span> <span class="c1">// foo</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 1) bar directly invoked, so new.target is bar</span>
</span><span class='line'><span class="c1">// 2) bar invokes foo via super(), so new.target is still bar</span>
</span><span class='line'><span class="k">new</span> <span class="nx">bar</span><span class="p">();</span> <span class="c1">// bar</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们已经解决了上面<code>Collection</code>所描述的问题，因为<code>Collection</code>构建器只检查<code>new.target</code>，就可以知道其类的家族，查看其是否是内置操作。</p>

<p><code>new.target</code>在任何的函数中都是合法的，如果一个方法没有由<code>new</code>调用时，它会被设置了<code>undefined</code>。</p>

<h4>最好的两个世界(多继承)</h4>

<p>希望你已经从这新特性的头脑风暴中生还出来，十分感谢能一直走到现在。现在，让我们花点时间来讨论，这些新特性怎么解决我们的问题。很多人很直率地质疑在JS加入继承这一特性是否好的。你可能会认为继承在创建对象上并不如<a href="https://en.wikipedia.org/wiki/Composition_over_inheritance">组合</a>一般好，或者认为相比于旧式的原型链模型，这精简的新语法会减少其设计上的灵活性。不容质疑的是，混入(mixin)通过扩展的方式来分享代码从而创建对象已经成为惯用手法。同时，它还有个好的原因：它提供了简单方式来将不相关的代码放置到同一个对象中，而不需要理解这两部分不相关代码是否适合在同一继承结构中。</p>

<p>在这主题上有很多不同的激烈信仰，但是我认为这并不值得讨论。首先，对一个语言增加类的特性，并不一定要求开发人员使用。第二，也同等的重要，语言中有类这一特性并不意味着它总是解决继承问题的最好方法！实际上，部分问题使用原型链继承的方式更为合适。到今天为此，类只是为你提供了额外的工具；它并不是唯一的，也不是最为必要的。</p>

<p>如果你想继续使用混入的方式，你可以理解那些由不同事情整合继承出来的类，才能通过混入来实现继承，以保证每件事能正常进行。不幸的是，现在这方式可能会修改继承模型，这显得十分刺耳。所以，JS并不对继承多个类进行实现。不过，它还是有一混合的方式来允许在类框架中使用混入方式的。详细看一下下面的函数，它是基于众所周知的<code>extend</code>混入的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">mix</span><span class="p">(...</span><span class="nx">mixins</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">class</span> <span class="nx">Mix</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Programatically add all the methods and accessors </span>
</span><span class='line'>  <span class="c1">// of the mixins to class Mix.</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">mixin</span> <span class="nx">of</span> <span class="nx">mixins</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">copyProperties</span><span class="p">(</span><span class="nx">Mix</span><span class="p">,</span> <span class="nx">mixin</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">copyProperties</span><span class="p">(</span><span class="nx">Mix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">mixin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">Mix</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">copyProperties</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="nx">of</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="o">!==</span> <span class="s2">&quot;constructor&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span><span class="o">!==</span> <span class="s2">&quot;prototype&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="o">!==</span> <span class="s2">&quot;name&quot;</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">let</span> <span class="nx">desc</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">Object</span><span class="p">.</span><span class="nx">definProperty</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">desc</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在我们可以使用<code>mix</code>函数还创建一个组合型的超级类，通过变量mixins，我们不需要创建详细的继承关系。细想一下，当你编写一个协作编辑工具时，需要记录编辑的动作，同时需要将其内容序列化。你可以使用<code>mix</code>函数来编写一个<code>DistributedEdit</code>的类。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">DistributedEdit</span> <span class="kr">extends</span> <span class="nx">mix</span><span class="p">(</span><span class="nx">Loggable</span><span class="p">,</span> <span class="nx">Serializable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//Event methods</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这对两个世界都很好。通过这例子，可以简单地看到怎么处理使得模型可以混入多个基类：我们可以简单地将基类放到<code>mix</code>函数中，并用类进行扩展继承。</p>

<h4>当前可用性</h4>

<p>好了，我们已经谈到许多有关子类化的内置等所有新功能，但是你是否现在可能使用它呢？</p>

<p>好吧，部分吧。在主要的浏览器商家中，Chrome已经支持我们今天所讨论到大部分的内容。在严格模式中，你可以我们讨论过的所有所有事情，除了<code>Array</code>的子类化。其它内置操作也可以使用，但是<code>Array</code>会出现一些额外的问题，所以可以不奇怪地确定还没有完成。我在firefox实现此功能，并快要接近尾声了（所有除了<code>Array</code>）。可以检查一下 <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1141863">bug 1141863</a> 看到更多的信息，但是它会在几周后的日更新版本中出现。</p>

<p>再者，Edge已经支持<code>super</code>，但并不支持子类化的内置操作。Safari并不支持任何函数功能。</p>

<p>转换编译器在部分会有些不利的地方。它们可能创建类，可能使用<code>super</code>，但它们并没有一种方式来子类化内部操作，因为你需要一个引擎来支持一个类的实例能回溯到内置的操作方法(参考<code>Array.prototype.splice</code>)。</p>

<p>好了，这真是长啊。下周，Jason Orendorff 会回来并一起讨论ES6的模块系统。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/03/12/es6-in-depth-let-and-const/" itemprop="url">ES6 in Depth: Let and Const</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/const/'>const</a>, <a class='category' href='/blog/categories/es6/'>es6</a>, <a class='category' href='/blog/categories/let/'>let</a>, <a class='category' href='/blog/categories/shen-ru-es6/'>深入es6</a>


</div>
		<div class="date">







  


<time datetime="2016-03-12T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-03-12</time></div>

		
			<span class="comments"><a href="/blog/2016/03/12/es6-in-depth-let-and-const/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote><p><a href="https://hacks.mozilla.org/2015/07/es6-in-depth-let-and-const/">ES6 In Depth: let and const</a></p></blockquote>

<p>今天我要讨论的特性刚第一眼可能显得很简单，但实际上是很强大的。</p>

<p>当BrenDan Eich在1995年开始设计JS的第一个版本时，它做了很多错误的事情，这些事情还包括之后的语言发展中。例如，当你不小心错误处理<code>Date</code>和其它对象时，会自动转为<code>NaN</code>。但是，有些重要的事情他是正确的，有先见之明：对象、原型、第一类函数有词法作用域（就是函数是有作用域的）、默认是可变的。这语言基础是十分良好的，它优于大家对它的第一印象。</p>

<p>同时，Brendan 创建了个特别的设计并影响到今天的文章 &#8211; &#8211; 我认为他这决定是可以称为一个错误的。它是个小事情，十分微小的事情，你可能使用JS多年还没注意到它。但是，它是重要的，因为从这语言来看，这个错误的设计部分在今天来看，我们认为它是好的部分。</p>

<p>它不得不与变量一起处理。</p>

<h4>问题1：代码块没有作用域</h4>

<p>这问题看起来很无辜：<strong>在JS函数中进行<code>var</code>声明时，变量作用域是可以在整个函数体中的</strong>。其中，有两个方式来看到此问题引起的后果。</p>

<p>一个是在代码块中声明的变量的作用域不仅仅是在此代码块中，它会作用于整个函数。</p>

<p>你之前也许并不会注意到这点，但我担心这一点可能会你并不想看到的。让我们通过一场景来看一下这个狡猾的Bug。</p>

<p>你在某些代码中使用一个名称为<code>t</code>的变量：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function runTowerExperiment(tower, startTime) {
</span><span class='line'>  var t = startTime;
</span><span class='line'>
</span><span class='line'>  tower.on('click', function() {
</span><span class='line'>    ... code that uses t ...
</span><span class='line'>  });
</span><span class='line'>  ... more code ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>目前，每件事都工作得很好。现在，你想增加保龄球的测速功能，所以，你在内部的callback函数中增加些<code>if</code>表达式。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function runTowerExperiment(tower, startTime) {
</span><span class='line'>  var t = startTime;
</span><span class='line'>
</span><span class='line'>  tower.on('click', function() {
</span><span class='line'>    ... code that uses t ...
</span><span class='line'>    if (bowlingBall.altitude() &lt;= 0 ) {
</span><span class='line'>      var t = readTachymeter();
</span><span class='line'>      ...
</span><span class='line'>    }
</span><span class='line'>  });
</span><span class='line'>  ... more code ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>噢，你无意地增加了第二个名称为<code>t</code>的变量。现在，之前正常工作的<code>t</code>，与一个新的内部的变量<code>t</code>关联上了，替代了外部早已存在的那个变量。</p>

<p>JS中<code>var</code>的作用域类似于PS中的桶刷工具，它会从声明、向前、向后各方向得到扩展，直到它碰到函数的边界，否则一直会起作用。因此，此处目前的<code>t</code>的作用域是向后兼容的，它就是我们在开始进行函数时创建的，这称作为变量升域(hoisting)。我几乎认为，JS引擎通过一个微小的代码起重机，将每个<code>var</code>和<code>function</code>提升到函数闭域的顶部。</p>

<p>现在，升域也是有它好处的。没有这一特性，很多在全局作用域中能很好工作的完美的好的技术将不能在<a href="https://en.wikipedia.org/wiki/Immediately-invoked_function_expression">即时调用函数表达式(IIFE)</a> 使用。但与此同时，升域会导致一个恶心的Bug： 当你使用<code>t</code>去计算时可能会得到<code>NaN</code>，这时你很难去追踪到它，特别是当你的代码大于此时的小例子时。</p>

<p>添加一个新的代码块会导致之前的代码块出现意想不到的错误。它只影响到我？它是不是真的怪异？我们并不想影响到之前的结果。</p>

<p>但是，相对于<code>var</code>的第二个问题，这个问题还是小的。</p>

<h4>问题2：变量在循环中会过度地分享</h4>

<p>你可以先猜测一下，当你运行这代码时会出现什么情况。它很简单：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Hi!&quot;</span><span class="p">,</span> <span class="s2">&quot;I&#39;m a web page!&quot;</span><span class="p">,</span> <span class="s2">&quot;alert() is fun!&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">;){</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="nx">messages</span><span class="p">[</span><span class="nx">i</span><span class="p">]);;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你看了这一系列的文章，你会知道我很喜欢在例子代码中使用<code>alert()</code>。也许，你也知道<code>alert()</code>是个糟糕的API，它是同步操作的。所以，当一个警告提示窗出现时，输入事件是不会传递的。在你的JS代码、实际在你的整个UI界面基本会是暂停的，直到用户点击确定选项。</p>

<p>多数时候，你在网页中使用<code>alert()</code>是个错误的选择，我之所以使用它，是因为我只觉得<code>alert()</code>是个很好的教学工具。</p>

<p>同时，我还应该被劝说放弃所有的杂乱和坏的行为，它意味着我可以这样创造一个说话的猫：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Meow!&quot;</span><span class="p">,</span> <span class="s2">&quot;I&#39;m a taling cat!&quot;</span><span class="p">,</span> <span class="s2">&quot;callbacks are fun!&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">cat</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="nx">messages</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">},</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">1500</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是这会出错。这并不会顺序地说出三个消息，这代码猫会说出三次的&#8221;undefined&#8221;。</p>

<p>你能指出这个问题吗？</p>

<p>这问题出现在唯一的变量<code>i</code>中，它会作用于循环内部和三个延时的返回函数。但当循环完成时，<code>i</code>的值会变成3，因为<code>messages.length</code>等于3，但任一返回函数并没有被调用。</p>

<p>所以，当第一个延时函数工作时，会调用<code>cat.say(messages[i])</code>，它实际会是<code>messages[3]</code>，而这会导致出现<code>undefined</code>。</p>

<p>有很多的方法来解决这一问题，但这个是<code>var</code>的作用域规则导致的第二个问题。首先，确保代码不会有这一问题是十分好的。</p>

<h4>let 新于 var</h4>

<p>在很多时候，JS在设计上的缺陷是不能弥补的（其它语言也会设计缺陷，但JS犹为突出）。向后兼容意味着不能改变已经存在的Web中JS代码行为。甚至，标准委员会也没致力于此，认为解决这些怪异的问题就是自动插入分号(意思是注意细节？)。浏览器制作人并不想对这种破坏性的改变进行实现，因为这些改变会成为其用户的惩罚（也可能会因此失去部分用户）。</p>

<p>所以，大概十年之前，当 Brendan Eich 决定解决这问题时，那时只有一种方式来实现。</p>

<p>他添加了一个新的关键字<code>let</code>，它可以用来声明变量，就像<code>var</code>一样，但其作用域规则更好。</p>

<p>它看起来这样子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">readTachymeter</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>let</code>和<code>var</code>是不一样的。如果你只是需要在你代码中做个全局的搜索和替换，又可以在你的部分代码中进行中断（有可能是无意的），那么你可以使用怪异的<code>var</code>。但是在更多时候，在ES6中，你应该在任何地方都要停止使用<code>var</code>，而使用<code>let</code>。正因为如此，标题为“let 新于 var”。</p>

<p><code>let</code>和<code>var</code>到底有哪些不一样呢？很高兴你会提问：</p>

<ul>
<li><strong><code>let</code>变量是代码块作用域的</strong>  使用<code>let</code>来声明一个变量，其作用域只会在包含的作用域中，而不是整个函数的内部。</li>
</ul>


<p><code>let</code>也会有一定的升域情况，但是它并不是任意的。用<code>let</code>替换<code>var</code>，可以简单地解决<code>runTowerExperiment</code>例子中的问题。如果你在任何的地方都使用<code>let</code>，你将不会再遇到此类问题。</p>

<ul>
<li><p><strong>全局的<code>let</code>变量并不会成为全局对象的属性</strong> 是的，你不能通过编写<code>window.variableName</code>来访问它们。相反，它们运行在网页中的一个不可见的包含所有JS代码的块中。</p></li>
<li><p><strong>在<code>for (let x ...)</code>的每次循环中会创建新的绑定的变量<code>x</code></strong>。这会有些微小的不同的，意味着<code>for (let ...)</code>循环执行多次时，每次其内部包含一个闭包。就像之前我们的猫例子，每个闭包会得到循环的不同的一个复本，而不是每次闭包得到同一个循环变量。</p></li>
</ul>


<p>所以，对于猫这例子说，将<code>var</code>修改为<code>let</code>就可以解决之前的问题。</p>

<p>这作用于所有的三类<code>for</code>循环表达式：for-of, for-in 和老式C语言的分号方式。</p>

<ul>
<li><strong>在没有遇到<code>let</code>声明之前使用变量会出错</strong>  当控制流没有到达变量声明的代码行时，其是未初始化的。例如：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;current time:&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">);</span> <span class="c1">//ReferenceError</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">readTachymeter</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这一规则可以帮助你抓取到Bug。结果并不是<code>NaN</code>，你将会在出现问题的代码行中得到一个异常。</p>

<p>这个变量在作用域但并没有被初始化的这一区域，被称为 <em>temporal deal zone</em>(临时死区间)。我一直等待更为专业的术语来描述这事情，就像在写科幻小说一样，然而没有。</p>

<p>（性能详情：在多数情况下，（在变量查找方式中）你可以告知变量是否声明，或者不仅仅去查找相关代码。所以，JS引擎实际上并不是每次都会进行额外的检查，以确认变量是否初始化。但是，在闭包中有时是不明确的，在这些情况下，就意味着使用<code>let</code>会比<code>var</code>慢。）</p>

<p>（作用域详情：在某些编程语言中，变量的作用域开始于其声明的地方，而不是在整个闭合的代码中向后查找。标准委员会认为可以通过<code>let</code>来使用这作用域规则。如此，当<code>t</code>在<code>let t</code>的语句后面调用时，会简单得到一个引用错误，所以，它也不会关联到任一变量。它应该在闭合的作用域中关联到变量<code>t</code>上，但这方法对于闭包或者函数式的升域都是无效的，所以它实际上会被忽略掉。）</p>

<ul>
<li><strong>重复声明变量会引起语法错误</strong> 这一规则也是利于检测细小的错误。同时，它的不同点还有：当你试图将全局的<code>let</code>转化为<code>var</code>，会导致些问题，因为它曾经是个全局<code>let</code>的变量。</li>
</ul>


<p>如果你的某些脚本声明了相同的全局变量，你最好保持使用<code>var</code>。如果你试图转化为<code>let</code>时，那些第二个用到此变量的脚本会出错的。</p>

<p>或者，使用ES6的模块，但是那是之后某天的故事了。</p>

<p>（语法详情：<code>let</code>是在严格的代码模式下是保留关键它。在非严格代码模式下，为了向后兼容，你依然可以声明变量、函数和参数的名称为<code>let</code>。你可以编写<code>var let = 'q';</code>，但你最好不要这让做。同时，<code>let let;</code>也是不允许的。）</p>

<p>除了这些不一样的地方，<code>let</code>和<code>var</code>其实是一样的。它们可以通过逗号来分开声明多个变量，例如，他们也都支持解构(释构？destructuring)。</p>

<p>注意，类<code>class</code>的声明类似于<code>let</code>，而不<code>var</code>。如果你在加载的脚本中多个声明一个类<code>class</code>，在第二次时你会因为重复声明类而得到一个错误。</p>

<h4>常量(const)</h4>

<p>是的，新的东西。</p>

<p>ES6介绍了一个三方的关键字，它可以在<code>let</code>的旁边使用: <code>const</code>。</p>

<p>使用<code>const</code>声明变量类似于<code>let</code>，但不能在声明之外对它进行赋值，这会引起一个语法错误。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">MAX_CAT_SIZE_KG</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span> <span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="nx">MAX_CAT_SIZE_KG</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="c1">// SyntaxError</span>
</span><span class='line'><span class="nx">MAX_CAT_SIZE_KG</span><span class="o">++</span><span class="p">;</span> <span class="c1">// nice try, but still a SyntaxError</span>
</span></code></pre></td></tr></table></div></figure>


<p>明显够了，你不能只声明一个<code>const</code>变量而不赋值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">theFairest</span><span class="p">;</span> <span class="c1">// SyntaxError, you troublemaker</span>
</span></code></pre></td></tr></table></div></figure>


<h4>命名空间的秘密</h4>

<p><em>&#8220;命名空间是一个非常好的主意 &#8211; 让我们更多地使用它&#8221; &#8211; Tim Peters，&#8221;Python 的秘决&#8221;</em></p>

<p>在私底下，内嵌式的作用域是始终围绕编程语言的一个核心概念。自从<a href="https://en.wikipedia.org/wiki/ALGOL">ALGOL</a> 出来后一直就是这样，已经大概有57年了，但对今天来说，此结论更为正确。</p>

<p>在ES3之前，JS只有全局的任务域和函数作用域。（让我们忽略掉<code>with</code>表达式。）ES3介绍了<code>try-catch</code>的表达式，它会增加一个新类型的作用域，此作用域只用来操作异常的变量并作用于<code>catch</code>代码块。ES5通过调用<code>eval()</code>会产生一个新的作用域。ES6添加了代码块作用域，for循环作用域，新的全局<code>let</code>作用域，模块作用域，还有用来解释参数中默认参数的额外作用域。</p>

<p>所有在ES3之后添加的作用域都是必要的，它们使得JS在程序上和面向对象特性上更合理、精确、直观，就如闭包一样；同时，可以和闭包无缝协作。也许你之前并没有注意到这些作用域的规则，如果是这样，说明JS做的工作并没有困扰你。</p>

<h4>现在我能使用<code>let</code>和<code>const</code>吗？</h4>

<p>可以。为了在Web中使用它们，你不得不使用ES6的编译器，如Babel, Traceur, 或者 TypeScript。（Babel 和 Traceur 并不支持 <em>temporal deal zone</em>(临时死区间)。）</p>

<p>io.js 支持<code>let</code>和<code>const</code>，但只能在严格模式下使用，Node.js 在支持上是一样的，但参数<code>--harmony</code>也是必要的。</p>

<p>Brendan Eich 在九年前实现了Firefox中<code>let</code>的第一个版本，这一特性在其标准化进程中进行了彻底的重新设计。为了符合标准，Shu-yu Guo 更新了此实现方式，代码审核由Jeff Walden和其它人完成。</p>

<p>好了，我们展开双手来欢迎新特性。ES6史诗级的特性到现在结束了。在之前两周中，我们完成了多数人渴望在ES6看到的特性的文章。但是首先要说明，下周我们将对之前早些时间提到的新特性：super。所以，和Eric Faust 一块加入我们，深入了解ES6的子类化。</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="page2" class="next">下一页</a>
    
    <div class="center"><a href="/blog/archives">Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2019

    liu.shatle &hearts; gmail.com


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'shatleblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










</body>
</html>
