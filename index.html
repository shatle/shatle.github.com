
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Liu.Shatle</title>
	<meta name="author" content="liu.shatle &hearts; gmail.com">

	
	<meta name="description" content="4K Display No Signal 4k, mac, 显示器 2025-11-29 Comments 记录一下问题解决。 上周买了个4K的显示器，在收到试用是可以正常使用的，新显示器能收到信息，只是刷新率只能30Hz。 后来，纠结于 30HZ 的问题，期间折腾了很久，也没有解决， &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="" rel="alternate" title="Liu.Shatle" type="application/atom+xml">
	
	<link rel="canonical" href="http://shatle.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<img src="https://avatars1.githubusercontent.com/u/1129872?v=3&s=460" alt="Profile Picture" style="width: 160px;" />
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/author">Author</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
		
			<a class="github" href="https://github.com/shatle" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2025/11/29/4k-display-no-signal/" itemprop="url">4K Display No Signal</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/4k/'>4k</a>, <a class='category' href='/blog/categories/mac/'>mac</a>, <a class='category' href='/blog/categories/xian-shi-qi/'>显示器</a>


</div>
		<div class="date">







  


<time datetime="2025-11-29T00:00:00+08:00" data-updated="true" itemprop="datePublished">2025-11-29</time></div>

		
			<span class="comments"><a href="/blog/2025/11/29/4k-display-no-signal/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>记录一下问题解决。</p>

<p>上周买了个4K的显示器，在收到试用是可以正常使用的，新显示器能收到信息，只是刷新率只能30Hz。</p>

<p>后来，纠结于 30HZ 的问题，期间折腾了很久，也没有解决，最后在网上下单一条 typec 转 dp1.4 的线。目前，还没有收到。</p>

<p>但是，今天发现 4K 显示器一直提示没有信号，但能正常通电。</p>

<p><strong>所以问题是：之前能正常显示，现在能通电，但没有信号，什么问题？</strong></p>

<p>我的电脑是有集成显卡和独立显卡的 mac 笔记本电脑，所以，在尝试来回换线之后，还是未能有信号。</p>

<p>思考：是否可能是最近折腾，将默认的自动切换显卡 调整为 集成显卡。</p>

<p>结果，还真是。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 强制使用集成显卡</span>
</span><span class='line'>sudo pmset -a GPUSwitch 0
</span><span class='line'>
</span><span class='line'><span class="c"># 强制使用独立显卡</span>
</span><span class='line'>sudo pmset -a GPUSwitch 1
</span><span class='line'>
</span><span class='line'><span class="c"># 自动切换显卡</span>
</span><span class='line'>sudo pmset -a GPUSwitch 2
</span><span class='line'>
</span><span class='line'><span class="c"># 当前显卡的使用状态</span>
</span><span class='line'>pmset -g
</span><span class='line'>
</span><span class='line'>查看 gpuswitch 对应值，0 是集成显卡，1 是独立显卡，2 是自动切换
</span></code></pre></td></tr></table></div></figure>


<p>4K显示器正常有信号后，看 Mac 电脑的能耗中，有</p>

<p><img src="/images/photo/Jietu20251129-105548.jpg" alt="Jietu20251129-105548.jpg" /></p>

<p>意思是使用独立显卡之后，才能正常连接 4K 显示器，集成显示带不动。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2022/07/30/use-sqlalchemy-migrate/" itemprop="url">Use Sqlalchemy-migrate</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/sqlalchemy-migrate/'>sqlalchemy migrate</a>


</div>
		<div class="date">







  


<time datetime="2022-07-30T00:00:00+08:00" data-updated="true" itemprop="datePublished">2022-07-30</time></div>

		
			<span class="comments"><a href="/blog/2022/07/30/use-sqlalchemy-migrate/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>记录一下使用 sqlalchemy-migrate 的问题。</p>

<p>官网： https://sqlalchemy-migrate.readthedocs.io/en/latest/download.html</p>

<h2>说明</h2>

<p>在寻找 python 层面，类 rails migration 的工具，发现了 sqlalchemy-migrate。
大致看着还可以，尝试使用中。</p>

<h2>下载</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pip install sqlalchemy-migrate</span></code></pre></td></tr></table></div></figure>


<p>安装成功后，应该可以运行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>migrate help</span></code></pre></td></tr></table></div></figure>


<p>可以查看 migrate 脚本支持的功能命令。</p>

<h2>使用</h2>

<p>根据官网说明，手动尝试运行，但遇到了些问题。</p>

<h4>创建迁移项目目录</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>migrate create migration "Example project"</span></code></pre></td></tr></table></div></figure>


<p>此命令会创建一个迁移项目的文件夹 migration，里面包含有 versions 目录、manage.py、manage.cfg 文件。</p>

<h4>构建数据库的基本结构</h4>

<p>官网上，有</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python migration/manage.py version_control mysql+mysqldb://root:@localhost/activity?charset=utf8mb4 migration</span></code></pre></td></tr></table></div></figure>


<p>官网上说，这命令会在相应的数据库中增加版本控制的表 migrate_version。但在我的机器中，会出现错误</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Traceback (most recent call last):
</span><span class='line'>  File "migration/manage.py", line 2, in &lt;module&gt;
</span><span class='line'>    from migrate.versioning.shell import main
</span><span class='line'>ModuleNotFoundError: No module named 'migrate'</span></code></pre></td></tr></table></div></figure>


<p>查阅文件 migration/manage.py 文件，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env python
</span><span class='line'>from migrate.versioning.shell import main
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>    main(debug='False')</span></code></pre></td></tr></table></div></figure>


<p>报错没有正常找到 migrate 包，折腾了许久，没有找到有效的解决方案。
但本质上，migration/manage.py 文件也是使用 migrate 命令去实现迁移操作的，
所以，尝试手动使用 migrate 命令去实现数据迁移。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>migrate version_control mysql+mysqldb://root:@localhost/activity?charset=utf8mb4 migration</span></code></pre></td></tr></table></div></figure>


<p>运行上面的命令之后，查看数据库，会发现有数据表 migrate_version。</p>

<p>查看当前版本</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>migrate db_version mysql+pymysql://root:@localhost/activity?charset=utf8mb4 migration
</span><span class='line'># 0</span></code></pre></td></tr></table></div></figure>


<h4>创建迁移脚本</h4>

<p>创建迁移脚本使用 <code>script</code> 命令实现</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>migrate script "add init tables" migration</span></code></pre></td></tr></table></div></figure>


<p>命令会生成文件 <code>migration/xxx_add_init_tables.py</code> 文件，<code>xxx</code> 可以是 001 增序编号，也可以是日期时间。</p>

<p>查阅文件，有</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">migrate</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">upgrade</span><span class="p">(</span><span class="n">migrate_engine</span><span class="p">):</span>
</span><span class='line'>    <span class="c"># Upgrade operations go here. Don&#39;t create your own engine; bind</span>
</span><span class='line'>    <span class="c"># migrate_engine to your metadata</span>
</span><span class='line'>    <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">downgrade</span><span class="p">(</span><span class="n">migrate_engine</span><span class="p">):</span>
</span><span class='line'>    <span class="c"># Operations to reverse the above upgrade go here.</span>
</span><span class='line'>    <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>遇到问题：使用timestamp做为文件名前缀时，migrate包的部分版本处理有错误，建议使用普通数字。</p></blockquote>

<p>增加一个 users 表， 有代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">migrate</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>
</span><span class='line'><span class="n">meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
</span><span class='line'><span class="n">account</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;account&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">)),</span>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;passwd&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">)),</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">upgrade</span><span class="p">(</span><span class="n">migrate_engine</span><span class="p">):</span>
</span><span class='line'>    <span class="n">meta</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">migrate_engine</span>
</span><span class='line'>    <span class="n">account</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">downgrade</span><span class="p">(</span><span class="n">migrate_engine</span><span class="p">):</span>
</span><span class='line'>    <span class="n">meta</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">migrate_engine</span>
</span><span class='line'>    <span class="n">account</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>例子中，利用 sqlalchemy  构建表，并分别定义了 upgrade 、downgrade 方法。方法中，分别对 account 表进行了创建或删除。</p>

<p>代码中定义了表，需要将表落实到数据库中，运行命令</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">migrate</span> <span class="n">upgrade</span> <span class="n">mysql</span><span class="o">+</span><span class="n">pymysql</span><span class="p">:</span><span class="o">//</span><span class="n">root</span><span class="p">:</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">activity</span><span class="err">?</span><span class="n">charset</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="n">migration</span>
</span></code></pre></td></tr></table></div></figure>


<p>命令会直接在数据库创建相应的表。</p>

<p>想删除表，可以执行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">migrate</span> <span class="n">downgrade</span> <span class="n">mysql</span><span class="o">+</span><span class="n">pymysql</span><span class="p">:</span><span class="o">//</span><span class="n">root</span><span class="p">:</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">activity</span><span class="err">?</span><span class="n">charset</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="n">migration</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>0</code> 表示要回滚到的版本。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2020/04/25/xiao-cheng-xu-cai-keng-tabbar/" itemprop="url">小程序踩坑-tabbar</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/xiao-cheng-xu-tabbar/'>小程序 tabbar</a>


</div>
		<div class="date">







  


<time datetime="2020-04-25T00:00:00+08:00" data-updated="true" itemprop="datePublished">2020-04-25</time></div>

		
			<span class="comments"><a href="/blog/2020/04/25/xiao-cheng-xu-cai-keng-tabbar/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>在与后台理顺授权、登录逻辑之后，就开始小程序的页面结构开发了。</p>

<p>既然用上了 vant，所以也就直接拿来用了 https://youzan.github.io/vant-weapp/#/tabbar。</p>

<p>使用vant组件库的好处，不用自己画图标，这对于一个开发人员的我来说，很重要不用自己自己画图标啊，自己画的是神马连自己都不知道。所以，带图标库的组件库，是令我非常欢喜的。</p>

<p>tabbar的使用需要结合wx小程序的官方文档 https://developers.weixin.qq.com/miniprogram/dev/framework/ability/custom-tabbar.html</p>

<p>在 app.json 声明 tabbar</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;tabBar&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;custom&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;backgroundColor&quot;</span><span class="o">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;list&quot;</span><span class="o">:</span> <span class="p">[{</span>
</span><span class='line'>    <span class="s2">&quot;pagePath&quot;</span><span class="o">:</span> <span class="s2">&quot;pages/about/about&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="s2">&quot;关于&quot;</span>
</span><span class='line'>  <span class="p">},</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;pagePath&quot;</span><span class="o">:</span> <span class="s2">&quot;pages/home/home&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="s2">&quot;首页&quot;</span>
</span><span class='line'>  <span class="p">},</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;pagePath&quot;</span><span class="o">:</span> <span class="s2">&quot;pages/my/my&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="s2">&quot;我的&quot;</span>
</span><span class='line'>  <span class="p">}]</span>
</span><span class='line'><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>wx对自定义的tabbar有相应的介绍，在代码根目录下添加入口文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">custom</span><span class="o">-</span><span class="nx">tab</span><span class="o">-</span><span class="nx">bar</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="nx">custom</span><span class="o">-</span><span class="nx">tab</span><span class="o">-</span><span class="nx">bar</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">json</span>
</span><span class='line'><span class="nx">custom</span><span class="o">-</span><span class="nx">tab</span><span class="o">-</span><span class="nx">bar</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">wxml</span>
</span><span class='line'><span class="nx">custom</span><span class="o">-</span><span class="nx">tab</span><span class="o">-</span><span class="nx">bar</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">wxss</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要在 custom-tab-bar/index.json 中，增加 vant 依赖</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;usingComponents&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;van-tabbar&quot;</span><span class="o">:</span> <span class="s2">&quot;@vant/weapp/tabbar/index&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;van-tabbar-item&quot;</span><span class="o">:</span> <span class="s2">&quot;@vant/weapp/tabbar-item/index&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 custom-tab-bar/index.wxml 增加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">van</span><span class="o">-</span><span class="nx">tabbar</span> <span class="nx">active</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="nx">bind</span><span class="o">:</span><span class="nx">change</span><span class="o">=</span><span class="s2">&quot;onChange&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">van</span><span class="o">-</span><span class="nx">tabbar</span><span class="o">-</span><span class="nx">item</span> <span class="nx">icon</span><span class="o">=</span><span class="s2">&quot;search&quot;</span><span class="o">&gt;</span><span class="err">关于</span><span class="o">&lt;</span><span class="err">/van-tabbar-item&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">van</span><span class="o">-</span><span class="nx">tabbar</span><span class="o">-</span><span class="nx">item</span> <span class="nx">icon</span><span class="o">=</span><span class="s2">&quot;home-o&quot;</span><span class="o">&gt;</span><span class="err">首页</span><span class="o">&lt;</span><span class="err">/van-tabbar-item&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">van</span><span class="o">-</span><span class="nx">tabbar</span><span class="o">-</span><span class="nx">item</span> <span class="nx">icon</span><span class="o">=</span><span class="s2">&quot;search&quot;</span><span class="o">&gt;</span><span class="err">我的</span><span class="o">&lt;</span><span class="err">/van-tabbar-item&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/van-tabbar&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 custom-tab-bar/index.js 增加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">selected</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">list</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="s2">&quot;/pages/about/about&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;/pages/home/home&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;/pages/my/my&quot;</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">onChange</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">selected</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span> <span class="nx">selected</span> <span class="p">})</span>
</span><span class='line'>      <span class="nx">wx</span><span class="p">.</span><span class="nx">switchTab</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">selected</span><span class="p">]})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里有会问题，tabbar的激活状态是不能正常显示的。</p>

<p><strong>实际上 switchTab 切换过去时，会实例化一个 tabbar，实例化的新 tabbar 中的 selected 会默认为 0</strong>，所以会有这一问题。</p>

<p>wx 提供了 getTabbar() 方法来获取当前页面的 tabbar。所以，需要在 Page 完成初始化之后，调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// /pages/about/about</span>
</span><span class='line'><span class="nx">Page</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">onShow</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">getTabBar</span><span class="p">().</span><span class="nx">setData</span><span class="p">({</span><span class="nx">selected</span><span class="o">:</span> <span class="mi">0</span><span class="p">})</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要在每一个页面的 onShow 方法都调用一次，设置上不同的 selected 的值。但是，怎么才能自动地选择正确的 selected 的值呢？可以通过路由判断。怎么获取当前页面的路由呢？</p>

<p>注意到了 vant 示例中有代码块，帮忙解决了问题。</p>

<p>wx 可以通过 getCurrentPages() 得到 App 的页面栈。</p>

<blockquote><p>PageObject[] getCurrentPages()
获取当前页面栈。数组中第一个元素为首页，最后一个元素为当前页面。</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// custom-tab-bar/index.js </span>
</span><span class='line'><span class="c1">// 在 methods 里增加</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">init</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">getCurrentPages</span><span class="p">().</span><span class="nx">pop</span><span class="p">();</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">selected</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">item</span> <span class="o">===</span> <span class="err">`</span><span class="o">/</span><span class="nx">$</span><span class="p">{</span><span class="nx">page</span><span class="p">.</span><span class="nx">route</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span> <span class="nx">selected</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以，可以将tab页面的 onShow 中的代码调整为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">getTabBar</span><span class="p">().</span><span class="nx">init</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>即可，统一让 tabbar 的内部方法去处理 selected 的值。</p>

<p>但是，这样会有一个问题，Page 每次切换的时候，都会重新设置这个 selected 值，如果页面都自有 tabbar，能不能只设置一次呢？页面每次加载时会不会重新构建 tabbar 实例呢？</p>

<p>但是，通过日志查看，getTabBar() 中的 __wxWebviewId__ 是不变的，但奇怪的是 tabbar 中的 selected 的值是相互影响的。</p>

<p>即，切换过的 tab 页面后，三个页面只有三个 __wxWebviewId__的值，无论切换几次。但，如果从tab1切换到tab2后，在 Page => this.getTabBar().init() => this.selected 的值会是0, 而不是之前 tab2 实例化过的selected 值 1。</p>

<p>tabbar中的 __wxExparserNodeId__ 的值是三个，和 __wxWebviewId__ 是对应、固定的，难道 wx 对 tabbar 进行了 data 域的数据共享？</p>

<p>tabbar 挂载到页面上，会单独生成，不会重新生成，但会存在 data 域的数据共享。</p>

<p>另外在社区中发现，可以通过 Component 替换 Page，通过使用 Component 的 <code>pageLifetimes =&gt; show</code>方法来达到 Page 中的 <code>onShow</code> 效果。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2020/04/25/xiao-cheng-xu-zhi-cai-keng/" itemprop="url">小程序踩坑-vant</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/xiao-cheng-xu-vant/'>小程序 vant</a>


</div>
		<div class="date">







  


<time datetime="2020-04-25T00:00:00+08:00" data-updated="true" itemprop="datePublished">2020-04-25</time></div>

		
			<span class="comments"><a href="/blog/2020/04/25/xiao-cheng-xu-zhi-cai-keng/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote><p>可能会有很多坑吧，一个一个记录下来</p></blockquote>

<p>小程序出来不长时间的很久之前，做了一个“丢丢测运”的小程序，没有后端的逻辑；全部使用前端进行计算操作。
当初，纯粹地想体验一下小程序的开发过程。但当时的那个对我来说，只是简单的前端开发，没有真正使用到wx提供的任何API。</p>

<p>最近，在折腾一下小程序，记录下来踩坑的过程吧。</p>

<hr />

<p>折腾之前，跟朋友了解到，现在比较多的使用到的第三方的组件库有 <a href="https://youzan.github.io/vant-weapp">vant</a>。之前小程序使用的是官方的组件，页面相对简单，这次就使用 vant 组件。</p>

<p>好，第一坑就是来自 vant。</p>

<p>在使用wx开发工具，构建好一个小程序时候，需要安装 vant 组件库，相关参照 https://youzan.github.io/vant-weapp/#/quickstart。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* npm i @vant/weapp -S --production
</span><span class='line'>* 开发工具上构建 npm
</span><span class='line'>
</span><span class='line'>&lt;!-- 如果没有成功，尝试以下过程 --&gt;
</span><span class='line'>* npm init # 重新初始化
</span><span class='line'>* npm i @vant/weapp -S --production
</span><span class='line'>* 开发工具上构建 npm</span></code></pre></td></tr></table></div></figure>


<p>看过小程序的官网，应该知道，安装组件时建议使用 production 以减少包大小。“构建 npm”的作用是，将 node_modules 的依赖包，复制到 miniprogram_npm 目录中。（想到了什么呢，其实手动走这个流程应该也是可以的，不过我没有尝试过）</p>

<p>vant 在示例网站上，显示的使用是1.x，但实际上我安装后的版本是 0.5.x。部分组件是不存在的，node_modules下的组件目录结构也是不一样的。</p>

<p>使用指定版本安装，提示说没有找到，很尴尬。后来直接在 package.json 中指定资源的 github 链接，是能下载下来了。当时的最新版本是 v1.2.0，这是一个有坑的版本。</p>

<p>问题类似于 https://github.com/youzan/vant-weapp/issues?q=bem , 可能是团队在兼容wepy时引入的问题，由于时间关系没有去细究，社区也比较活跃，修复应该也比较快的。</p>

<p>果不其然，github然后连续出了 0.5.28 的版本，后又出了 1.2.1 的版本，修复了相关问题。</p>

<p>这，就是使用第三方组件库带来的风险。上手就遇到组件库的问题，比较打击人的动力啊。
所以，在选择引入第三方库时，需要考虑库的活跃度的问题，慎重。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2019/02/15/usage-of-mapbox/" itemprop="url">Usage of Mapbox</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/mapbox/'>mapbox</a>


</div>
		<div class="date">







  


<time datetime="2019-02-15T00:00:00+08:00" data-updated="true" itemprop="datePublished">2019-02-15</time></div>

		
			<span class="comments"><a href="/blog/2019/02/15/usage-of-mapbox/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>朋友需要帮忙，使用地图进行数据的展示。网上，不少人使用 mapbox，看了些示例与文档，手动折腾了一下，确实是强大。</p>

<p>下面将折腾的过程记录下来。</p>

<p>先说一下需求：朋友需要对某个城市的路线中的一些路线进行颜色的特殊标识，比如，广州有很多道路，需要将有包含人名的道路标识出来。另外，人名分男女，用不同颜色进行区分显示。</p>

<p>地图信息，本质是不同图层的叠加，比如地形图、卫星图、道路图等，需要显示哪些图层，勾选就可以，也可以同时显示多个图层，它们会叠加，类似ps。</p>

<p>那么，要实现需求，需要完整的广州道路图、标识的道路图。</p>

<ul>
<li>第一步，我们需要现有的广州道路的地图，一个底图。</li>
</ul>


<p>翻阅了官网，发现一个浅色系的地图 <code>mapbox://styles/mapbox/light-v9</code>，这个地图适合当背景，这样标识的道路图可以选择较亮眼的颜色。</p>

<ul>
<li>第二步，需要有标识人名道路的图层。</li>
</ul>


<p>怎么拥有这个图层呢？首先，需要理解，图层的本质是道路的数据，只要有道路的数据就可以了。</p>

<p>那么怎么有需要标识的道路数据呢？如果别人整理过，可以直接拿geo的坐标数据集。但是，一般人不会刚好想到你的需求，刚好整理了出来，刚好分享到网络上。</p>

<p>由于是自己选择的道路，所以数据需要自己整理，Mapbox 这点就很好了。地图道路的数据实际上是一系列的坐标点，Mapbox 允许你直接在地图在通过画线，来得到这些数据。也就是，可以通过直观的操作，得到geo的数值数据。</p>

<p>mapbox 有 dataset 和 tileset 的概念， dataset 就是数据集，tileset贴图集。dataset 就是用来存储标志的路线坐标数据的， 如果直接使用数值数据渲染，可以足够了。</p>

<p>在 mapbox 需要通过网络使用 dataset，需要生成相应的 tileset 才能使用。在 https://studio.mapbox.com/datasets 在查看自己的 dataset，在 https://studio.mapbox.com/tilesets 在查看自己的 tileset。</p>

<hr />

<p>那么，先看看直接使用数值数据的例子。在这个例子中，需要将 dataset 中的坐标值，手动复制到相应的代码块中，效果见 <a href="/mapbox/index.html">index.html</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&#39;utf-8&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>Display a map<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&#39;viewport&#39;</span> <span class="na">content=</span><span class="s">&#39;initial-scale=1,maximum-scale=1,user-scalable=no&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&#39;https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js&#39;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&#39;https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css&#39;</span> <span class="na">rel=</span><span class="s">&#39;stylesheet&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>    <span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">height</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">/* 外部div样式 */</span>
</span><span class='line'>    <span class="nf">#container</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">20px</span> <span class="k">auto</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">800px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">height</span><span class="o">:</span> <span class="m">400px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#map</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>      <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- 增加外部div，限制高宽 --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&#39;map&#39;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">accessToken</span> <span class="o">=</span> <span class="s1">&#39;pk.eyJ1Ijoic2hhdGxlIiwiYSI6ImNqczF4NzgxdTA3dnc0NHA4aG5sdDk3Y2gifQ.Mr3uL3avjz6PD6zkCvwxPw&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">container</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;mapbox://styles/mapbox/light-v9&#39;</span><span class="p">,</span> <span class="c1">// 这是灰色地图</span>
</span><span class='line'>      <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="mf">113.374233</span><span class="p">,</span> <span class="mf">23.137433</span><span class="p">],</span>
</span><span class='line'>      <span class="nx">zoom</span><span class="o">:</span> <span class="mi">15</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 当 map 地图加载完成后，添加图层</span>
</span><span class='line'>    <span class="c1">// 下面数据有三个特征 feature 数据， 一个是红色的路线，两个是天蓝色的路线</span>
</span><span class='line'>    <span class="c1">// 可以通过js来控制加载哪些特征数据，就可以做到区别显示了</span>
</span><span class='line'>    <span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 红色</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;redlines&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;geojson&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;data&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;FeatureCollection&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;features&#39;</span><span class="o">:</span> <span class="p">[{</span> <span class="c1">// 这里是红色 dataset </span>
</span><span class='line'>              <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#F7455D&#39;</span> <span class="c1">// red</span>
</span><span class='line'>              <span class="p">},</span>
</span><span class='line'>              <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.371858</span><span class="p">,</span> <span class="mf">23.137009</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.37309</span><span class="p">,</span> <span class="mf">23.136758</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.373807</span><span class="p">,</span> <span class="mf">23.1366</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.374053</span><span class="p">,</span> <span class="mf">23.136553</span><span class="p">]</span>
</span><span class='line'>                <span class="p">]</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>            <span class="p">}]</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// 天蓝</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;bluelines&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;geojson&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;data&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;FeatureCollection&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;features&#39;</span><span class="o">:</span> <span class="p">[{</span> <span class="c1">// 这里是天蓝 dataset </span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                    <span class="p">[</span>
</span><span class='line'>                      <span class="mf">113.37421857524919</span><span class="p">,</span>
</span><span class='line'>                      <span class="mf">23.13651914382298</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="p">...</span>
</span><span class='line'>                  <span class="p">]</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">},</span>
</span><span class='line'>              <span class="p">{</span> <span class="c1">//这里是天蓝 另外一条路线</span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                    <span class="p">[</span>
</span><span class='line'>                      <span class="mf">113.37539098241979</span><span class="p">,</span>
</span><span class='line'>                      <span class="mf">23.13607741667701</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="p">...</span>
</span><span class='line'>                  <span class="p">]</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于后期还需要区分操作显示，再次过了一下官网上的例子，有通过按钮点击，切换显示不同路线图层的方法，另外还有直接使用 tileset 进行异步请求数值数据的方法，不用复制数值数据了，效果见 <a href="/mapbox/switch.html">switch.html</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&#39;utf-8&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>Show and hide layers<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  ...
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>    <span class="nf">#menu</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>      <span class="k">z-index</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>      <span class="k">top</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">right</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">120px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">4</span><span class="p">);</span>
</span><span class='line'>      <span class="k">font-family</span><span class="o">:</span> <span class="s1">&#39;Open Sans&#39;</span><span class="o">,</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">font-size</span><span class="o">:</span> <span class="m">13px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#404040</span><span class="p">;</span>
</span><span class='line'>      <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border-bottom</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">25</span><span class="p">);</span>
</span><span class='line'>      <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nd">:last-child</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">border</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background-color</span><span class="o">:</span> <span class="m">#f8f8f8</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#404040</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nc">.active</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background-color</span><span class="o">:</span> <span class="m">#3887be</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#ffffff</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nc">.active</span><span class="nd">:hover</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background</span><span class="o">:</span> <span class="m">#3074a4</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;nav</span> <span class="na">id=</span><span class="s">&quot;menu&quot;</span><span class="nt">&gt;&lt;/nav&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">accessToken</span> <span class="o">=</span> <span class="s1">&#39;pk.eyJ1Ijoic2hhdGxlIiwiYSI6ImNqczF4NzgxdTA3dnc0NHA4aG5sdDk3Y2gifQ.Mr3uL3avjz6PD6zkCvwxPw&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">container</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;mapbox://styles/mapbox/light-v9&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">zoom</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="mf">113.374233</span><span class="p">,</span> <span class="mf">23.137433</span><span class="p">]</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addSource</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;vector&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;mapbox://shatle.cjs1z8leu4hge2xpkx5s9faxa-814td&#39;</span> <span class="c1">// 这个是 tileset 中的 Map ID</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source-layer&#39;</span><span class="o">:</span> <span class="s1">&#39;lcm-test&#39;</span><span class="p">,</span>  <span class="c1">// 这个是tileset 中的一图层名称</span>
</span><span class='line'>        <span class="s1">&#39;layout&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;visibility&#39;</span><span class="o">:</span> <span class="s1">&#39;visible&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-join&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-cap&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="s1">&#39;#ff0000&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="c1">// 同理上一个数据，构建第二个分类数据</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addSource</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;vector&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;mapbox://shatle.cjs3g5w7k01us2wmudbbgjxks-6t25j&#39;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source-layer&#39;</span><span class="o">:</span> <span class="s1">&#39;lcmtest2&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;layout&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;visibility&#39;</span><span class="o">:</span> <span class="s1">&#39;visible&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-join&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-cap&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">toggleableLayerIds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">toggleableLayerIds</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">toggleableLayerIds</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">clickedLayer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">visibility</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">visibility</span> <span class="o">===</span> <span class="s1">&#39;visible&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">map</span><span class="p">.</span><span class="nx">setLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">map</span><span class="p">.</span><span class="nx">setLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;visible&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">layers</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;menu&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">layers</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">link</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2018/01/24/think-of-interview/" itemprop="url">Think of Interview</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/interveiw/'>interveiw</a>


</div>
		<div class="date">







  


<time datetime="2018-01-24T00:00:00+08:00" data-updated="true" itemprop="datePublished">2018-01-24</time></div>

		
			<span class="comments"><a href="/blog/2018/01/24/think-of-interview/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>去年，项目组事情比较多，每个人的工作量都有些大，经常加班深夜，导致整体团队都很累，所以，急需招入小伙伴。
在之前的前端人员离职之后，增加开发人员越加紧迫。下面，整理一下面试的体会。</p>

<h4>个人总结</h4>

<p>参与的是技术面试，应试人员过来时会有一份笔试。当应试人员完成试卷时，我们才下去进行真正的面试。
我作为一个辅助的技术面试人员，主要是补充提问。</p>

<p>在面试的过程中，上级领导也给出了些不少的建议，指出改进的地方。</p>

<p><strong>个人介绍</strong></p>

<p>初期，作为技术面试，上来就会对应试人员进行题面的提问。
这里有个问题，忽略了人的基本属性。招聘进来的是人，一个需要参与团队的人，而不是简单的一个技术机器。</p>

<p>个人介绍，通常可以提前准备，也可以没有准备。但无论如何，从中都可以看出应该的基本语言表达能力。或者，如果连这准备都没有，可以看出是否重要此次的面试。</p>

<p>在应试人员的自我介绍时，只需要简单的抓住关键点，了解其基本表达能力。同时，面试人员可以快速的浏览其做题的情况，在心里有个大概的提问方向。</p>

<p><strong>笔试提问</strong></p>

<p>前端的题面，包括js/css/jQuery的基础、算法、工作常遇到的问题等。</p>

<p>js基础，可以看出应试人员在开发过程中的细心程度，但通常工作之后的应试人员表现得都不是很理想，反而是实习生在答案上表现得优异。</p>

<p>做为过来人，是知道其原因的，也很容易理解。实习生有足够的时间来准备各种面试，而还在工作的应试人员就不一样，他们需要完成正常工作中的任务。</p>

<p>需要找到一个基础很好，又有工作经验的人，也不是简单地找一个年限够长的在职人员。关键在于，应试人员是否有意识去注意使用中的细节。</p>

<p>算法，应试人员基本都不怎么样，反而是实习生会好些。前端的工作，了解需求，对接后端的接口，并实现设计人员的交互，最大限度地提升用户体验。通常来说，后端返回的数据会避免过大的数据，以便于处理，致使前端的算法机能表现弱些。</p>

<p>在编程时还是需要注意细节，比如循环与零比较都是可以作为优化的点。现在编程中，习惯使用与underscode类似的lodash进行各操作，ES6也提供了较先进的方法，但最终还是希望有优化编辑的意识。</p>

<p>其中，令我好奇的是，有些人一直使用for循环，而不去寻找更为方便的underscore/lodash工具进行数据处理，这是不是也反应出一部分人对编程没有优化/简化的想法。</p>

<p>工作中遇到的问题，比如如何避免附件缓存等，都是常见的问题。如果实在没有遇到，也是考验应试人员的一个点。但如果面试过程良好，还会话面时进行相关提问。</p>

<p>笔试提问，可以看到应试人员基技术基础好不好，还可以看到其快速理解力，及对题目回答的表达能力等。工作中，这些都是基础的。</p>

<p><strong>话面</strong></p>

<p>抛开题目，进入话面。希望看到应试人员几点：</p>

<ul>
<li><p>生活方面是否适合当前团队。</p>

<p>  应试人员是哪里人，现居住在哪里。作为一个开发人员，工作中可能会有些意料不到事情，是否可以快速反应并到场解决问题。</p>

<p>  工作肯定会有各方面的压力，通常是怎么释放的。工作之余有什么爱好，比如运动、聚会什么的，也是值得参考的。即使碰到对编程极度热爱的人员，通常也会喜欢听歌、看电影。</p>

<p>  是否结婚，有无男女朋友，对象的工作地点，这些也会对是否成功入职有一定的影响，所以也是需要考虑的。</p></li>
<li><p>技术知识点是否是团队需要的。</p>

<p>  技术知识点太多，首先会在简历上做了一层过滤，这可以过滤大部分的不是团队需要的人员。</p>

<p>  另外，出于开放的原则，会对部分未完全匹配的简介给予面试的机会，希望能够找出优秀的人员。</p>

<p>  比如，工作中只使用过 AngularJS 或 VueJS，而现有的工作需求是 React，那么也会给予机会面试。毕竟，很多框架类的东西是相通的。但，没有 React 项目经验的人员，需要注意提问其掌握框架的大致时间，了解其学习、快速上手的能力。</p>

<p>  如果掌握需求匹配的技术，还需要深入的了解技术细节，实践过程中遇到的问题和解决方法。</p></li>
<li><p>理解问题能力</p>

<p>  理解问题，可以从笔试部分了解到。遇到些应试人员，在做笔试部分时就没有读懂题目。这原因可能是一时的疏忽，但本人觉得更多的是没有相应的知识概念，这点并不可耻，毕竟每个人的知识范围都是有限的。</p>

<p>  在话面过程中，我们也会提到一些技术或者其它的问题。通常，这些问题都是根据应试人员的经历来进行提问的，也有些关联性可能较远的问题，试图去了解到应试人员对熟悉领域中的问题是否有快速的反应能力，对不熟悉领域是否有解决和求知的欲望。</p></li>
<li><p>正常沟通能力</p>

<p>  沟通能力，这是必须的，也是很重要的。</p></li>
</ul>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2018/01/17/my-coin-work-recently/" itemprop="url">My_coin_work_recently</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/coin/'>coin</a>


</div>
		<div class="date">







  


<time datetime="2018-01-17T00:00:00+08:00" data-updated="true" itemprop="datePublished">2018-01-17</time></div>

		
			<span class="comments"><a href="/blog/2018/01/17/my-coin-work-recently/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>最近的炒币</h2>

<p>最近，有同事比较热衷于炒虚拟币，都是打着区块链的技术，炒各种概念币种。</p>

<p>同事炒了国内的一个井通币，投入几千块钱，翻倍回来了，羡慕这敢行动的行为。</p>

<p>于是，自己也下载了些炒币应用，有火币、OKex、井通这三个，还有其它小的应用。</p>

<p>火币和OKex的交易应用上线美国地区的苹果商店；井通的应用没有上线苹果商店，也没有交易平台；其它只是用来跟进比较，没有使用。</p>

<p>井通币升到0.28时，我想跟进同事的脚步的，但是井通平台的充值只能通过QQ进行转账。确实比较山寨，我在联系充值客服时，没有成功，结果没有充上。结果，第二天就开始下跌了，直到今天0.06左右。</p>

<p>虽然有些庆幸没有入井通这一个坑，但是，我并不因此觉得自己多明智。我在意的是，为什么我没有进去的勇气？</p>

<p>于是上周末，我逼了自己一下，通过火币网卖了1500元的USDT币。但是，很多币币交易只能使用BTC和ETH进行交易，所以我又用USDT买了ETH，由于钱太少了，买不了多少的BTC，交易起来前面的小数点太多。</p>

<p>在买USDT之后，由于USDT的价格比国家的汇率要高很多，所以，买完之后，显示的价值已经少了100多块了。接着，交易ETH之后，手续费需要0.2%，同时当前的ETH又在下跌，整体看，少了二百多块。</p>

<p>前段时间我得到的结果时，只有新币发行时，才会有比较大的上涨幅度，类似于新股上市；发行比较久的币种上涨比较小，并且多数是在下跌的。</p>

<p>所以，<strong>只买卖新币种</strong>。</p>

<p>不幸的是，整体的币种价值在下跌，我的原始资本一直在消耗。所以，决定开始行动。</p>

<p>中午，12点有发行新币种 THETA，我晚些进场，没有赶上较低的时候，当前已经比发行价上升了30%多。我直接买进，十几分钟后，在发行价45%左右出手，换回了ETH，赚了点。</p>

<p>下午2点又有新币种LET，根据上个经验，我快手地进入效果界面，直接交易出了所有的 ETH，但是，我回头一看，当前的涨幅已经是发行价的200%以上了，不到一分钟，就这个状态了，当我意识到时，已经下跌到60%多了，价值直接扣半，后悔。</p>

<p><strong>买卖不能心急，宁愿错过，不能做错</strong></p>

<p>需要看清本质，翻两倍肯定是危险的，不可取的。三天不到，资产减过半。</p>

<p><strong>做事要勇敢，不能心急，但不要怯于尝试</strong></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/09/27/react-dnd-intro-2/" itemprop="url">React-dnd Intro-2</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/react/'>react</a>, <a class='category' href='/blog/categories/react-dnd/'>react-dnd</a>


</div>
		<div class="date">







  


<time datetime="2016-09-27T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-09-27</time></div>

		
			<span class="comments"><a href="/blog/2016/09/27/react-dnd-intro-2/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>react-dnd 简析 2</h2>

<p>上篇文章有说到场景：卡片在不同的容器之间来回拖动。下面，对上篇文章中的代码整理一下：</p>

<h4>上期代码</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// ItemTypes</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">ItemTypes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">CARD</span><span class="o">:</span> <span class="s1">&#39;Card&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Card</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">connectDragSource</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">index</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">text</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">boxId</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDragSource</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dragSource</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">isDragging</span><span class="o">:</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">isDragging</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span> <span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span> <span class="nx">Card</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragCard</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// CardBox</span>
</span><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="err">，</span><span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardBoxTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverCard</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span> <span class="o">!=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCardBox</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardBoxTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">CardBox</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DropCardBox</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Kanban</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragDropContext</span><span class="p">(</span><span class="nx">HTML5Backend</span><span class="p">)(</span><span class="nx">Kanban</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这四个文件，<code>ItemTypes.js</code>/<code>Card.js</code>/<code>CardBox.js</code>/<code>Kanban.js</code> 为基本的模型文件，样式文件应该也要有的，这里就贴了。</p>

<h4>新需求</h4>

<p>对于看板来说，不同容器间的来回拖动是必要的。同时，如果想在单个容器中上下拖动，又需要怎么实现？</p>

<p>由于上篇文章的<code>changeCard(index, newBoxId)</code>只能调整卡片的<code>boxId</code>的属性，并不能改变其同一容器中的上下位置，所以需要调整一下，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// 增加一个参数 newIndex</span>
</span><span class='line'><span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">,</span> <span class="nx">newIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">newBoxId</span> <span class="o">&amp;&amp;</span> <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">!=</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">newIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">index</span> <span class="o">!=</span> <span class="nx">newIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// newIndex 当卡片拖动到某个卡片的上面时，</span>
</span><span class='line'>    <span class="c1">// newIndex 就是此某个卡片的 index</span>
</span><span class='line'>    <span class="c1">// 将拖动的卡片 剪切到 此位置上</span>
</span><span class='line'>    <span class="c1">//</span>
</span><span class='line'>    <span class="c1">// dragCard.index ~= newIndex</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">newIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}))</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过调整 <code>index</code> 的值来达到位置上的变化。</p>

<hr />

<p>当卡片拖动到另一卡片上面时，需要获取到这一卡片的 <code>index</code> 的值，再将拖动卡片设置到新的位置上。</p>

<p>那么，需要将<code>Card</code>设置为可接受的容器<code>DropTarget</code>。</p>

<p>参考之前的<code>CardBox</code>,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragIndex</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">index</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverIndex</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Don&#39;t replace items with themselves</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">===</span> <span class="nx">hoverIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Determine rectangle on screen</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverBoundingRect</span> <span class="o">=</span> <span class="nx">findDOMNode</span><span class="p">(</span><span class="nx">component</span><span class="p">).</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get vertical middle</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverMiddleY</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Determine mouse position</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">clientOffset</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getClientOffset</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get pixels to the top</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverClientY</span> <span class="o">=</span> <span class="nx">clientOffset</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Only perform the move when the mouse has crossed half of the items height</span>
</span><span class='line'>    <span class="c1">// When dragging downwards, only move when the cursor is below 50%</span>
</span><span class='line'>    <span class="c1">// When dragging upwards, only move when the cursor is above 50%</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dragging downwards</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">&lt;</span> <span class="nx">hoverIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">hoverClientY</span> <span class="o">&lt;</span> <span class="nx">hoverMiddleY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dragging upwards</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">&gt;</span> <span class="nx">hoverIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">hoverClientY</span> <span class="o">&gt;</span> <span class="nx">hoverMiddleY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Time to actually perform the action</span>
</span><span class='line'>    <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">dragIndex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">hoverIndex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Note: we&#39;re mutating the monitor item here!</span>
</span><span class='line'>    <span class="c1">// Generally it&#39;s better to avoid mutations,</span>
</span><span class='line'>    <span class="c1">// but it&#39;s good here for the sake of performance</span>
</span><span class='line'>    <span class="c1">// to avoid expensive index searches.</span>
</span><span class='line'>    <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">hoverIndex</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上参考官方的例子，通过 <code>component</code>来获取纵向属性，来准确得到 <code>newIndex</code> 参数。
当拖动的高度没有达到卡片一半时，不会触发<code>changeCard(..)</code>方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCard</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">Card</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>dropCollect</code> 基本是一样的。</p>

<p>那么，完成这点之后，<code>Card</code>是可拖动的，又是可以容器，
所以，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Card</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">isDragging</span><span class="p">,</span> <span class="nx">connectDragSource</span><span class="p">,</span> <span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">opacity</span> <span class="o">=</span> <span class="nx">isDragging</span> <span class="o">?</span> <span class="mf">0.5</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span>
</span><span class='line'>        <span class="nx">style</span><span class="o">=</span><span class="p">{</span> <span class="p">{</span><span class="nx">opactiy</span><span class="o">:</span> <span class="nx">opacity</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>        <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCard</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">Card</span><span class="p">);</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span><span class="nx">DropCard</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragCard</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过最后处绑定，<code>Card</code>的<code>props</code>会多出来个值来<code>connectDragSource</code>/<code>connectDropTarget</code>。</p>

<p>在<code>Card</code>类中，根据 <code>isDragging</code>来判断设置卡片的透明度，这就是为什么之前要重新定义<code>CardSource</code>中的<code>isDragging</code>方法的缘由。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为，当一个拖动卡片的<code>index</code>为<code>1</code>时，<code>dnd</code>默认会其标识为<code>isDragging=true</code>。而，拖动卡片到<code>index=0</code>时，由于<code>changeCard</code>，拖动卡片此时会从<code>1 -&gt; 0</code>，由于<code>isDdragging</code>不会重新判断，所以，显示效果会是：</p>

<blockquote><p>哪个卡片占原拖动卡片的位置，就会是有透明度</p></blockquote>

<p>但这并不是我们所要的，所以，是否能拖动，使用唯一标识<code>id</code>来判断。</p>

<p>还要注意，<code>Kanban</code>中需要传入方法给<code>Card</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//...</span>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>      <span class="c1">//...</span>
</span><span class='line'>      <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>     <span class="o">/&gt;</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="c1">//...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>最后</h4>

<p>真正使用时，还是需要定义<code>DropTarget</code>中的<code>drop</code>方法的，而文中只谈到了<code>hover</code>方法，这部分让大家自己去探索吧。</p>

<p>打完收功。</p>

<h4>后记</h4>

<p>其实，一个插件能不能用，除了了解其用法之外，还可能需要了解其性能。</p>

<p>就本人的5年前的小笔记本来说，200个普通文本卡片还是可以自由拖动的，效果还是可以的。</p>

<p>当到300时，部分快速拖动会失效，可能是排序和渲染上的耗时吧，
好点的机器可能会好点。</p>

<p>另外，从调试过程看出，<code>dnd</code>只会对有数据变化的卡片重新调用<code>render()</code>渲染方法，并不是所有都会重新渲染一遍的。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/09/25/react-dnd-intro/" itemprop="url">React-dnd Intro</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/react/'>react</a>, <a class='category' href='/blog/categories/react-dnd/'>react-dnd</a>


</div>
		<div class="date">







  


<time datetime="2016-09-25T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-09-25</time></div>

		
			<span class="comments"><a href="/blog/2016/09/25/react-dnd-intro/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>React-dnd 简析</h2>

<p>对于开源插件或者代码来说，我更喜欢推荐其 github 地址，而不是官网地址：</p>

<blockquote><p>https://github.com/gaearon/react-dnd</p></blockquote>

<h4>安装</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>npm install react-dnd -D
</span><span class='line'>npm install react-dnd-html5-backend -D</span></code></pre></td></tr></table></div></figure>


<p><code>react-dnd-html5-backend</code> 是一个必要的可选组件，因为 html5 的拖拽API 支持拖动的阴影，总的来说，这插件是必要的。</p>

<p>详细的各名称就不在此说明了，直接介绍关键点吧。</p>

<h4>基础</h4>

<p>拖拽功能，首先需要知道两个基本的部分：拖起、放下。</p>

<p>拖起，就是鼠标放下并移动的过程；放下，就是鼠标放下拖动元素。
在这一整个过程中，需要声明哪个元素是可以拖动的，哪个元素是可以接收拖动元素的。</p>

<p><code>react-dnd</code> 中，使用 <code>DragSource</code> 来声明拖动的元素，用<code>DropTarget</code>来声明接收拖动元素的容器。</p>

<p>下面将会通过 看板 的常用功能进行相关的介绍。</p>

<p>看板 基本会涉及到 卡片的上下拖动 和 卡片在不同区间的拖动。</p>

<h4>实体 Card, CardBox, Kanban</h4>

<p>为了实现基本的功能，需要拖动的实体 Card 有两个基本属性：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>id
</span><span class='line'>text // 用于显示卡片
</span><span class='line'>boxId // 用于表示容器间的拖动</span></code></pre></td></tr></table></div></figure>


<p>Card 实体的简单显示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>CardBox 容器用来接收 Card, 其属性为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">boxId</span>
</span></code></pre></td></tr></table></div></figure>


<p>显示代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>children</code> 表示显示的容器中的多个卡片。</p>

<p>最后，看板的代码就是循环了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>先用 <code>boxes</code> 进行列的划分，再通过其的<code>boxId</code>的判断，来划分 <code>cards</code>对应于哪个列中。</p>

<p>为什么这样子循环来显示卡片，而不是先进行分组，再对组进行渲染。
此处主要考虑到，只想用一个内存来存储所有的卡片。如果分组，即相当于将所有 的卡片分开为多个内存存储，本文不想让其间卡片的内存跳转频繁。</p>

<p>但这实现方法有个缺陷，页面渲染会有空元素，<code>else return ''</code> 会造成一个空的<code>span</code> DOM元素。</p>

<p>所以，注意，此处是用到了卡片的<code>index</code>的。</p>

<p>这是基本实体，它们包含关系为 <code>Kanban &gt; CardBox &gt; Card</code></p>

<h4>DragSource</h4>

<p>api</p>

<blockquote><p>DragSource(type, spec, collect)(MyComponent)</p></blockquote>

<p><code>DragSource</code>， 顾名思义，就是可拖动的元素。在本文场景中，拖动元素就是<code>Card</code>了。</p>

<p>API 中，有必要的三个参数，分别是<code>type</code>, <code>spec</code>，<code>collect</code>。</p>

<h5>type</h5>

<p><code>type</code> 就是可拖动元素的名称，这会与 <code>DropTarget</code> 的 <code>type</code> 有关联。实际中，名称就是一个字符串，
本文场景中，可以有:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">ItemTypes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">CARD</span><span class="o">:</span> <span class="s1">&#39;Card&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h5>spec</h5>

<p><code>spec</code> 拖动元素的对象，注意，它必须是对象。它定义有四个方法，分别是<code>beginDrag(props, monitor, component)</code>，
<code>endDrag(props, monitor, component)</code>，<code>canDrag(props, monitor)</code>，<code>isDragging(props, monitor)</code>，详细说明可链接到
<a href="http://gaearon.github.io/react-dnd/docs-drag-source.html">Drag Source Specification</a></p>

<p>现在，主要对 <code>beginDrag(props, monitor, component)</code> 和 <code>isDragging(props, monitor)</code> 进行说明。</p>

<p><code>beginDrag(props, monitor, component)</code> 是必须声明的，它要求返回一个普通的对象，例如<code>{ id: props.id }</code>。
其实，它就是将你用的实体，选择拖动使用的属性进行返回。</p>

<p><code>isDragging(props, monitor)</code> 是可选的，是用来判断一个元素是否是在拖动的过滤中。默认下，一个对象是否是拖动中，
dnd 只会在拖动元素的开始拖动时设置其值。为什么要在这里突出说明一下，因为在操作场景中，初始化的设置在拖动的过程中，
很可能会不正确的，所以需要重新定义其方法实现。</p>

<p>在本文场景中，可以</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">index</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">text</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">boxId</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>monitor</code> 和 <code>component</code> 还是需要大家了解一下的。
<code>monitor</code> 就是整合拖动实体和拖动状态的新对象，<code>component</code>粗略可以理解为 DOM 元素。
详情看 <a href="http://gaearon.github.io/react-dnd/docs-drag-source.html">Drag Source Specification</a></p>

<h5>collect</h5>

<p><code>collect</code> 为一个函数，而函数返回的是一个对象。本质起到桥接作用，将拖动元素的属性和拖动状态整合。</p>

<p>本文场景中，<code>collect</code> 可以为，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDragSource</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dragSource</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">isDragging</span><span class="o">:</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">isDragging</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>综合以上，需要将 <code>Card</code> 声明为可拖动的元素，就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span> <span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span> <span class="nx">Card</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>同时，需要调整<code>Card</code>类的代码，将绑定引入的属性声明关联到元素中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">connectDragSource</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>DropTarget</h4>

<p>api</p>

<blockquote><p>DropTarget(types, spec, collect)(MyComponent)</p></blockquote>

<p>就是接收拖动元素的容器元素。</p>

<h5>types</h5>

<p>注意，第一个参数是 <code>types</code>，也就是说，它可以接收多种类型，但也可以是字符串。本文场景中，就是<code>ItemTypes.CARD</code>。</p>

<h5>spec</h5>

<p>同样是普通对象，但不同于拖动元素，容器元素中的说明参数中的方法有<code>drop(props, monitor, component)</code>，<code>hover(props, monitor, component)</code>，<code>canDrop(props, monitor)</code>。</p>

<p><code>hover(props, monitor, component)</code> 这里重点说一下此方法，因为这个比较常用，当然<code>drop</code>也很常用，但主要与后台交互时才会用到。比如，不同容器中的拖动，需要将放下时的<code>boxId</code>保存到后台，而<code>hover</code>是实时变化的，不适合与后台交互的action进行数据操作。</p>

<p>在拖动元素从一个容器元素，到另一容器元素时，其的<code>boxid</code>会发生变化，这才合理。</p>

<p>所以，需要在 <code>CardBox</code> 的中定义 <code>changeCard(index, newBoxId)</code> 的方法。
其中， <code>index</code>是所有<code>cards</code>列表中的<code>index</code>。</p>

<p>本文场景中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardBoxTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverCard</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span> <span class="o">!=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h5>collect</h5>

<p>类似于<code>DropSource</code>中的<code>collect</code>, 由于是容器，则没有拖动的属性了。</p>

<p>本文场景中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>综合上面，将<code>BoxCard</code>声明为拖动容器，就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">DropCardBox</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardBoxTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">CardBox</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>同时，绑定后，需要在模型中关联渲染的元素，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>另外</h4>

<p>基本上，上面大致介绍了一个卡片在不同的容器间相互拖动的故事。</p>

<p>另外，需要指出的是，<code>react-dnd</code> 所有的元素需要使用 <code>DragDropContext</code> 来包裹起来，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">DragDropContext</span><span class="p">(</span><span class="nx">HTML5Backend</span><span class="p">)(</span><span class="nx">Kanban</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面其中有提到，卡片中容器间相互拖动，需要改变其 <code>boxId</code> 的值，
那么，需要在<code>CardBox</code>中传入<code>changeCard(index, newBoxId)</code> 方法属性。
所以，<code>Kanban</code>需要调整为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/04/23/rspec-practices-1/" itemprop="url">Rspec Practices 1</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/rspec/'>rspec</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		<div class="date">







  


<time datetime="2016-04-23T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-04-23</time></div>

		
			<span class="comments"><a href="/blog/2016/04/23/rspec-practices-1/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>U should add gem <code>rspec-rails</code> in ur project&#8217;s Gemfile, then bundle.</p>

<p>Then, u need run command <code>rails g rspec:install</code>.</p>

<p>When u use rails commands, likes <code>rails g model User xx:xx</code>. It will help u to create <code>spec/models/user_spec.rb</code> file.</p>

<p>Yes, Rspec will check <code>_spec.rb</code> file as test file.</p>

<p>Give me some codes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:model</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;signup with&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;email and password, then success.&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123@exmaple.com&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;illege email and password, then fail.&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123sdf&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;email and no password, then fail. &quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span> <span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span> <span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and then, u can use <code>rspec</code> to test all <code>_spec</code> files,
or u can only test <code>user_spec.rb</code> file with <code>rspec spec/models/user_spec.rb</code> command.</p>

<p>if no error, u can get</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">3</span> <span class="n">examples</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is not a good view. We just not work for testing, but say something to others.</p>

<p>U can run <code>rspec --format doc</code>,  will get result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span>
</span><span class='line'>  <span class="n">signup</span> <span class="n">with</span>
</span><span class='line'>    <span class="n">email</span> <span class="ow">and</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="n">success</span><span class="o">.</span>
</span><span class='line'>    <span class="n">illege</span> <span class="n">email</span> <span class="ow">and</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="nb">fail</span><span class="o">.</span>
</span><span class='line'>    <span class="n">email</span> <span class="ow">and</span> <span class="n">no</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="nb">fail</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">3</span> <span class="n">examples</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="page2" class="next">下一页</a>
    
    <div class="center"><a href="/blog/archives">Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2025

    liu.shatle &hearts; gmail.com


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'shatleblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










</body>
</html>
