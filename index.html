
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Liu.Shatle</title>
	<meta name="author" content="liu.shatle &hearts; gmail.com">

	
	<meta name="description" content="小程序踩坑-tabbar 小程序 tabbar 2020-04-25 Comments 在与后台理顺授权、登录逻辑之后，就开始小程序的页面结构开发了。 既然用上了 vant，所以也就直接拿来用了 https://youzan.github.io/vant-weapp/#/tabbar。 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="" rel="alternate" title="Liu.Shatle" type="application/atom+xml">
	
	<link rel="canonical" href="http://shatle.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<img src="https://avatars1.githubusercontent.com/u/1129872?v=3&s=460" alt="Profile Picture" style="width: 160px;" />
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/author">Author</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
		
			<a class="github" href="https://github.com/shatle" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2020/04/25/xiao-cheng-xu-cai-keng-tabbar/" itemprop="url">小程序踩坑-tabbar</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/xiao-cheng-xu-tabbar/'>小程序 tabbar</a>


</div>
		<div class="date">







  


<time datetime="2020-04-25T00:00:00+08:00" data-updated="true" itemprop="datePublished">2020-04-25</time></div>

		
			<span class="comments"><a href="/blog/2020/04/25/xiao-cheng-xu-cai-keng-tabbar/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>在与后台理顺授权、登录逻辑之后，就开始小程序的页面结构开发了。</p>

<p>既然用上了 vant，所以也就直接拿来用了 https://youzan.github.io/vant-weapp/#/tabbar。</p>

<p>使用vant组件库的好处，不用自己画图标，这对于一个开发人员的我来说，很重要不用自己自己画图标啊，自己画的是神马连自己都不知道。所以，带图标库的组件库，是令我非常欢喜的。</p>

<p>tabbar的使用需要结合wx小程序的官方文档 https://developers.weixin.qq.com/miniprogram/dev/framework/ability/custom-tabbar.html</p>

<p>在 app.json 声明 tabbar</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;tabBar&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;custom&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;backgroundColor&quot;</span><span class="o">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;list&quot;</span><span class="o">:</span> <span class="p">[{</span>
</span><span class='line'>    <span class="s2">&quot;pagePath&quot;</span><span class="o">:</span> <span class="s2">&quot;pages/about/about&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="s2">&quot;关于&quot;</span>
</span><span class='line'>  <span class="p">},</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;pagePath&quot;</span><span class="o">:</span> <span class="s2">&quot;pages/home/home&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="s2">&quot;首页&quot;</span>
</span><span class='line'>  <span class="p">},</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;pagePath&quot;</span><span class="o">:</span> <span class="s2">&quot;pages/my/my&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="s2">&quot;我的&quot;</span>
</span><span class='line'>  <span class="p">}]</span>
</span><span class='line'><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>wx对自定义的tabbar有相应的介绍，在代码根目录下添加入口文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">custom</span><span class="o">-</span><span class="nx">tab</span><span class="o">-</span><span class="nx">bar</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'><span class="nx">custom</span><span class="o">-</span><span class="nx">tab</span><span class="o">-</span><span class="nx">bar</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">json</span>
</span><span class='line'><span class="nx">custom</span><span class="o">-</span><span class="nx">tab</span><span class="o">-</span><span class="nx">bar</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">wxml</span>
</span><span class='line'><span class="nx">custom</span><span class="o">-</span><span class="nx">tab</span><span class="o">-</span><span class="nx">bar</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">wxss</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要在 custom-tab-bar/index.json 中，增加 vant 依赖</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;usingComponents&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;van-tabbar&quot;</span><span class="o">:</span> <span class="s2">&quot;@vant/weapp/tabbar/index&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;van-tabbar-item&quot;</span><span class="o">:</span> <span class="s2">&quot;@vant/weapp/tabbar-item/index&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 custom-tab-bar/index.wxml 增加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">van</span><span class="o">-</span><span class="nx">tabbar</span> <span class="nx">active</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="nx">bind</span><span class="o">:</span><span class="nx">change</span><span class="o">=</span><span class="s2">&quot;onChange&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">van</span><span class="o">-</span><span class="nx">tabbar</span><span class="o">-</span><span class="nx">item</span> <span class="nx">icon</span><span class="o">=</span><span class="s2">&quot;search&quot;</span><span class="o">&gt;</span><span class="err">关于</span><span class="o">&lt;</span><span class="err">/van-tabbar-item&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">van</span><span class="o">-</span><span class="nx">tabbar</span><span class="o">-</span><span class="nx">item</span> <span class="nx">icon</span><span class="o">=</span><span class="s2">&quot;home-o&quot;</span><span class="o">&gt;</span><span class="err">首页</span><span class="o">&lt;</span><span class="err">/van-tabbar-item&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">van</span><span class="o">-</span><span class="nx">tabbar</span><span class="o">-</span><span class="nx">item</span> <span class="nx">icon</span><span class="o">=</span><span class="s2">&quot;search&quot;</span><span class="o">&gt;</span><span class="err">我的</span><span class="o">&lt;</span><span class="err">/van-tabbar-item&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/van-tabbar&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 custom-tab-bar/index.js 增加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">selected</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">list</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="s2">&quot;/pages/about/about&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;/pages/home/home&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;/pages/my/my&quot;</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">onChange</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">selected</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span> <span class="nx">selected</span> <span class="p">})</span>
</span><span class='line'>      <span class="nx">wx</span><span class="p">.</span><span class="nx">switchTab</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">selected</span><span class="p">]})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里有会问题，tabbar的激活状态是不能正常显示的。</p>

<p><strong>实际上 switchTab 切换过去时，会实例化一个 tabbar，实例化的新 tabbar 中的 selected 会默认为 0</strong>，所以会有这一问题。</p>

<p>wx 提供了 getTabbar() 方法来获取当前页面的 tabbar。所以，需要在 Page 完成初始化之后，调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// /pages/about/about</span>
</span><span class='line'><span class="nx">Page</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">onShow</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">getTabBar</span><span class="p">().</span><span class="nx">setData</span><span class="p">({</span><span class="nx">selected</span><span class="o">:</span> <span class="mi">0</span><span class="p">})</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要在每一个页面的 onShow 方法都调用一次，设置上不同的 selected 的值。但是，怎么才能自动地选择正确的 selected 的值呢？可以通过路由判断。怎么获取当前页面的路由呢？</p>

<p>注意到了 vant 示例中有代码块，帮忙解决了问题。</p>

<p>wx 可以通过 getCurrentPages() 得到 App 的页面栈。</p>

<blockquote><p>PageObject[] getCurrentPages()
获取当前页面栈。数组中第一个元素为首页，最后一个元素为当前页面。</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// custom-tab-bar/index.js </span>
</span><span class='line'><span class="c1">// 在 methods 里增加</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">init</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">getCurrentPages</span><span class="p">().</span><span class="nx">pop</span><span class="p">();</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">selected</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">item</span> <span class="o">===</span> <span class="err">`</span><span class="o">/</span><span class="nx">$</span><span class="p">{</span><span class="nx">page</span><span class="p">.</span><span class="nx">route</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span> <span class="nx">selected</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以，可以将tab页面的 onShow 中的代码调整为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">getTabBar</span><span class="p">().</span><span class="nx">init</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>即可，统一让 tabbar 的内部方法去处理 selected 的值。</p>

<p>但是，这样会有一个问题，Page 每次切换的时候，都会重新设置这个 selected 值，如果页面都自有 tabbar，能不能只设置一次呢？页面每次加载时会不会重新构建 tabbar 实例呢？</p>

<p>但是，通过日志查看，getTabBar() 中的 __wxWebviewId__ 是不变的，但奇怪的是 tabbar 中的 selected 的值是相互影响的。</p>

<p>即，切换过的 tab 页面后，三个页面只有三个 __wxWebviewId__的值，无论切换几次。但，如果从tab1切换到tab2后，在 Page => this.getTabBar().init() => this.selected 的值会是0, 而不是之前 tab2 实例化过的selected 值 1。</p>

<p>tabbar中的 __wxExparserNodeId__ 的值是三个，和 __wxWebviewId__ 是对应、固定的，难道 wx 对 tabbar 进行了 data 域的数据共享？</p>

<p>tabbar 挂载到页面上，会单独生成，不会重新生成，但会存在 data 域的数据共享。</p>

<p>另外在社区中发现，可以通过 Component 替换 Page，通过使用 Component 的 <code>pageLifetimes =&gt; show</code>方法来达到 Page 中的 <code>onShow</code> 效果。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2020/04/25/xiao-cheng-xu-zhi-cai-keng/" itemprop="url">小程序踩坑-vant</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/xiao-cheng-xu-vant/'>小程序 vant</a>


</div>
		<div class="date">







  


<time datetime="2020-04-25T00:00:00+08:00" data-updated="true" itemprop="datePublished">2020-04-25</time></div>

		
			<span class="comments"><a href="/blog/2020/04/25/xiao-cheng-xu-zhi-cai-keng/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote><p>可能会有很多坑吧，一个一个记录下来</p></blockquote>

<p>小程序出来不长时间的很久之前，做了一个“丢丢测运”的小程序，没有后端的逻辑；全部使用前端进行计算操作。
当初，纯粹地想体验一下小程序的开发过程。但当时的那个对我来说，只是简单的前端开发，没有真正使用到wx提供的任何API。</p>

<p>最近，在折腾一下小程序，记录下来踩坑的过程吧。</p>

<hr />

<p>折腾之前，跟朋友了解到，现在比较多的使用到的第三方的组件库有 <a href="https://youzan.github.io/vant-weapp">vant</a>。之前小程序使用的是官方的组件，页面相对简单，这次就使用 vant 组件。</p>

<p>好，第一坑就是来自 vant。</p>

<p>在使用wx开发工具，构建好一个小程序时候，需要安装 vant 组件库，相关参照 https://youzan.github.io/vant-weapp/#/quickstart。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* npm i @vant/weapp -S --production
</span><span class='line'>* 开发工具上构建 npm
</span><span class='line'>
</span><span class='line'>&lt;!-- 如果没有成功，尝试以下过程 --&gt;
</span><span class='line'>* npm init # 重新初始化
</span><span class='line'>* npm i @vant/weapp -S --production
</span><span class='line'>* 开发工具上构建 npm</span></code></pre></td></tr></table></div></figure>


<p>看过小程序的官网，应该知道，安装组件时建议使用 production 以减少包大小。“构建 npm”的作用是，将 node_modules 的依赖包，复制到 miniprogram_npm 目录中。（想到了什么呢，其实手动走这个流程应该也是可以的，不过我没有尝试过）</p>

<p>vant 在示例网站上，显示的使用是1.x，但实际上我安装后的版本是 0.5.x。部分组件是不存在的，node_modules下的组件目录结构也是不一样的。</p>

<p>使用指定版本安装，提示说没有找到，很尴尬。后来直接在 package.json 中指定资源的 github 链接，是能下载下来了。当时的最新版本是 v1.2.0，这是一个有坑的版本。</p>

<p>问题类似于 https://github.com/youzan/vant-weapp/issues?q=bem , 可能是团队在兼容wepy时引入的问题，由于时间关系没有去细究，社区也比较活跃，修复应该也比较快的。</p>

<p>果不其然，github然后连续出了 0.5.28 的版本，后又出了 1.2.1 的版本，修复了相关问题。</p>

<p>这，就是使用第三方组件库带来的风险。上手就遇到组件库的问题，比较打击人的动力啊。
所以，在选择引入第三方库时，需要考虑库的活跃度的问题，慎重。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2019/02/15/usage-of-mapbox/" itemprop="url">Usage of Mapbox</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/mapbox/'>mapbox</a>


</div>
		<div class="date">







  


<time datetime="2019-02-15T00:00:00+08:00" data-updated="true" itemprop="datePublished">2019-02-15</time></div>

		
			<span class="comments"><a href="/blog/2019/02/15/usage-of-mapbox/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>朋友需要帮忙，使用地图进行数据的展示。网上，不少人使用 mapbox，看了些示例与文档，手动折腾了一下，确实是强大。</p>

<p>下面将折腾的过程记录下来。</p>

<p>先说一下需求：朋友需要对某个城市的路线中的一些路线进行颜色的特殊标识，比如，广州有很多道路，需要将有包含人名的道路标识出来。另外，人名分男女，用不同颜色进行区分显示。</p>

<p>地图信息，本质是不同图层的叠加，比如地形图、卫星图、道路图等，需要显示哪些图层，勾选就可以，也可以同时显示多个图层，它们会叠加，类似ps。</p>

<p>那么，要实现需求，需要完整的广州道路图、标识的道路图。</p>

<ul>
<li>第一步，我们需要现有的广州道路的地图，一个底图。</li>
</ul>


<p>翻阅了官网，发现一个浅色系的地图 <code>mapbox://styles/mapbox/light-v9</code>，这个地图适合当背景，这样标识的道路图可以选择较亮眼的颜色。</p>

<ul>
<li>第二步，需要有标识人名道路的图层。</li>
</ul>


<p>怎么拥有这个图层呢？首先，需要理解，图层的本质是道路的数据，只要有道路的数据就可以了。</p>

<p>那么怎么有需要标识的道路数据呢？如果别人整理过，可以直接拿geo的坐标数据集。但是，一般人不会刚好想到你的需求，刚好整理了出来，刚好分享到网络上。</p>

<p>由于是自己选择的道路，所以数据需要自己整理，Mapbox 这点就很好了。地图道路的数据实际上是一系列的坐标点，Mapbox 允许你直接在地图在通过画线，来得到这些数据。也就是，可以通过直观的操作，得到geo的数值数据。</p>

<p>mapbox 有 dataset 和 tileset 的概念， dataset 就是数据集，tileset贴图集。dataset 就是用来存储标志的路线坐标数据的， 如果直接使用数值数据渲染，可以足够了。</p>

<p>在 mapbox 需要通过网络使用 dataset，需要生成相应的 tileset 才能使用。在 https://studio.mapbox.com/datasets 在查看自己的 dataset，在 https://studio.mapbox.com/tilesets 在查看自己的 tileset。</p>

<hr />

<p>那么，先看看直接使用数值数据的例子。在这个例子中，需要将 dataset 中的坐标值，手动复制到相应的代码块中，效果见 <a href="/mapbox/index.html">index.html</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&#39;utf-8&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>Display a map<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&#39;viewport&#39;</span> <span class="na">content=</span><span class="s">&#39;initial-scale=1,maximum-scale=1,user-scalable=no&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&#39;https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js&#39;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&#39;https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css&#39;</span> <span class="na">rel=</span><span class="s">&#39;stylesheet&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>    <span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">height</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">/* 外部div样式 */</span>
</span><span class='line'>    <span class="nf">#container</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">20px</span> <span class="k">auto</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">800px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">height</span><span class="o">:</span> <span class="m">400px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#map</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>      <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- 增加外部div，限制高宽 --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&#39;map&#39;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">accessToken</span> <span class="o">=</span> <span class="s1">&#39;pk.eyJ1Ijoic2hhdGxlIiwiYSI6ImNqczF4NzgxdTA3dnc0NHA4aG5sdDk3Y2gifQ.Mr3uL3avjz6PD6zkCvwxPw&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">container</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;mapbox://styles/mapbox/light-v9&#39;</span><span class="p">,</span> <span class="c1">// 这是灰色地图</span>
</span><span class='line'>      <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="mf">113.374233</span><span class="p">,</span> <span class="mf">23.137433</span><span class="p">],</span>
</span><span class='line'>      <span class="nx">zoom</span><span class="o">:</span> <span class="mi">15</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 当 map 地图加载完成后，添加图层</span>
</span><span class='line'>    <span class="c1">// 下面数据有三个特征 feature 数据， 一个是红色的路线，两个是天蓝色的路线</span>
</span><span class='line'>    <span class="c1">// 可以通过js来控制加载哪些特征数据，就可以做到区别显示了</span>
</span><span class='line'>    <span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// 红色</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;redlines&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;geojson&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;data&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;FeatureCollection&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;features&#39;</span><span class="o">:</span> <span class="p">[{</span> <span class="c1">// 这里是红色 dataset </span>
</span><span class='line'>              <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#F7455D&#39;</span> <span class="c1">// red</span>
</span><span class='line'>              <span class="p">},</span>
</span><span class='line'>              <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.371858</span><span class="p">,</span> <span class="mf">23.137009</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.37309</span><span class="p">,</span> <span class="mf">23.136758</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.373807</span><span class="p">,</span> <span class="mf">23.1366</span><span class="p">],</span>
</span><span class='line'>                  <span class="p">[</span><span class="mf">113.374053</span><span class="p">,</span> <span class="mf">23.136553</span><span class="p">]</span>
</span><span class='line'>                <span class="p">]</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>            <span class="p">}]</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// 天蓝</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;bluelines&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;geojson&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;data&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;FeatureCollection&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;features&#39;</span><span class="o">:</span> <span class="p">[{</span> <span class="c1">// 这里是天蓝 dataset </span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                    <span class="p">[</span>
</span><span class='line'>                      <span class="mf">113.37421857524919</span><span class="p">,</span>
</span><span class='line'>                      <span class="mf">23.13651914382298</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="p">...</span>
</span><span class='line'>                  <span class="p">]</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">},</span>
</span><span class='line'>              <span class="p">{</span> <span class="c1">//这里是天蓝 另外一条路线</span>
</span><span class='line'>                <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;Feature&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;properties&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="s1">&#39;geometry&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                  <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;LineString&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s1">&#39;coordinates&#39;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                    <span class="p">[</span>
</span><span class='line'>                      <span class="mf">113.37539098241979</span><span class="p">,</span>
</span><span class='line'>                      <span class="mf">23.13607741667701</span>
</span><span class='line'>                    <span class="p">],</span>
</span><span class='line'>                    <span class="p">...</span>
</span><span class='line'>                  <span class="p">]</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于后期还需要区分操作显示，再次过了一下官网上的例子，有通过按钮点击，切换显示不同路线图层的方法，另外还有直接使用 tileset 进行异步请求数值数据的方法，不用复制数值数据了，效果见 <a href="/mapbox/switch.html">switch.html</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&#39;utf-8&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>Show and hide layers<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  ...
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>    <span class="nf">#menu</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
</span><span class='line'>      <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>      <span class="k">z-index</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>      <span class="k">top</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">right</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">width</span><span class="o">:</span> <span class="m">120px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">4</span><span class="p">);</span>
</span><span class='line'>      <span class="k">font-family</span><span class="o">:</span> <span class="s1">&#39;Open Sans&#39;</span><span class="o">,</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">font-size</span><span class="o">:</span> <span class="m">13px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#404040</span><span class="p">;</span>
</span><span class='line'>      <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
</span><span class='line'>      <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">padding</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>      <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'>      <span class="k">border-bottom</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">.</span><span class="m">25</span><span class="p">);</span>
</span><span class='line'>      <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nd">:last-child</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">border</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background-color</span><span class="o">:</span> <span class="m">#f8f8f8</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#404040</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nc">.active</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background-color</span><span class="o">:</span> <span class="m">#3887be</span><span class="p">;</span>
</span><span class='line'>      <span class="k">color</span><span class="o">:</span> <span class="m">#ffffff</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nf">#menu</span> <span class="nt">a</span><span class="nc">.active</span><span class="nd">:hover</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">background</span><span class="o">:</span> <span class="m">#3074a4</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;nav</span> <span class="na">id=</span><span class="s">&quot;menu&quot;</span><span class="nt">&gt;&lt;/nav&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">accessToken</span> <span class="o">=</span> <span class="s1">&#39;pk.eyJ1Ijoic2hhdGxlIiwiYSI6ImNqczF4NzgxdTA3dnc0NHA4aG5sdDk3Y2gifQ.Mr3uL3avjz6PD6zkCvwxPw&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">container</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;mapbox://styles/mapbox/light-v9&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">zoom</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="mf">113.374233</span><span class="p">,</span> <span class="mf">23.137433</span><span class="p">]</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addSource</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;vector&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;mapbox://shatle.cjs1z8leu4hge2xpkx5s9faxa-814td&#39;</span> <span class="c1">// 这个是 tileset 中的 Map ID</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source-layer&#39;</span><span class="o">:</span> <span class="s1">&#39;lcm-test&#39;</span><span class="p">,</span>  <span class="c1">// 这个是tileset 中的一图层名称</span>
</span><span class='line'>        <span class="s1">&#39;layout&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;visibility&#39;</span><span class="o">:</span> <span class="s1">&#39;visible&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-join&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-cap&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="s1">&#39;#ff0000&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="c1">// 同理上一个数据，构建第二个分类数据</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addSource</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;vector&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;mapbox://shatle.cjs3g5w7k01us2wmudbbgjxks-6t25j&#39;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source&#39;</span><span class="o">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;source-layer&#39;</span><span class="o">:</span> <span class="s1">&#39;lcmtest2&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;layout&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;visibility&#39;</span><span class="o">:</span> <span class="s1">&#39;visible&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-join&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-cap&#39;</span><span class="o">:</span> <span class="s1">&#39;round&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;paint&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;line-color&#39;</span><span class="o">:</span> <span class="s1">&#39;#00ffff&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;line-width&#39;</span><span class="o">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">toggleableLayerIds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">toggleableLayerIds</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">toggleableLayerIds</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">link</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">clickedLayer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">visibility</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">visibility</span> <span class="o">===</span> <span class="s1">&#39;visible&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">map</span><span class="p">.</span><span class="nx">setLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">map</span><span class="p">.</span><span class="nx">setLayoutProperty</span><span class="p">(</span><span class="nx">clickedLayer</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;visible&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">layers</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;menu&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">layers</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">link</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2018/01/24/think-of-interview/" itemprop="url">Think of Interview</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/interveiw/'>interveiw</a>


</div>
		<div class="date">







  


<time datetime="2018-01-24T00:00:00+08:00" data-updated="true" itemprop="datePublished">2018-01-24</time></div>

		
			<span class="comments"><a href="/blog/2018/01/24/think-of-interview/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>去年，项目组事情比较多，每个人的工作量都有些大，经常加班深夜，导致整体团队都很累，所以，急需招入小伙伴。
在之前的前端人员离职之后，增加开发人员越加紧迫。下面，整理一下面试的体会。</p>

<h4>个人总结</h4>

<p>参与的是技术面试，应试人员过来时会有一份笔试。当应试人员完成试卷时，我们才下去进行真正的面试。
我作为一个辅助的技术面试人员，主要是补充提问。</p>

<p>在面试的过程中，上级领导也给出了些不少的建议，指出改进的地方。</p>

<p><strong>个人介绍</strong></p>

<p>初期，作为技术面试，上来就会对应试人员进行题面的提问。
这里有个问题，忽略了人的基本属性。招聘进来的是人，一个需要参与团队的人，而不是简单的一个技术机器。</p>

<p>个人介绍，通常可以提前准备，也可以没有准备。但无论如何，从中都可以看出应该的基本语言表达能力。或者，如果连这准备都没有，可以看出是否重要此次的面试。</p>

<p>在应试人员的自我介绍时，只需要简单的抓住关键点，了解其基本表达能力。同时，面试人员可以快速的浏览其做题的情况，在心里有个大概的提问方向。</p>

<p><strong>笔试提问</strong></p>

<p>前端的题面，包括js/css/jQuery的基础、算法、工作常遇到的问题等。</p>

<p>js基础，可以看出应试人员在开发过程中的细心程度，但通常工作之后的应试人员表现得都不是很理想，反而是实习生在答案上表现得优异。</p>

<p>做为过来人，是知道其原因的，也很容易理解。实习生有足够的时间来准备各种面试，而还在工作的应试人员就不一样，他们需要完成正常工作中的任务。</p>

<p>需要找到一个基础很好，又有工作经验的人，也不是简单地找一个年限够长的在职人员。关键在于，应试人员是否有意识去注意使用中的细节。</p>

<p>算法，应试人员基本都不怎么样，反而是实习生会好些。前端的工作，了解需求，对接后端的接口，并实现设计人员的交互，最大限度地提升用户体验。通常来说，后端返回的数据会避免过大的数据，以便于处理，致使前端的算法机能表现弱些。</p>

<p>在编程时还是需要注意细节，比如循环与零比较都是可以作为优化的点。现在编程中，习惯使用与underscode类似的lodash进行各操作，ES6也提供了较先进的方法，但最终还是希望有优化编辑的意识。</p>

<p>其中，令我好奇的是，有些人一直使用for循环，而不去寻找更为方便的underscore/lodash工具进行数据处理，这是不是也反应出一部分人对编程没有优化/简化的想法。</p>

<p>工作中遇到的问题，比如如何避免附件缓存等，都是常见的问题。如果实在没有遇到，也是考验应试人员的一个点。但如果面试过程良好，还会话面时进行相关提问。</p>

<p>笔试提问，可以看到应试人员基技术基础好不好，还可以看到其快速理解力，及对题目回答的表达能力等。工作中，这些都是基础的。</p>

<p><strong>话面</strong></p>

<p>抛开题目，进入话面。希望看到应试人员几点：</p>

<ul>
<li><p>生活方面是否适合当前团队。</p>

<p>  应试人员是哪里人，现居住在哪里。作为一个开发人员，工作中可能会有些意料不到事情，是否可以快速反应并到场解决问题。</p>

<p>  工作肯定会有各方面的压力，通常是怎么释放的。工作之余有什么爱好，比如运动、聚会什么的，也是值得参考的。即使碰到对编程极度热爱的人员，通常也会喜欢听歌、看电影。</p>

<p>  是否结婚，有无男女朋友，对象的工作地点，这些也会对是否成功入职有一定的影响，所以也是需要考虑的。</p></li>
<li><p>技术知识点是否是团队需要的。</p>

<p>  技术知识点太多，首先会在简历上做了一层过滤，这可以过滤大部分的不是团队需要的人员。</p>

<p>  另外，出于开放的原则，会对部分未完全匹配的简介给予面试的机会，希望能够找出优秀的人员。</p>

<p>  比如，工作中只使用过 AngularJS 或 VueJS，而现有的工作需求是 React，那么也会给予机会面试。毕竟，很多框架类的东西是相通的。但，没有 React 项目经验的人员，需要注意提问其掌握框架的大致时间，了解其学习、快速上手的能力。</p>

<p>  如果掌握需求匹配的技术，还需要深入的了解技术细节，实践过程中遇到的问题和解决方法。</p></li>
<li><p>理解问题能力</p>

<p>  理解问题，可以从笔试部分了解到。遇到些应试人员，在做笔试部分时就没有读懂题目。这原因可能是一时的疏忽，但本人觉得更多的是没有相应的知识概念，这点并不可耻，毕竟每个人的知识范围都是有限的。</p>

<p>  在话面过程中，我们也会提到一些技术或者其它的问题。通常，这些问题都是根据应试人员的经历来进行提问的，也有些关联性可能较远的问题，试图去了解到应试人员对熟悉领域中的问题是否有快速的反应能力，对不熟悉领域是否有解决和求知的欲望。</p></li>
<li><p>正常沟通能力</p>

<p>  沟通能力，这是必须的，也是很重要的。</p></li>
</ul>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2018/01/17/my-coin-work-recently/" itemprop="url">My_coin_work_recently</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/coin/'>coin</a>


</div>
		<div class="date">







  


<time datetime="2018-01-17T00:00:00+08:00" data-updated="true" itemprop="datePublished">2018-01-17</time></div>

		
			<span class="comments"><a href="/blog/2018/01/17/my-coin-work-recently/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>最近的炒币</h2>

<p>最近，有同事比较热衷于炒虚拟币，都是打着区块链的技术，炒各种概念币种。</p>

<p>同事炒了国内的一个井通币，投入几千块钱，翻倍回来了，羡慕这敢行动的行为。</p>

<p>于是，自己也下载了些炒币应用，有火币、OKex、井通这三个，还有其它小的应用。</p>

<p>火币和OKex的交易应用上线美国地区的苹果商店；井通的应用没有上线苹果商店，也没有交易平台；其它只是用来跟进比较，没有使用。</p>

<p>井通币升到0.28时，我想跟进同事的脚步的，但是井通平台的充值只能通过QQ进行转账。确实比较山寨，我在联系充值客服时，没有成功，结果没有充上。结果，第二天就开始下跌了，直到今天0.06左右。</p>

<p>虽然有些庆幸没有入井通这一个坑，但是，我并不因此觉得自己多明智。我在意的是，为什么我没有进去的勇气？</p>

<p>于是上周末，我逼了自己一下，通过火币网卖了1500元的USDT币。但是，很多币币交易只能使用BTC和ETH进行交易，所以我又用USDT买了ETH，由于钱太少了，买不了多少的BTC，交易起来前面的小数点太多。</p>

<p>在买USDT之后，由于USDT的价格比国家的汇率要高很多，所以，买完之后，显示的价值已经少了100多块了。接着，交易ETH之后，手续费需要0.2%，同时当前的ETH又在下跌，整体看，少了二百多块。</p>

<p>前段时间我得到的结果时，只有新币发行时，才会有比较大的上涨幅度，类似于新股上市；发行比较久的币种上涨比较小，并且多数是在下跌的。</p>

<p>所以，<strong>只买卖新币种</strong>。</p>

<p>不幸的是，整体的币种价值在下跌，我的原始资本一直在消耗。所以，决定开始行动。</p>

<p>中午，12点有发行新币种 THETA，我晚些进场，没有赶上较低的时候，当前已经比发行价上升了30%多。我直接买进，十几分钟后，在发行价45%左右出手，换回了ETH，赚了点。</p>

<p>下午2点又有新币种LET，根据上个经验，我快手地进入效果界面，直接交易出了所有的 ETH，但是，我回头一看，当前的涨幅已经是发行价的200%以上了，不到一分钟，就这个状态了，当我意识到时，已经下跌到60%多了，价值直接扣半，后悔。</p>

<p><strong>买卖不能心急，宁愿错过，不能做错</strong></p>

<p>需要看清本质，翻两倍肯定是危险的，不可取的。三天不到，资产减过半。</p>

<p><strong>做事要勇敢，不能心急，但不要怯于尝试</strong></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/09/27/react-dnd-intro-2/" itemprop="url">React-dnd Intro-2</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/react/'>react</a>, <a class='category' href='/blog/categories/react-dnd/'>react-dnd</a>


</div>
		<div class="date">







  


<time datetime="2016-09-27T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-09-27</time></div>

		
			<span class="comments"><a href="/blog/2016/09/27/react-dnd-intro-2/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>react-dnd 简析 2</h2>

<p>上篇文章有说到场景：卡片在不同的容器之间来回拖动。下面，对上篇文章中的代码整理一下：</p>

<h4>上期代码</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// ItemTypes</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">ItemTypes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">CARD</span><span class="o">:</span> <span class="s1">&#39;Card&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Card</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">connectDragSource</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">index</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">text</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">boxId</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDragSource</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dragSource</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">isDragging</span><span class="o">:</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">isDragging</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span> <span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span> <span class="nx">Card</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragCard</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// CardBox</span>
</span><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="err">，</span><span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardBoxTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverCard</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span> <span class="o">!=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCardBox</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardBoxTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">CardBox</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DropCardBox</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Kanban</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragDropContext</span><span class="p">(</span><span class="nx">HTML5Backend</span><span class="p">)(</span><span class="nx">Kanban</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这四个文件，<code>ItemTypes.js</code>/<code>Card.js</code>/<code>CardBox.js</code>/<code>Kanban.js</code> 为基本的模型文件，样式文件应该也要有的，这里就贴了。</p>

<h4>新需求</h4>

<p>对于看板来说，不同容器间的来回拖动是必要的。同时，如果想在单个容器中上下拖动，又需要怎么实现？</p>

<p>由于上篇文章的<code>changeCard(index, newBoxId)</code>只能调整卡片的<code>boxId</code>的属性，并不能改变其同一容器中的上下位置，所以需要调整一下，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// 增加一个参数 newIndex</span>
</span><span class='line'><span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">,</span> <span class="nx">newIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">newBoxId</span> <span class="o">&amp;&amp;</span> <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">!=</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">newIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">index</span> <span class="o">!=</span> <span class="nx">newIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// newIndex 当卡片拖动到某个卡片的上面时，</span>
</span><span class='line'>    <span class="c1">// newIndex 就是此某个卡片的 index</span>
</span><span class='line'>    <span class="c1">// 将拖动的卡片 剪切到 此位置上</span>
</span><span class='line'>    <span class="c1">//</span>
</span><span class='line'>    <span class="c1">// dragCard.index ~= newIndex</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">newIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}))</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过调整 <code>index</code> 的值来达到位置上的变化。</p>

<hr />

<p>当卡片拖动到另一卡片上面时，需要获取到这一卡片的 <code>index</code> 的值，再将拖动卡片设置到新的位置上。</p>

<p>那么，需要将<code>Card</code>设置为可接受的容器<code>DropTarget</code>。</p>

<p>参考之前的<code>CardBox</code>,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragIndex</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">index</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverIndex</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Don&#39;t replace items with themselves</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">===</span> <span class="nx">hoverIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Determine rectangle on screen</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverBoundingRect</span> <span class="o">=</span> <span class="nx">findDOMNode</span><span class="p">(</span><span class="nx">component</span><span class="p">).</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get vertical middle</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverMiddleY</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Determine mouse position</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">clientOffset</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getClientOffset</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get pixels to the top</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverClientY</span> <span class="o">=</span> <span class="nx">clientOffset</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">hoverBoundingRect</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Only perform the move when the mouse has crossed half of the items height</span>
</span><span class='line'>    <span class="c1">// When dragging downwards, only move when the cursor is below 50%</span>
</span><span class='line'>    <span class="c1">// When dragging upwards, only move when the cursor is above 50%</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dragging downwards</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">&lt;</span> <span class="nx">hoverIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">hoverClientY</span> <span class="o">&lt;</span> <span class="nx">hoverMiddleY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Dragging upwards</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragIndex</span> <span class="o">&gt;</span> <span class="nx">hoverIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">hoverClientY</span> <span class="o">&gt;</span> <span class="nx">hoverMiddleY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Time to actually perform the action</span>
</span><span class='line'>    <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">dragIndex</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">hoverIndex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Note: we&#39;re mutating the monitor item here!</span>
</span><span class='line'>    <span class="c1">// Generally it&#39;s better to avoid mutations,</span>
</span><span class='line'>    <span class="c1">// but it&#39;s good here for the sake of performance</span>
</span><span class='line'>    <span class="c1">// to avoid expensive index searches.</span>
</span><span class='line'>    <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">hoverIndex</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上参考官方的例子，通过 <code>component</code>来获取纵向属性，来准确得到 <code>newIndex</code> 参数。
当拖动的高度没有达到卡片一半时，不会触发<code>changeCard(..)</code>方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCard</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">Card</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>dropCollect</code> 基本是一样的。</p>

<p>那么，完成这点之后，<code>Card</code>是可拖动的，又是可以容器，
所以，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Card</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">isDragging</span><span class="p">,</span> <span class="nx">connectDragSource</span><span class="p">,</span> <span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">opacity</span> <span class="o">=</span> <span class="nx">isDragging</span> <span class="o">?</span> <span class="mf">0.5</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span>
</span><span class='line'>        <span class="nx">style</span><span class="o">=</span><span class="p">{</span> <span class="p">{</span><span class="nx">opactiy</span><span class="o">:</span> <span class="nx">opacity</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>        <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">cardTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">DropCard</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">Card</span><span class="p">);</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span><span class="nx">DropCard</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DragCard</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过最后处绑定，<code>Card</code>的<code>props</code>会多出来个值来<code>connectDragSource</code>/<code>connectDropTarget</code>。</p>

<p>在<code>Card</code>类中，根据 <code>isDragging</code>来判断设置卡片的透明度，这就是为什么之前要重新定义<code>CardSource</code>中的<code>isDragging</code>方法的缘由。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为，当一个拖动卡片的<code>index</code>为<code>1</code>时，<code>dnd</code>默认会其标识为<code>isDragging=true</code>。而，拖动卡片到<code>index=0</code>时，由于<code>changeCard</code>，拖动卡片此时会从<code>1 -&gt; 0</code>，由于<code>isDdragging</code>不会重新判断，所以，显示效果会是：</p>

<blockquote><p>哪个卡片占原拖动卡片的位置，就会是有透明度</p></blockquote>

<p>但这并不是我们所要的，所以，是否能拖动，使用唯一标识<code>id</code>来判断。</p>

<p>还要注意，<code>Kanban</code>中需要传入方法给<code>Card</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//...</span>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>      <span class="c1">//...</span>
</span><span class='line'>      <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>     <span class="o">/&gt;</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="c1">//...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>最后</h4>

<p>真正使用时，还是需要定义<code>DropTarget</code>中的<code>drop</code>方法的，而文中只谈到了<code>hover</code>方法，这部分让大家自己去探索吧。</p>

<p>打完收功。</p>

<h4>后记</h4>

<p>其实，一个插件能不能用，除了了解其用法之外，还可能需要了解其性能。</p>

<p>就本人的5年前的小笔记本来说，200个普通文本卡片还是可以自由拖动的，效果还是可以的。</p>

<p>当到300时，部分快速拖动会失效，可能是排序和渲染上的耗时吧，
好点的机器可能会好点。</p>

<p>另外，从调试过程看出，<code>dnd</code>只会对有数据变化的卡片重新调用<code>render()</code>渲染方法，并不是所有都会重新渲染一遍的。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/09/25/react-dnd-intro/" itemprop="url">React-dnd Intro</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/react/'>react</a>, <a class='category' href='/blog/categories/react-dnd/'>react-dnd</a>


</div>
		<div class="date">







  


<time datetime="2016-09-25T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-09-25</time></div>

		
			<span class="comments"><a href="/blog/2016/09/25/react-dnd-intro/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<h2>React-dnd 简析</h2>

<p>对于开源插件或者代码来说，我更喜欢推荐其 github 地址，而不是官网地址：</p>

<blockquote><p>https://github.com/gaearon/react-dnd</p></blockquote>

<h4>安装</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>npm install react-dnd -D
</span><span class='line'>npm install react-dnd-html5-backend -D</span></code></pre></td></tr></table></div></figure>


<p><code>react-dnd-html5-backend</code> 是一个必要的可选组件，因为 html5 的拖拽API 支持拖动的阴影，总的来说，这插件是必要的。</p>

<p>详细的各名称就不在此说明了，直接介绍关键点吧。</p>

<h4>基础</h4>

<p>拖拽功能，首先需要知道两个基本的部分：拖起、放下。</p>

<p>拖起，就是鼠标放下并移动的过程；放下，就是鼠标放下拖动元素。
在这一整个过程中，需要声明哪个元素是可以拖动的，哪个元素是可以接收拖动元素的。</p>

<p><code>react-dnd</code> 中，使用 <code>DragSource</code> 来声明拖动的元素，用<code>DropTarget</code>来声明接收拖动元素的容器。</p>

<p>下面将会通过 看板 的常用功能进行相关的介绍。</p>

<p>看板 基本会涉及到 卡片的上下拖动 和 卡片在不同区间的拖动。</p>

<h4>实体 Card, CardBox, Kanban</h4>

<p>为了实现基本的功能，需要拖动的实体 Card 有两个基本属性：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>id
</span><span class='line'>text // 用于显示卡片
</span><span class='line'>boxId // 用于表示容器间的拖动</span></code></pre></td></tr></table></div></figure>


<p>Card 实体的简单显示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>CardBox 容器用来接收 Card, 其属性为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">boxId</span>
</span></code></pre></td></tr></table></div></figure>


<p>显示代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>children</code> 表示显示的容器中的多个卡片。</p>

<p>最后，看板的代码就是循环了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>先用 <code>boxes</code> 进行列的划分，再通过其的<code>boxId</code>的判断，来划分 <code>cards</code>对应于哪个列中。</p>

<p>为什么这样子循环来显示卡片，而不是先进行分组，再对组进行渲染。
此处主要考虑到，只想用一个内存来存储所有的卡片。如果分组，即相当于将所有 的卡片分开为多个内存存储，本文不想让其间卡片的内存跳转频繁。</p>

<p>但这实现方法有个缺陷，页面渲染会有空元素，<code>else return ''</code> 会造成一个空的<code>span</code> DOM元素。</p>

<p>所以，注意，此处是用到了卡片的<code>index</code>的。</p>

<p>这是基本实体，它们包含关系为 <code>Kanban &gt; CardBox &gt; Card</code></p>

<h4>DragSource</h4>

<p>api</p>

<blockquote><p>DragSource(type, spec, collect)(MyComponent)</p></blockquote>

<p><code>DragSource</code>， 顾名思义，就是可拖动的元素。在本文场景中，拖动元素就是<code>Card</code>了。</p>

<p>API 中，有必要的三个参数，分别是<code>type</code>, <code>spec</code>，<code>collect</code>。</p>

<h5>type</h5>

<p><code>type</code> 就是可拖动元素的名称，这会与 <code>DropTarget</code> 的 <code>type</code> 有关联。实际中，名称就是一个字符串，
本文场景中，可以有:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">ItemTypes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">CARD</span><span class="o">:</span> <span class="s1">&#39;Card&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h5>spec</h5>

<p><code>spec</code> 拖动元素的对象，注意，它必须是对象。它定义有四个方法，分别是<code>beginDrag(props, monitor, component)</code>，
<code>endDrag(props, monitor, component)</code>，<code>canDrag(props, monitor)</code>，<code>isDragging(props, monitor)</code>，详细说明可链接到
<a href="http://gaearon.github.io/react-dnd/docs-drag-source.html">Drag Source Specification</a></p>

<p>现在，主要对 <code>beginDrag(props, monitor, component)</code> 和 <code>isDragging(props, monitor)</code> 进行说明。</p>

<p><code>beginDrag(props, monitor, component)</code> 是必须声明的，它要求返回一个普通的对象，例如<code>{ id: props.id }</code>。
其实，它就是将你用的实体，选择拖动使用的属性进行返回。</p>

<p><code>isDragging(props, monitor)</code> 是可选的，是用来判断一个元素是否是在拖动的过滤中。默认下，一个对象是否是拖动中，
dnd 只会在拖动元素的开始拖动时设置其值。为什么要在这里突出说明一下，因为在操作场景中，初始化的设置在拖动的过程中，
很可能会不正确的，所以需要重新定义其方法实现。</p>

<p>在本文场景中，可以</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardSource</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beginDrag</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">id</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">index</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">text</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">boxId</span><span class="o">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">isDragging</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">().</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>monitor</code> 和 <code>component</code> 还是需要大家了解一下的。
<code>monitor</code> 就是整合拖动实体和拖动状态的新对象，<code>component</code>粗略可以理解为 DOM 元素。
详情看 <a href="http://gaearon.github.io/react-dnd/docs-drag-source.html">Drag Source Specification</a></p>

<h5>collect</h5>

<p><code>collect</code> 为一个函数，而函数返回的是一个对象。本质起到桥接作用，将拖动元素的属性和拖动状态整合。</p>

<p>本文场景中，<code>collect</code> 可以为，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dragCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDragSource</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dragSource</span><span class="p">(),</span>
</span><span class='line'>    <span class="nx">isDragging</span><span class="o">:</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">isDragging</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>综合以上，需要将 <code>Card</code> 声明为可拖动的元素，就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">DragCard</span> <span class="o">=</span> <span class="nx">DragSource</span><span class="p">(</span> <span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardSource</span><span class="p">,</span> <span class="nx">dragCollect</span><span class="p">)(</span> <span class="nx">Card</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>同时，需要调整<code>Card</code>类的代码，将绑定引入的属性声明关联到元素中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">Card</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">connectDragSource</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDragSource</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span>  <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">card</span><span class="p">}</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>DropTarget</h4>

<p>api</p>

<blockquote><p>DropTarget(types, spec, collect)(MyComponent)</p></blockquote>

<p>就是接收拖动元素的容器元素。</p>

<h5>types</h5>

<p>注意，第一个参数是 <code>types</code>，也就是说，它可以接收多种类型，但也可以是字符串。本文场景中，就是<code>ItemTypes.CARD</code>。</p>

<h5>spec</h5>

<p>同样是普通对象，但不同于拖动元素，容器元素中的说明参数中的方法有<code>drop(props, monitor, component)</code>，<code>hover(props, monitor, component)</code>，<code>canDrop(props, monitor)</code>。</p>

<p><code>hover(props, monitor, component)</code> 这里重点说一下此方法，因为这个比较常用，当然<code>drop</code>也很常用，但主要与后台交互时才会用到。比如，不同容器中的拖动，需要将放下时的<code>boxId</code>保存到后台，而<code>hover</code>是实时变化的，不适合与后台交互的action进行数据操作。</p>

<p>在拖动元素从一个容器元素，到另一容器元素时，其的<code>boxid</code>会发生变化，这才合理。</p>

<p>所以，需要在 <code>CardBox</code> 的中定义 <code>changeCard(index, newBoxId)</code> 的方法。
其中， <code>index</code>是所有<code>cards</code>列表中的<code>index</code>。</p>

<p>本文场景中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">cardBoxTarget</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">hover</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">,</span> <span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">hoverCard</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">getItem</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span> <span class="o">!=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">props</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">(</span><span class="nx">hoverCard</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">props</span><span class="p">.</span><span class="nx">boxid</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h5>collect</h5>

<p>类似于<code>DropSource</code>中的<code>collect</code>, 由于是容器，则没有拖动的属性了。</p>

<p>本文场景中，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">dropCollect</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connectDropTarget</span><span class="o">:</span> <span class="nx">connect</span><span class="p">.</span><span class="nx">dropTarget</span><span class="p">()</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>综合上面，将<code>BoxCard</code>声明为拖动容器，就是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">DropCardBox</span> <span class="o">=</span> <span class="nx">DropTarget</span><span class="p">(</span><span class="nx">ItemTypes</span><span class="p">.</span><span class="nx">CARD</span><span class="p">,</span> <span class="nx">cardBoxTarget</span><span class="p">,</span> <span class="nx">dropCollect</span><span class="p">)(</span><span class="nx">CardBox</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>同时，绑定后，需要在模型中关联渲染的元素，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">CardBox</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">connectDropTarget</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">connectDropTarget</span><span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cardBox</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>另外</h4>

<p>基本上，上面大致介绍了一个卡片在不同的容器间相互拖动的故事。</p>

<p>另外，需要指出的是，<code>react-dnd</code> 所有的元素需要使用 <code>DragDropContext</code> 来包裹起来，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">DragDropContext</span><span class="p">(</span><span class="nx">HTML5Backend</span><span class="p">)(</span><span class="nx">Kanban</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面其中有提到，卡片中容器间相互拖动，需要改变其 <code>boxId</code> 的值，
那么，需要在<code>CardBox</code>中传入<code>changeCard(index, newBoxId)</code> 方法属性。
所以，<code>Kanban</code>需要调整为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">class</span> <span class="nx">Kanban</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 1&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 2&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 3&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;card 4&#39;</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">boxes</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">boxId</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">changeCard</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">newBoxId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">dragCard</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragCard</span><span class="p">){</span> <span class="k">return</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dragCard</span><span class="p">.</span><span class="nx">boxId</span> <span class="o">=</span> <span class="nx">newBoxId</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cards</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$splice</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span class='line'>          <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dragCard</span><span class="p">]</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">div</span> <span class="o">&gt;</span>
</span><span class='line'>        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">boxes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">box</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">CardBox</span>
</span><span class='line'>              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cb-&#39;</span><span class="o">+</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">changeCard</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">changeCard</span><span class="p">}</span>
</span><span class='line'>              <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">cards</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">card</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">boxId</span><span class="o">==</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">Card</span>
</span><span class='line'>                      <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c-&#39;</span><span class="o">+</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">index</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">boxid</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">boxId</span><span class="p">}</span>
</span><span class='line'>                      <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="nx">card</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span>
</span><span class='line'>                      <span class="o">/&gt;</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>               <span class="p">})}</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/CardBox&gt;</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>        <span class="p">})}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/04/23/rspec-practices-1/" itemprop="url">Rspec Practices 1</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/rspec/'>rspec</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		<div class="date">







  


<time datetime="2016-04-23T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-04-23</time></div>

		
			<span class="comments"><a href="/blog/2016/04/23/rspec-practices-1/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<p>U should add gem <code>rspec-rails</code> in ur project&#8217;s Gemfile, then bundle.</p>

<p>Then, u need run command <code>rails g rspec:install</code>.</p>

<p>When u use rails commands, likes <code>rails g model User xx:xx</code>. It will help u to create <code>spec/models/user_spec.rb</code> file.</p>

<p>Yes, Rspec will check <code>_spec.rb</code> file as test file.</p>

<p>Give me some codes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:model</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;signup with&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;email and password, then success.&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123@exmaple.com&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;illege email and password, then fail.&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123sdf&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;email and no password, then fail. &quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span> <span class="no">User</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="s2">&quot;123@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">size</span> <span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and then, u can use <code>rspec</code> to test all <code>_spec</code> files,
or u can only test <code>user_spec.rb</code> file with <code>rspec spec/models/user_spec.rb</code> command.</p>

<p>if no error, u can get</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">3</span> <span class="n">examples</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is not a good view. We just not work for testing, but say something to others.</p>

<p>U can run <code>rspec --format doc</code>,  will get result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span>
</span><span class='line'>  <span class="n">signup</span> <span class="n">with</span>
</span><span class='line'>    <span class="n">email</span> <span class="ow">and</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="n">success</span><span class="o">.</span>
</span><span class='line'>    <span class="n">illege</span> <span class="n">email</span> <span class="ow">and</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="nb">fail</span><span class="o">.</span>
</span><span class='line'>    <span class="n">email</span> <span class="ow">and</span> <span class="n">no</span> <span class="n">password</span><span class="p">,</span> <span class="k">then</span> <span class="nb">fail</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="mi">3</span> <span class="n">examples</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/03/20/es6-in-depth-the-future/" itemprop="url">ES6 in Depth: The Future</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/es6/'>es6</a>, <a class='category' href='/blog/categories/es7/'>es7</a>, <a class='category' href='/blog/categories/future/'>future</a>, <a class='category' href='/blog/categories/shen-ru-es6/'>深入es6</a>


</div>
		<div class="date">







  


<time datetime="2016-03-20T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-03-20</time></div>

		
			<span class="comments"><a href="/blog/2016/03/20/es6-in-depth-the-future/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote><p><a href="https://hacks.mozilla.org/2015/08/es6-in-depth-the-future/">ES6 In Depth: The Future</a></p></blockquote>

<p>上周的ES6模块结束了为期四个多月的ES6新特性的这一系列的文章。</p>

<p>这文章主要会包括我们之前未讨论过的众多新特性，它们就如这JS语言大厦中的衣柜和奇怪的房子都是十分有趣的，也许还会一个地下室，或者有两个。如果你没有阅读过这一系统的其它文章，可以看<a href="http://shatle.github.io/blog/categories/shen-ru-es6/">这里</a> 。这文章并不是好的开头。</p>

<p>额外提醒：之前提到的很多特性还没有得到广泛的支持。好了，让我们开始吧。</p>

<h4></h4>

<p>ES6部分特性的标准化来源于之前的其它标准过程，或者部分得到广泛的实现支持而没有标准化。</p>

<ul>
<li><strong>类型数组(Typed arrays)/ArrayBuffer/DataView</strong> 这些是WebGL标准化的一部分，但现在也会运用于其它许多地方的API，包括Canvas、网络音频API和WebRTC。无论你处理多大的二进制文件或者数值数据，都是很方便的。</li>
</ul>


<p>例如，如果你<code>Canvas</code>需要渲染内容时没有你想要的，或者你希望手动操作更为高效时，你可以自己实现它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">pixels</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span> <span class="c1">// a Uint8ClampedArray object ect</span>
</span><span class='line'><span class="c1">// ... Your code here!</span>
</span><span class='line'><span class="c1">// ... Hack n the raw bits in `pixels`</span>
</span><span class='line'><span class="c1">// ... and then write them back to th canvas;</span>
</span><span class='line'><span class="nx">context</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>在标准化过程中，类型数组(Typed arrays)包括有常见了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">方法</a>，如<code>.slice()</code>，<code>.map()</code>，<code>.filter()</code>。</p>

<ul>
<li><p><strong>Promises</strong>  仅用一个自然段来描写promise，就像是吃饭只能吃一个薯片。不用管它有多难，这甚至是什么任何意义的事情。说什么？Promise可以用来对JS进行异步编程来构建代码块。它的作用会在后面提到。比如，当你调用<code>fetch()</code>时，不像普通代码块，它会立即返回一个promise对象，其数据获取会在后台进行。当有返回值时，它会调用你的相应代码。promise优于普通的callback函数，因为它的操作链真心很好。promise有很多有趣的<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">操作</a>，通常会是第一选择，你可以简单进行错误处理而不需要做过多的学习。它们已经在浏览器支持了。如果你还不一点都不知道promise，可以查看 <a href="http://www.html5rocks.com/en/tutorials/es6/promises/">Jake Archibald 的文章</a>。</p></li>
<li><p><strong>函数在代码块的作用域中</strong> 你不应该让这情况出现，但是，你可能已经无意地存在相关代码了。</p></li>
</ul>


<p>在ES1-5中，下面的代码在技术上说是有问题的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">temperature</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">chill</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fan</span><span class="p">.</span><span class="nx">switchOn</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">obtainLemonade</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">chill</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个函数声明是在<code>if</code>代码块中的，这理念上是不允许的。函数声明只能在顶级中，或者在函数体内的最外层。</p>

<p>但是，上面代码几乎能在所有主流的浏览器中运行，从某种程度上是这样子的。</p>

<p>但又不完全一样，在每个浏览器中其处理细节有些不一样。但是，某种程度上都是可以工作的，并且很多网页还在使用它。</p>

<p>不幸的是，Firefox和Safari还没有实现新的标准。对现在来说，可以使用一个函数的表达式来替代：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">temperature</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">chill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">fan</span><span class="p">.</span><span class="nx">switchOn</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">obtainLemonade</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">chill</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>多年来，代码块作用域函数(block-scoped function)没有标准化是因为向后兼容的限制并非常复杂。没有人认为他们可以解决这一问题。ES6处理这种<a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-block-level-function-declarations-web-legacy-compatibility-semantics">奇怪规则</a>的线程只能在非严格模式中使用。我不能在这里解释，但请相信我，使用严格模式。</p>

<ul>
<li><strong>函数名称</strong> 所有的主流JS引擎都会在函数中有个非标准的<code>.name</code>属性来表示其名称。ES6对此进行了标准化，它会明智地对某些没有名称的函数推测出<code>.name</code>的属性：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">lessThan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="o">&lt;</span><span class="nx">b</span><span class="p">;}</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">lessThan</span><span class="p">.</span><span class="nx">name</span>
</span><span class='line'>    <span class="s2">&quot;lessThan&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>好事</h4>

<ul>
<li><strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign(target, &#8230;sources)</a></strong> 标准库中的新函数，类似于Underscore中的<code>.extend()</code></li>
<li><strong>函数调用中的展开操作符(spread operator，实际是省略号，翻译为展开操作符因为作用就是将数据展开为多个值)</strong>  在这里Nutella并没有做什么，尽管Nutella尝着美味。但是，它依然是个美味的特性，我认为你们会喜欢的。</li>
</ul>


<p>在之前的五月中，我们介绍了<a href="http://shatle.github.io/blog/2015/10/25/es6-in-depth-rest-parameters-and-defaults/">rest parameters</a>，这为函数提供了一个可能接收任意数量的参数方式，它比那随意、笨拙的<code>arguments</code>对象更为友好。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">log</span><span class="p">(...</span><span class="nx">stuff</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// stuff is the rest parameter.</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">rendered</span> <span class="o">=</span> <span class="nx">stuff</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">renderStuff</span><span class="p">);</span> <span class="c1">// It&#39;s a real array.</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#log&quot;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">rendered</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>那时我们并没有对函数中传递任意数量的参数的匹配语法进行说明，它相比<code>fn.apply()</code>更为友好。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// log all the vlaues from an array</span>
</span><span class='line'><span class="nx">log</span><span class="p">(...</span><span class="nx">myArray</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>好的，它可以作用于任意的<a href="https://hacks.mozilla.org/2015/04/es6-in-depth-iterators-and-the-for-of-loop/">迭代对象</a>，所以你可以通过<code>log(...mySet)</code>来记录所有的事情。</p>

<p>并不像剩余参数，它可以在一个参数列表中使用多个展开操作符：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// kicks are before trids</span>
</span><span class='line'><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Kicks:&quot;</span><span class="p">,</span> <span class="p">...</span><span class="nx">kicks</span><span class="p">,</span> <span class="s2">&quot;Trids:&quot;</span><span class="p">,</span> <span class="p">...</span><span class="nx">trids</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>展开操作符可以二维数组压平为一维数组：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">smallArrays</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[],</span> <span class="p">[</span><span class="s2">&quot;one&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;twos&quot;</span><span class="p">]];</span>
</span><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">onBigArray</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">smallArrays</span><span class="p">);</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">oneBigArray</span>
</span><span class='line'>    <span class="p">[</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;twos&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>但也许只有我有这一个迫切的需求，如果是这样，我真要责骂Haskell了。</p>

<ul>
<li><strong>构建数组时的展开操作符</strong> 同样回到五月，我们谈到解构中的&#8221;rest“剩余模式。这是一个可以将一数组中的任意数量值取出来的方式。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="p">[</span><span class="nx">head</span><span class="p">,</span> <span class="p">...</span><span class="nx">tail</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">head</span>
</span><span class='line'>    <span class="mi">1</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">tail</span>
</span><span class='line'>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>猜测一下下面代码。这匹配的语法会将任意数量的元素整合为一个数组：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&gt;</span> <span class="kd">var</span> <span class="nx">reunited</span> <span class="o">=</span> <span class="p">[</span><span class="nx">head</span><span class="p">,</span> <span class="p">...</span><span class="nx">tail</span><span class="p">];</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nx">reunited</span>
</span><span class='line'>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>同样的，你可以在函数调用中拥有相同的规则：你可以在同一数组中使用多次展开操作符，等等。</p>

<ul>
<li><strong>适时的尾部调用</strong>  如果让我在这里解释这个，对我来说还是难的。</li>
</ul>


<p>为了更好地理解这一特性，没有比这<a href="https://mitpress.mit.edu/sicp/full-text/book/book-Z-H-9.html#%_chap_1">计算机编程的结构和解析</a>更合适开始学习的了。如果你感兴趣，你可以坚持读它。尾部调用会在 <a href="https://mitpress.mit.edu/sicp/full-text/book/book-Z-H-11.html#%_sec_1.2.1">1.2.1部分 线性递归与迭代</a>中有解释。ES6标准化中要求的实现是线性递归的方式，也就是那文章提到的。</p>

<p>没有任一主流的浏览器实现这一特性，这很难实现，但是所有的事情都在往好的方向发展。</p>

<h4>文本(Text)</h4>

<ul>
<li><strong>Unicode 版本升级</strong> ES5要求实现至少支持Unicode的3.0版本字符。ES6则要求至少是Unicode 5.1.0。你可以在函数名称上使用<a href="https://en.wikipedia.org/wiki/Linear_B">Linear B</a>。</li>
</ul>


<p>[Linear A]使用上还有点问题，因为它在Unicode7.0版本之前没有支持，也因为很难管理没有破译的语言进而的代码编写。</p>

<p>(尽管JS引擎支持在Unicode6.1版本中的emoji，但你还是不能使用这些表情作为变量的名称。出于某种原因，Unicode联盟不支持使用它们作为身份标识字符。)</p>

<ul>
<li><strong>长的Unicode转义序列</strong> 如早期版本一样，ES6支持4个数值的Unicode转义序列。它们看着如<code>\u212A</code>。它们很好用，你可以在字符串中使用它们。或者，如果你想耍幽默同时你无论什么时候也不同进行代码检查，你可以使用它们作为变量的名称。但是，对于一个字符如<code>U+1a3021</code>，一个用头倒立的人的埃及象形文字，明显是有问题的。<code>13021</code>有五个数值，已经超过了四个。</li>
</ul>


<p>在ES5中，你不得不编写两个转义符号，因为UTF-16的代理对(surrogate pair)。这实际上就感觉生活在暗黑时代：寒冷、悲惨、野蛮的。ES6就像是意大利的文化复兴，带来了巨大的变化：你现在可以编写<code>\u{13021}</code>。</p>

<ul>
<li><strong>对BMP字符有更好支持</strong> <code>.toUpperCase()</code>和<code>.toLowerCase()</code>方法现在可以用于犹太字符中了。</li>
</ul>


<p>同样的，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCodePoint"><code>String.fromCodePoint(...codePoints)</code></a>函数与老式的<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCharCode"><code>String.fromCharCode(...codeUnits)</code></a>差不多，只是前者会支持BMP的点编码。</p>

<ul>
<li><strong>Unicode 正则</strong> ES6的正则表达式支持新的标签，<code>u</code>标签，因为除在BMP中正则表达式认为会将其认为是个单独的字符，而不是两个分离的编码单元。例如，没有<code>u</code>时，<code>/./</code>只会匹配半个字符“ ”，但<code>/./u</code>会匹配整个。</li>
</ul>


<p>在正则在增加<code>u</code>的标签，还可以处理unicode的非大小写和长类型的unicode转义序列。至于完整的说明，可参考<a href="https://mathiasbynens.be/notes/es6-unicode-regex">Mathias Bynens 非常详尽的文章</a></p>

<ul>
<li><p><strong>Sticky正则</strong> 对于非unicode的可以使用<code>y</code>标签，详情在<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/sticky">此可查看</a>。sticky正则表达式只会从由<code>.lastIndex</code>指定的偏移位开始查找，如果不要指定的位置找到，不会一直向下找，而是直接返回<code>null</code>。</p></li>
<li><p><strong>官方的国际化指引</strong> ES6实现了对国际化的支持，<a href="http://www.ecma-international.org/publications/standards/Ecma-402.htm">ECMA-402 the ECMAScript 2015 国际化说明</a>，这额外的标准中指定了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl"><code>Intl</code>对象</a>。Firefox，chorme 和 IE 11+ 已经支持它了，Node 0.12 也支持。</p></li>
</ul>


<h4>数值(Numbers)</h4>

<ul>
<li><strong>二进制和八进制</strong> 如果你觉得数字 8,675,309 和 <code>0x845fed</code>并不适合你，而想要一种更为特殊的方式表达，你现在可以编写<code>0o41057755</code>（八进制）或者 <code>0b100001000101111111101101</code>（二进制）。</li>
</ul>


<p><code>Number(str)</code>现在也可以识别这格式<code>Number("0b101010")</code>字符串，会返回42。</p>

<p>（快速提醒：<code>number.toString(base)</code>和<code>parseInt(stsring, base)</code>还是可以如原来一样转化数字，无论是转出还是转入，转换的过程中会根据base。）</p>

<ul>
<li><strong>新<code>Number</code>函数和常量</strong> 这是非常好的地方。如果你对此感兴趣，你可以自己查看标准文档，可以从<a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-number.epsilon"><code>Number.EPSILON</code></a>开始。</li>
</ul>


<p>也许，这最有意思的新想法是“安全的整型”，它可以从<code>-(2**25-1)</code>到<code>+(2**53-1)</code>，包含边界值 。JS中的数值存在着范围。这一个在此范围中的整型都可以用JS数字表示，进而可以查看其临近的数字。简单来说，在这范围中操作<code>++</code>和<code>--</code>得到的效果是期望所得的。超出这范围时，奇数是不能表示的，就如64位浮点的数字，同样这些数字的增加和减少也不能得到正确的结果（偶数也一样）。为了解决你代码中的这些问题，标准委员会提供了常量<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MIN_SAFE_INTEGER"><code>Number.MIN_SAFE_INTEGER</code></a>和<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER"><code>Number.MAX_SAFE_INTEGER</code></a>，和一个判断方法<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isSafeInteger"><code>Number.isSafeInteger(n)</code></a>。</p>

<ul>
<li><strong>新的<code>Math</code>函数</strong>  ES6增加了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/asinh">曲线三角函数</a> 和 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/atanh">它们的相反值</a>，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/cbrt"><code>Math.cbrt(x)</code></a> 会计算立方，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/hypot"><code>Math.hypot(x,y)</code></a> 会计算直角三角形的斜边长，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/log2"><code>Math.log2(x)</code></a> 和 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/log10"><code>Math.log10(x)</code></a> 会计算常见的对数值，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/clz32"><code>Math.clz32(x)</code></a>可帮忙求对数（其基本等于<code>32-log2(x)</code>，还有些其它的。</li>
</ul>


<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/sign"><code>Math.sign(x)</code></a> 可获取数字的符号（1,0,-1对应于正零负）。</p>

<p>ES6还添加了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/imul"><code>Math.imul(x, y)</code></a>，它就是32位的带符号乘法。这是十分奇怪的需求，除非你实际工作中没有64位的整型或者大数值的整型。如果是这样，这还是挺方便的， 这有助于编译器，Emscripten 可以利用此函数在JS中计算64位的乘法。</p>

<p>类似的，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/fround"><code>Math.fround(x)</code></a>可助于编译器对32位浮点数值的支持。</p>

<h4>结束语</h4>

<p>这就是所有特性了？</p>

<p>不。我还没有提到在所有内置迭代器中的对象通用原型，还有生成器函数的构造函数，<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is(v1, v2)</code></a>。<code>Symbol.species</code>可以帮助进行子类内置操作，如数组和Promise。ES6 还有许多没有标准化的目标正在进行中。</p>

<p>我可以确认的是我肯定遗失些事情没有提到。</p>

<p>但是，如果你一直都跟着下来，你会对整体有个很好的印象。你可以知道今天你可以能用上的特性，如果你还这么做了，那么你正迈向更好的语言。</p>

<p>几天前，Josh Mock 提醒我说，他只只用的50行代码就说完了八个不同的ES6特性，但没有深入的想法。<a href="https://gist.github.com/JoshMock/98f187c7a8bf745e4cf6">文章</a>包含有模块、类、默认参数、Set、Map、模板字符串、前头函数、和let。（他忘记了for-of循环）</p>

<p>这也就是我的经验所得到的。文章对于新的特性在一块处理得很好，它们会真正影响到你日常编写的每一行代码。</p>

<p>同时，每个JS引擎都在积极跟进和优化这些我们之前几个月一直在讨论的特性。</p>

<p>只要我们的工作完成了，这语言也就完善好了。我们将不会不得不再次调整代码了，而我将不得不找其它工作了。</p>

<p>只是开个玩笑。ES7的提案已经提交了。这里可以暴露一点：</p>

<ul>
<li><p><strong>幂操作符</strong> <code>2**8</code>将会返回 256，这会是Firefox中的日版本中更新。</p></li>
<li><p><strong>Array.prototype.includes(value)</strong> 如果这数组包含有指定的值时，会返回true。此会通过polyfill的方式在Firefox的日版本中。</p></li>
<li><p><strong>SIMD</strong>  将128位的SIMD指令集提供给先进的CPU。这些指令集会对相邻的数组元素进行算术计算，可以动态地提升大范围的各种算术，对于流媒体音频、视频、密码、游戏、图片处理等都是相当有用的。更加底层的操作，更为强大。此会通过polyfill的方式在Firefox的日版本中。</p></li>
<li><p><strong>异步函数</strong> 我们在之前的生成器的文章中隐藏这一特性。异步函数类似于生成器，但区别时同步编程。当你调用一个生成器时，它会返回一个迭代器。当你调用一个异步函数时，它会返回一个promise。生成器可以使用yield的关键字来暂停和产出一个值；同步函数则会使用<code>await</code>关键字来暂停和等待一个promise。</p></li>
</ul>


<p>这是很难用几句话来说完的。但异步函数会在ES7中有重大的调整和意义。</p>

<ul>
<li><strong>类型化对象</strong>  这就是之前的类型数组。类型数组的元素拥有其类型，一个类型的对象是一个其属性被类型化后的对象。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Create a new struct type. Every Point has two fields</span>
</span><span class='line'><span class="c1">// named x and y.</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">Point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TypedObject</span><span class="p">.</span><span class="nx">StructType</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">x</span><span class="o">:</span> <span class="nx">TypedObject</span><span class="p">.</span><span class="nx">int32</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">y</span><span class="o">:</span> <span class="nx">TypedObject</span><span class="p">.</span><span class="nx">int32</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Now create an instance of that type.</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">({</span><span class="nx">x</span><span class="o">:</span> <span class="mi">800</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">600</span><span class="p">});</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span> <span class="c1">// 800</span>
</span></code></pre></td></tr></table></div></figure>


<p>你为了性能的原因会编写此代码。类似类型数组，类型对象会增加些编程的优势（减少内存的使用和提升速度），但是其每个对象、每个输入选项，相对于之前语言所有事情都会被静态地类型化，也就是被类型会之后，其值必须是那个类型。</p>

<p>这是作为JS的综合目标，并会在Firefox的日版本中实现。</p>

<ul>
<li><strong>类和原型装饰器</strong>  装饰器就是一个属性、类、方法中的标签。通过一个例子来说明其是什么样子的：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">debug</span> <span class="nx">from</span> <span class="s2">&quot;jsdebug&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kr">class</span> <span class="nx">Person</span> <span class="p">{</span>
</span><span class='line'>  <span class="err">@</span><span class="nx">debug</span><span class="p">.</span><span class="nx">logWhenCalled</span>
</span><span class='line'>  <span class="nx">hasRoundHead</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">head</span> <span class="k">instanceof</span> <span class="nx">Spheroid</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>@debug.logWhenCalled</code>就是所谓的装饰器，你可以想象这方法是做什么的。</p>

<p><a href="https://github.com/wycats/javascript-decorators/blob/master/README.md">这里的提案</a>有解释其详细工作的过程，同时还包含许多的例子。</p>

<p>还有一个令人兴奋的特性我不得不提到，但它还在开发阶段并且不是语言的特性。</p>

<p>TC39, 这个ECMAScript的标准委员会，将会更为频繁地发布版本和有更多的公开进度。在ES5和ES6之间已经有六年。委员会对ES7的目标是在ES6的12个月之后，随后的标准版本会以12个月的节奏进行发布。上面提到的部分特性已经准时完成了，它们会跟上这火车并成为ES7的一部分的。那些还没有完成的，会在下列火车的时间表中。</p>

<p>很高兴分享了很多的ES6的好的新特性，同时也很高兴能够花时间来讨论这些特性，可能以后再也没有这时间了。</p>

<p>很高兴参与深入ES6的文章，我希望你们能喜欢它。保持联系。; )</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h1 class="title" itemprop="name"><a href="/blog/2016/03/20/es6-in-depth-modules/" itemprop="url">ES6 in Depth: Modules</a></h1>
	<div class="meta">
		<div class="tags">


	<a class='category' href='/blog/categories/es6/'>es6</a>, <a class='category' href='/blog/categories/module/'>module</a>, <a class='category' href='/blog/categories/shen-ru-es6/'>深入es6</a>


</div>
		<div class="date">







  


<time datetime="2016-03-20T00:00:00+08:00" data-updated="true" itemprop="datePublished">2016-03-20</time></div>

		
			<span class="comments"><a href="/blog/2016/03/20/es6-in-depth-modules/#disqus_thread">Comments</a></span>
		
	</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote><p><a href="https://hacks.mozilla.org/2015/08/es6-in-depth-modules/">ES6 In Depth: Modules</a></p></blockquote>

<p>当我在2007年加入到Mozilla的JS团队时，有一笑话是经典的JS程序只有一行代码。</p>

<p>那时已经是Google Map开始的两年之后了。在此之前，最为卓越的JS代码就是表单的验证，那么你在<code>&lt;input onchange=&gt;</code>上的平均处理代码也就是一行，对的，已经足够了。</p>

<p>事情已经发生了变化。JS项目已经成长为令人惊奇的量级，同时社区中也开发了一些工具来适应规模的变化。其中一个最为基本的事情是你需要模块系统，它可以将你的工作分离到多个文件和目录中，但是它依然保证在必要时能访问其他部分，同时使得加载所有代码更为有效。所以实际上，JS已经有了模块系统，并且有几种。同时，还有些包管理工具来安装软件和复制其高层的依赖。你可能会想到ES6，它为JS带来了新的模块系统，确实有点晚了些。</p>

<p>好的，今天我们就开始来看ES6为这已经存在的系统增加了些什么功能，同时看一下可以使用它来做些什么标准和工具吧。但是首先，让我们开始查看ES6模块长什么样子吧。</p>

<h4>模块基础</h4>

<p>ES6的模块是一个包含有JS代码的模块。它没有<code>module</code>的关键字，一个模块几乎可以看成为一个脚本。这里有两个区别：</p>

<ul>
<li>ES6模块会自动启用 严格模式，即使你没有在代码中使用&#8221;use strict&#8221;</li>
<li>你可以在模块中使用<code>import</code>和<code>export</code></li>
</ul>


<p>让我们先来说一下<code>export</code>。在模块中的任何声明，默认都只会作用于此模块。如果你想在模块中的声明公开出去，也就是其它模块能使用它，你必须<em>暴露</em>这个特性(变量、函数等）。有些方式可以做到这点，最为简单的方式就是添加一个<code>export</code>的关键字。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// kittydar.js - Find the locations of all the cats in an image.</span>
</span><span class='line'><span class="c1">//(Heather Arthur wrote this library for real)</span>
</span><span class='line'><span class="c1">// (but she didn&#39;t use modules, because it was 2013)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="kd">function</span> <span class="nx">delectCats</span><span class="p">(</span><span class="nx">cavas</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">kittydar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Kittydar</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">kittydar</span><span class="p">.</span><span class="nx">detectCats</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="nx">clas</span> <span class="nx">Kittydar</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span> <span class="nx">several</span> <span class="nx">methods</span> <span class="nx">doing</span> <span class="nx">image</span> <span class="nx">processing</span> <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// This helper function isn&#39;t exported.</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">resizeCanvas</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>你可以<code>export</code>任何顶级的<code>function</code>、<code>class</code>、<code>var</code>、<code>let</code>、<code>const</code>。</p>

<p>这也就是你需要知道有关模块的所有信息。你并不需要使用IIFE或者一个回调函数。你只要正常地声明你所需要的任何事情。因此，这代码就是模块，不是脚本，所有的声明的作用域都会在此模块中，并不会在全局所有的脚本和模块是可见的。将这些声明暴露出去，会使这成为此模块对外的公开API，这就是你想要的。</p>

<p>与暴露代码不同，在模块中的代码仅仅只是普通的代码。你可以使用全局字面量，如<code>Object</code>和<code>Array</code>。如果你模块运行于浏览器中，你可以使用<code>document</code>和<code>XMLHttpRequest</code>。</p>

<p>在一个分离的文件中，我们可能导入并使用<code>detectCats()</code>函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// domo.js - Kittydar demo program</span>
</span><span class='line'>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">detectCats</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;kittydar.js&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">go</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;catpix&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">cats</span> <span class="o">=</span> <span class="nx">detectCats</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">drawRectangles</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">cats</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了从一个模块中导入多个名称，你可以编写:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">detectCats</span><span class="p">,</span> <span class="nx">Kittydar</span><span class="p">)</span> <span class="nx">from</span> <span class="s2">&quot;kittydar.js&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>当你运行一个含有<code>import</code>声明的模块时，需要导入的模块会先被加载，每个模块的代码体会根据整个依赖图进行深度遍历执行，并跳过已经执行的模块来避免循环加载。</p>

<p>这就是模块的基础内容了，这确实是十分简单的，;-)</p>

<h4>导出列表</h4>

<p>相比于在每个特性中进行导出的标记，你可以编写一个简单的列表来指出你想导出的所有名称，并放到大括号中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="p">{</span><span class="nx">detectCats</span><span class="p">,</span> <span class="nx">Kittydar</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// no export keyword required here</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">detectCats</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="kr">class</span> <span class="nx">Kittydar</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>export</code>的列表并不一定需要在文件的第一行，它可以出现在模块的顶级的任意地方。你可以拥有多个<code>export</code>列表，或者与其它的<code>export</code>混合起来用，只要保证导出的名称不超过一次就好。</p>

<h4>对导入导出重命名</h4>

<p>有时，一个导入的名称可能会与其它你同样需要使用的名称是一样的，所以ES6允许你对导入的名称进行重命名：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// suburbia.js</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Both these modules export something named `flip`.</span>
</span><span class='line'><span class="c1">// To import them both, we must rename at least one.</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">flip</span> <span class="nx">as</span> <span class="nx">flipOmelet</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;eggs.js&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">flip</span> <span class="nx">as</span> <span class="nx">flipHouse</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;real-estate.js&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>类似的，你可以对导出的名称进行重命名。有时可能会出现，你希望以不同的名称导出相同的值，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// unlicensed_nuclear_accelerator.js - media streaming without drm</span>
</span><span class='line'><span class="c1">// (not a real library, but maybe it should be)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">v1</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">v2</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">v1</span> <span class="nx">as</span> <span class="nx">streamV1</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">v2</span> <span class="nx">as</span> <span class="nx">streamV2</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">v2</span> <span class="nx">as</span> <span class="nx">streamLatestVersion</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h4>默认导出</h4>

<p>设计的新标准是能与已经存在的CommonJS和AMD模块能正常溶合，所以当你一个Node项目，并且完成命令<code>npm install lodash</code>。你的ES6代码可以从<code>lodash</code>导入单独的函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">each</span><span class="p">,</span> <span class="nx">map</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;lodash&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">each</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="nx">x</span><span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是，你可能已经习惯看到<code>_.each</code>而不是<code>each</code>，并且你希望编写代码依然保持这方式。或者自从有 <a href="https://lodash.com/docs#_">这个</a>，你还想使用<code>_</code>作为一个函数。</p>

<p>为了做到这点，你可以稍微地调整为不同的语法：导入模块时不使用大括号：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">_</span> <span class="nx">from</span> <span class="s2">&quot;lodash&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这其实就是等价于<code>import {default as _} from "lodash"</code>。所有的CommonJS和AMD模块都会为ES6提供一个<code>default</code>的导出名称，这其实就类似于你<code>require()</code>这模块，也就是<code>exports</code>对象。</p>

<p>ES6模块被设计为可以让你导出多个事物，但在已经存在的CommonJS模块中，默认的导出是包含所有事物。例如，有名的<a href="https://github.com/Marak/colors.js">colors</a>包在我说之前并没有任何对ES6的支持。它就是一个CommonJS的集合，就像很多在npm的包一样。但是，你可以明确地告诉ES6代码需要导入的内容。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// ES6 equivalent of `var colors = require(&quot;colors/safte&quot;);`</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">colors</span> <span class="nx">from</span> <span class="s2">&quot;colors/safe&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你希望你的ES6模块有个默认的导出，那很容易。这并没有什么魔法性的操作，它就像其它的导出操作，只是将其命名为<code>"default"</code>。你可以使用我们之前提到的重命名的语法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">myObject</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">field1</span><span class="o">:</span> <span class="nx">value1</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">field2</span><span class="o">:</span> <span class="nx">value2</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span><span class="nx">myObject</span> <span class="nx">as</span> <span class="k">default</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者使用缩写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">field1</span><span class="o">:</span> <span class="nx">value1</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">field2</span><span class="o">:</span> <span class="nx">value2</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关键字<code>export default</code>后面可以接任意的值：一个函数，一个类，一个你命名的对象字面量。</p>

<h4>模块对象</h4>

<p>十分抱歉，这部分内容有些长。但是，这并不仅仅是JS特有的。因为某些原因，所有语言中的模块系统都试图做到足够的小、方便。幸运，还剩一个特性。好吧，是两个。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">cows</span> <span class="nx">from</span> <span class="s2">&quot;cows&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>当你使用<code>import *</code>时，它导入的是一个模块命名对象。它的属性是这一模块的所有导出。所以，如果&#8221;cow&#8221;模块导出有一个名为<code>moo()</code>的函数，那么在此行代码导入&#8221;cows&#8221;之后，你可以使用<code>cows.moo()</code>。</p>

<h4>聚合模块</h4>

<p>有时，主模块可能会将其它模块的包导入进来，同时会将它们又以非统一的方式导出。为了简化这一类的代码，下面有个聚合的从导入到导出的缩写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// world-foods.js - good stuff from all over</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// import &quot;sri-lanka&quot; and re-export some of its exports</span>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span><span class="nx">Tea</span><span class="p">,</span> <span class="nx">Cinnamon</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;sri-lanka&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// import &quot;equatorial-guinea&quot; and re-export some of its exports</span>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span><span class="nx">Coffee</span><span class="p">,</span> <span class="nx">Cocoa</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;equatorial-guinea&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// import &quot;singapore&quot; and export ALL of its exports</span>
</span><span class='line'><span class="kr">export</span> <span class="o">*</span> <span class="nx">from</span> <span class="s2">&quot;singapore&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>每个这些<code>export-from</code>的表达式都类似于<code>import-from</code>，只是调整为<code>export</code>。并不像导入一样，这并不会重新添加导出的绑定到主模块的作用域中。所以，如果你想在<code>world-foods.js</code>中编写代码使用<code>Tea</code>，就不要使用这一缩写。你会发现找不到这字面量。</p>

<p>如果在导出&#8221;singapore&#8221;时会与其它的导出有冲突，会产生一个错误，所以请小心使用<code>export *</code>。</p>

<p>好了，我们介绍完语法了。让我们开始些有趣的事情。</p>

<h4><code>import</code>实际上做了什么</h4>

<p>你会相信 它没什么吗？</p>

<p>好吧，你不是那么好欺骗的。好的，你会相信标准委员会几乎没有对<code>import</code>进行说明？这是好事吗？</p>

<p>ES6的模块加载的整个详情可以移步到 <a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-hostresolveimportedmodule">其实现</a>，它的实现详情可移步于 <a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-toplevelmoduleevaluationjob">详细说明</a>。</p>

<p>粗略来讲，当你告诉JS引擎在运行一个模块时，它不得不进行如下四个步骤：</p>

<ul>
<li>1、解析：读取模块资源的实现代码并检查语法错误</li>
<li>2、加载：递归地加载所有需要导入的模块，这一部分还没有标准化。</li>
<li>3、链接：对于每个加载完成的模块，会为其创建一个作用域，并将此模块声明绑定到此作用域中，包括从其它模块导入过来的事物。</li>
</ul>


<p>这就是<code>import {cake} from "paleo"</code>的部分。但是，如果&#8221;paleo&#8221;模块并没有导出任何名为&#8221;cake&#8221;的字面量，你将会得到一个错误。这是很坏的体验，因为你已经实际上运行了一些JS代码了。</p>

<ul>
<li>4、运行：最后，开始运行每个新加载的模块体。这时候，<code>import</code>的处理进程已经完成了，所以当代码执行到含有<code>import</code>声明的代码行时，没有什么会发生。</li>
</ul>


<p>看？我之前就告诉你答案是“没什么”。我对编程语言并不会撒谎。</p>

<p>但是，现在我们开始接触这模块系统的有趣部分了，这是个感觉好玩的点。因为模块系统并没有指定怎么加载模块，你可以在开始时候，找出在资源代码中所有的<code>import</code>声明。ES6的其中一个实现方式，是将所有的工作都放到编译阶段，并将所有的模块捆绑放入一个文件中，才发送给网络上。webpack这工具实际上就是这么做的。</p>

<p>这是个大的话题，因为加载脚本会花费网络的时间。当你每次获取时，你会查找其<code>import</code>的声明，时间就会成倍增长了。比较天真的加载方式是会发送多个网络请求，但通过webpack，这不仅仅是今天使用ES6模块，你会自动得到所有软件工程所要到达的运行时优点。</p>

<p>ES6模块加载的详情还是与原始计划的一样，并构建起来的。其中一个原因就是因为没有统一怎么实现此特性，所以它并不是最后的标准。我希望某人能够指出来，因为就如我们看到的，模块的加载确实需要标准化，而且打包非常有用，是不能放弃的。</p>

<h4>静态 vs 动态，或者：规则或打破规则</h4>

<p>作为动态语言，JS已经拥有其令人惊奇的静态模块系统。</p>

<ul>
<li><p>所有的<code>import</code>和<code>export</code>都只允许在模块的顶级声明，导入导出没有额外的限制条件，但你不能在函数作用域中使用。</p></li>
<li><p>所有的导出定义必须是在资源代码中存在有明确的名称。你不能通过编程来循环一个数组并导出一堆的名称。</p></li>
<li><p>模块对象是冻结的。不能通过hack的方式来操作模块对象，polyfill方式的也不行。</p></li>
<li><p>在任一模块代码运行之前，所有模块依赖必须加载完成、解析和关联上。按照要求，不允许<code>import</code>导入模块懒加载的。</p></li>
<li><p>对于<code>import</code>的错误没有任何的恢复机制。一个App可能会有上百的模块，如果有任何的加载或者关联失败，所有代码将不会运行。你不能在<code>try/catch</code>中使用<code>import</code>。（这里有个优点，因为这模块系统是静态的，所以webpack可以在编译阶段检查出可能存在的错误。）</p></li>
<li><p>在没有加载完依赖之前，不允许运行模块中的任何代码。这意味着如果依赖没有加载完成时，模块本身不知道怎么控制代码的运行。</p></li>
</ul>


<p>如果你需求是静态的话，这模块系统是十分好的。但是，有时你可能需要些hack，是不是？</p>

<p>这就是为什么你需要编程API来处理与ES6的<code>import/export</code>语法相违背的模块系统加载机制。例如，<a href="http://webpack.github.io/docs/code-splitting.html">webpack includes an API</a> 你可以使用“code splitting&#8221;，按需求对某些模块进行懒加载。这个API可以让你打破上面所提到的多数规则。</p>

<p>ES6的模块语法是十分静态的(晕，什么叫十分静态），同时它也是好的，因为这样可以缩短其编译工具的时间。但是，通过编程后的加载API，这静态的语法已经可以动态操作了。</p>

<h4>什么时候可以使用这ES6的模块？</h4>

<p>现在为了使用模块，你需要一个编译器，如 Traceur 或者 Babel。早些时候，Gaston I. Silva 有一<a href="http://shatle.github.io/blog/2015/12/16/es6-in-depth-using-es6-today-with-babel-and-broccoli/">文章</a> 来说明怎么为Web编译ES6代码。在这一文章中，Gaston 已经有一个例子是有关ES6模块的。这有个Axel Rauschmayer 编写的<a href="http://www.2ality.com/2015/04/webpack-es6.html">例子</a>，它使用Bable和webpack。</p>

<p>模块系统主要由 Dave Herman 和 Sam Tobin-Hochstadt 设计，他们为此模块系统的静态化辩护，同时为此长年与包括我在内的很多人抗争着。Jon Coppeard 实现了 Firefox 中的模块。另外的<a href="https://github.com/whatwg/loader">JS 加载器标准化</a>也正在进行中，人们所希望的在HTML中添加<code>&lt;script type=module&gt;</code>的特性也会随之而来。</p>

<p>这就是ES6。</p>

<p>这些实在是太有意思了，以致我并不想结束。也许，我们只是完成了部分的故事情节。我们可以讨论些ES6说明中零碎的特性，但它们又不能足够单独写成文章。也许，将来会对这些进行讨论。请在下周加入我们，一起对深入ES6进行个完美的总结吧。</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="page2" class="next">下一页</a>
    
    <div class="center"><a href="/blog/archives">Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2020

    liu.shatle &hearts; gmail.com


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'shatleblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










</body>
</html>
